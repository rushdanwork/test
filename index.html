<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayrollPro HR System</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --danger-color: #e74c3c;
            --warning-color: #f8961e;
            --info-color: #4895ef;
            --edit-color: #7209b7;
            --leave-color: #3a86ff;
            --halfday-color: #ffbe0b;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: #ffffff;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Login Page Styles */
        .login-container {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        
        .login-box {
            background-color: #2ecc71;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 400px;
            max-width: 90%;
            transition: all 0.3s ease;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-size: 24px;
            position: relative;
        }
        
        .login-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            width: 100%;
            max-width: 300px;
            text-align: left;
            color: white;
        }
        
        .form-group input {
            width: 100%;
            max-width: 300px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            border-color: #27ae60;
            outline: none;
        }
        
        .form-group button {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            background-color: #27ae60;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .form-group button:hover {
            background-color: #219653;
        }
        
        .toggle-form {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            width: 100%;
            color: white;
        }
        
        .toggle-form a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .toggle-form a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
            width: 100%;
            max-width: 300px;
            text-align: left;
        }

        .connection-panel {
            margin-top: 25px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
        }

        .firebase-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(0, 0, 0, 0.15);
            transition: var(--transition);
        }

        .firebase-status .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #f1c40f;
            flex-shrink: 0;
        }

        .firebase-status.checking .status-dot {
            background-color: #f1c40f;
        }

        .firebase-status.success .status-dot {
            background-color: #2ecc71;
        }

        .firebase-status.error .status-dot {
            background-color: #e74c3c;
        }

        .firebase-status.warning .status-dot {
            background-color: #f39c12;
        }

        .firebase-status-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .firebase-status-message {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .connection-retry-btn {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px;
            background: transparent;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .connection-retry-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .connection-hint {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 8px;
            text-align: center;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, var(--dark-color) 0%, #343a40 100%);
            color: white;
            padding: 25px 0;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }
        
        .sidebar-header {
            padding: 0 25px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h2 {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .sidebar-header h2 i {
            margin-right: 12px;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 14px 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            margin: 5px 0;
            position: relative;
            font-weight: 500;
            color: white;
            text-decoration: none;
        }
        
        .menu-item:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: var(--primary-color);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: white;
        }
        
        .menu-item i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            background-color: #f5f7ff;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            font-size: 2rem;
            color: var(--dark-color);
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .header h1 i {
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        
        .user-info:hover {
            transform: translateY(-2px);
        }
        
        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        
        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: none;
            border-radius: 8px;
            background: white;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            font-size: 0.95rem;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #dee2e6;
            color: #495057;
        }
        
        .btn-outline:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }
        
        .btn-success:hover {
            background-color: #3aa8d8;
            transform: translateY(-2px);
            color: white !important;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
            box-shadow: 0 4px 15px rgba(248, 150, 30, 0.3);
        }
        
        .btn-warning:hover {
            background-color: #e07e0c;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-edit {
            background-color: var(--edit-color);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(114, 9, 183, 0.3);
        }
        
        .btn-edit:hover {
            background-color: #5a0891;
            transform: translateY(-2px);
            color: white;
        }
        
        .btn-leave {
            background-color: var(--leave-color);
            color: white;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
        }
        
        .btn-leave:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        
        .btn-halfday {
            background-color: var(--halfday-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 190, 11, 0.3);
        }
        
        .btn-halfday:hover {
            background-color: #eab308;
            transform: translateY(-2px);
        }
        
        /* Data Table Styles */
        .data-table {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-top: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .table-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f3f5;
        }
        
        .table-title {
            font-size: 1.25rem;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
            width: max-content;
        }
        
        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f3f5;
            white-space: nowrap;
        }
        
        th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        tr:not(:last-child) {
            border-bottom: 1px solid #f1f3f5;
        }
        
        tr:hover {
            background-color: #f8fafd;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status.active {
            background-color: #e6fcf5;
            color: #12b886;
        }
        
        .status.inactive {
            background-color: #fff3bf;
            color: #f08c00;
        }
        
        .status-present {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .status-absent {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .status-late {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .status-leave {
            color: var(--leave-color);
            font-weight: bold;
        }
        
        .status-halfday {
            color: var(--halfday-color);
            font-weight: bold;
        }
        
        .late-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 5px;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }
        
        /* Employee Form Styles */
        .form-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            display: none;
        }
        
        .form-title {
            font-size: 1.25rem;
            margin-bottom: 20px;
            color: var(--dark-color);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .form-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid #f1f3f5;
            margin-top: 20px;
        }
        
        /* Alert/Notification Styles */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            background-color: white;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }
        
        .alert-info {
            background-color: #f8f9fa;
            border-left-color: var(--info-color);
        }
        
        /* Card Styles */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }
        
        .card-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f3f5;
        }
        
        .card-title {
            font-size: 1.25rem;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Layout Styles */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 0 15px;
        }
        
        .col-md-4 {
            flex: 0 0 33.33%;
            max-width: 33.33%;
            padding: 0 15px;
        }
        
        .col-md-12 {
            flex: 0 0 100%;
            max-width: 100%;
            padding: 0 15px;
        }
        
        /* Employee Info Container */
        .employee-info-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .employee-selection-card {
            flex: 1;
        }
        
        .employee-details-card {
            flex: 1.5;
        }
        
        /* Summary Card Styles */
        .summary-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            height: 100%;
        }
        
        .summary-title {
            font-size: 1rem;
            color: var(--dark-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #f1f3f5;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 15px 0;
        }
        
        .summary-details {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .summary-details li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #f1f3f5;
            font-size: 0.95rem;
        }
        
        .summary-details li:last-child {
            border-bottom: none;
        }
        
        .highlight {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        /* Attendance Summary Styles */
        .attendance-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        .summary-item {
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* Date Selector */
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Hide salary summary initially */
        #salarySummarySection {
            display: none;
        }
        
        /* Page Sections */
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        /* Employee Details Modal */
        #employee-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #employee-details-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .employee-info-container {
                flex-direction: column;
            }
            
            .col-md-6, .col-md-4 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .attendance-summary {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .summary-item {
                flex: 1 1 45%;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        /* Firebase Sync Styles - Minimal additions */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .sync-status.syncing {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .sync-status.synced {
            background-color: #d1edff;
            color: #0c5460;
        }
        
        .sync-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .sync-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        /* Enhanced Form Styles */
        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .form-section-title i {
            margin-right: 10px;
        }
        
        /* Tabs for Employee Details */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Enhanced Payroll Styles */
        .payroll-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .payroll-summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        
        .payroll-summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .payroll-summary-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Enhanced Attendance Styles */
        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .attendance-bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .attendance-status-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .status-filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Dashboard Styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.7;
        }
        
        /* Enhanced Table Styles */
        .table-actions {
            display: flex;
            gap: 5px;
        }
        
        .table-action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        
        .table-action-btn.view {
            background: var(--info-color);
            color: white;
        }
        
        .table-action-btn.edit {
            background: var(--warning-color);
            color: white;
        }
        
        .table-action-btn.delete {
            background: var(--danger-color);
            color: white;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Print Styles */
        @media print {
            .sidebar, .header, .action-bar, .btn {
                display: none !important;
            }
            
            .main-content {
                padding: 0;
                background: white;
            }
            
            .data-table {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDocs, 
            deleteDoc,
            updateDoc,
            query,
            where,
            getDoc,
            addDoc
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDytXwqVBTKJBBpTymDadTpmt8CR0LQSCM",
            authDomain: "wagewise-payroll-e6a84.firebaseapp.com",
            projectId: "wagewise-payroll-e6a84",
            storageBucket: "wagewise-payroll-e6a84.appspot.com",
            messagingSenderId: "1077952021877",
            appId: "1:1077952021877:web:6844674a44973506d2bf3c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const firebaseConnectionSnapshot = {
            status: 'checking',
            message: 'Checking Firebase connection...'
        };

        function applyFirebaseConnectionState() {
            const container = document.getElementById('firebase-connection-status');
            const messageEl = document.getElementById('firebase-connection-message');
            if (!container || !messageEl) return;

            ['checking', 'success', 'error', 'warning'].forEach(cls => container.classList.remove(cls));
            container.classList.add(firebaseConnectionSnapshot.status);
            messageEl.textContent = firebaseConnectionSnapshot.message;
        }

        function setFirebaseConnectionState(status, message) {
            firebaseConnectionSnapshot.status = status;
            firebaseConnectionSnapshot.message = message;
            applyFirebaseConnectionState();
        }

        async function verifyFirebaseConnection(showAlerts = false) {
            if (window.location.protocol === 'file:') {
                const message = 'Firebase SDK modules cannot load while using the file:// protocol. Please start a local web server (for example, `npx http-server`) and open http://localhost to continue.';
                setFirebaseConnectionState('warning', message);
                if (showAlerts) alert(message);
                return false;
            }

            if (!navigator.onLine) {
                const message = 'You appear to be offline. Connect to the internet to reach Firebase services.';
                setFirebaseConnectionState('error', message);
                if (showAlerts) alert(message);
                return false;
            }

            try {
                setFirebaseConnectionState('checking', 'Contacting Firebase services...');
                await getDocs(collection(db, 'employees'));
                setFirebaseConnectionState('success', 'Connected to Firebase. You can sign in now.');
                return true;
            } catch (error) {
                console.error('Firebase connectivity test failed:', error);
                const friendlyMessage = describeFirebaseConnectionIssue(error);
                setFirebaseConnectionState('error', friendlyMessage);
                if (showAlerts) {
                    alert(`Firebase connection failed. ${friendlyMessage}\n\n${error?.message || ''}`);
                }
                return false;
            }
        }

        function describeFirebaseConnectionIssue(error) {
            if (!navigator.onLine) {
                return 'You are offline. Connect to the internet and retry.';
            }

            if (error?.code === 'permission-denied') {
                return 'Firestore rejected the request. Check authentication and Firestore security rules.';
            }

            if (error?.code === 'unavailable') {
                return 'Firestore is temporarily unavailable or blocked by the network. Please retry in a moment.';
            }

            return 'Unable to reach Firebase. Double-check the Firebase configuration values and ensure Firestore is enabled.';
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyFirebaseConnectionState();
            const retryButton = document.getElementById('retry-firebase-connection');
            if (retryButton) {
                retryButton.addEventListener('click', () => verifyFirebaseConnection(true));
            }

            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showSignupButton = document.getElementById('show-signup');
            const showLoginButton = document.getElementById('show-login');

            const toggleForms = () => {
                if (loginForm && signupForm) {
                    loginForm.classList.toggle('hidden');
                    signupForm.classList.toggle('hidden');
                }
            };

            if (showSignupButton) {
                showSignupButton.addEventListener('click', toggleForms);
            }

            if (showLoginButton) {
                showLoginButton.addEventListener('click', toggleForms);
            }
        });

        window.addEventListener('online', () => {
            setFirebaseConnectionState('checking', 'Back online. Reconnecting to Firebase...');
            verifyFirebaseConnection();
        });

        window.addEventListener('offline', () => {
            setFirebaseConnectionState('error', 'You went offline. Firebase requires an active internet connection.');
        });

        verifyFirebaseConnection();
        window.verifyFirebaseConnection = verifyFirebaseConnection;

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firestoreFunctions = {
            collection, doc, setDoc, getDocs, deleteDoc, updateDoc, query, where, getDoc, addDoc
        };

        // Signup function
        window.signUp = async function() {
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
            const confirmPassword = document.getElementById("confirm-password").value;
            
            // Reset error messages
            document.getElementById('signup-email-error').style.display = 'none';
            document.getElementById('signup-password-error').style.display = 'none';
            document.getElementById('confirm-password-error').style.display = 'none';
            
            // Validation
            let isValid = true;
            
            if (!email) {
                document.getElementById('signup-email-error').textContent = 'Email is required';
                document.getElementById('signup-email-error').style.display = 'block';
                isValid = false;
            } else if (!/^\S+@\S+\.\S+$/.test(email)) {
                document.getElementById('signup-email-error').textContent = 'Email is invalid';
                document.getElementById('signup-email-error').style.display = 'block';
                isValid = false;
            }
            
            if (!password) {
                document.getElementById('signup-password-error').textContent = 'Password is required';
                document.getElementById('signup-password-error').style.display = 'block';
                isValid = false;
            } else if (password.length < 6) {
                document.getElementById('signup-password-error').textContent = 'Password must be at least 6 characters';
                document.getElementById('signup-password-error').style.display = 'block';
                isValid = false;
            }
            
            if (password !== confirmPassword) {
                document.getElementById('confirm-password-error').textContent = 'Passwords do not match';
                document.getElementById('confirm-password-error').style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert("Account created successfully!");
                // Switch to login form
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
                // Pre-fill email
                document.getElementById('login-email').value = email;
            } catch (error) {
                console.error("Signup error:", error);
                let errorMessage = "Failed to create account. ";
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += "Email already in use.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage += "Invalid email address.";
                        break;
                    case 'auth/weak-password':
                        errorMessage += "Password is too weak.";
                        break;
                    default:
                        errorMessage += error.message;
                }
                alert(errorMessage);
            }
        }

        // Login function
        window.login = async function() {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            
            // Reset error messages
            document.getElementById('login-email-error').style.display = 'none';
            document.getElementById('login-password-error').style.display = 'none';
            
            // Validation
            let isValid = true;
            
            if (!email) {
                document.getElementById('login-email-error').textContent = 'Email is required';
                document.getElementById('login-email-error').style.display = 'block';
                isValid = false;
            }
            
            if (!password) {
                document.getElementById('login-password-error').textContent = 'Password is required';
                document.getElementById('login-password-error').style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Login failed. ";
                switch(error.code) {
                    case 'auth/invalid-email':
                        errorMessage += "Invalid email address.";
                        break;
                    case 'auth/user-disabled':
                        errorMessage += "User account is disabled.";
                        break;
                    case 'auth/user-not-found':
                        errorMessage += "No account found with this email.";
                        break;
                    case 'auth/wrong-password':
                        errorMessage += "Incorrect password.";
                        break;
                    default:
                        errorMessage += error.message;
                }
                alert(errorMessage);
            }
        }

        // Logout function
        window.logout = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        // Auto login on page load (multi-device persistence)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User logged in:", user.email);
                document.getElementById('logged-in-user').textContent = user.email;
                // Hide login page and show application
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                // Initialize the application
                initializeApplication();
            } else {
                console.log("No user logged in.");
                // Show login page and hide application
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });
    </script>
</head>
<body>
    <!-- Login Page (Initially shown) -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <!-- Login Form -->
            <div id="login-form">
                <div class="login-title">Samkitec Resources</div>
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                    <div class="error-message" id="login-email-error"></div>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                    <div class="error-message" id="login-password-error"></div>
                </div>
                <div class="form-group">
                    <button onclick="login()">Login</button>
                </div>
                <div class="toggle-form">
                    Don't have an account? <a id="show-signup">Sign up</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <div class="login-title">Samkitec Resources</div>
                <h2>Sign Up</h2>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                    <div class="error-message" id="signup-email-error"></div>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password">
                    <div class="error-message" id="signup-password-error"></div>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" placeholder="Confirm your password">
                    <div class="error-message" id="confirm-password-error"></div>
                </div>
                <div class="form-group">
                    <button onclick="signUp()">Sign Up</button>
                </div>
                <div class="toggle-form">
                    Already have an account? <a id="show-login">Login</a>
                </div>
            </div>

            <div class="connection-panel">
                <div id="firebase-connection-status" class="firebase-status checking">
                    <div class="status-dot"></div>
                    <div>
                        <div class="firebase-status-title">Firebase Connection</div>
                        <div id="firebase-connection-message" class="firebase-status-message">
                            Checking Firebase connection...
                        </div>
                    </div>
                </div>
                <button id="retry-firebase-connection" type="button" class="connection-retry-btn">
                    <i class="fas fa-redo"></i> Retry Connection
                </button>
                <p class="connection-hint">
                    Tip: Serve this page using http://localhost instead of opening it directly from your files for the Firebase SDK to load correctly.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application (Initially hidden) -->
    <div id="app-container" class="container" style="display: none;">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-calculator"></i> PayrollPro</h2>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="menu-item" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="menu-item" onclick="showSection('employees')">
                    <i class="fas fa-users"></i> Employees
                </a>
                <a href="#" class="menu-item" onclick="showSection('payroll')">
                    <i class="fas fa-money-bill-wave"></i> Payroll
                </a>
                <a href="#" class="menu-item" onclick="showSection('attendance')">
                    <i class="fas fa-clipboard-check"></i> Attendance
                </a>
                <a href="#" class="menu-item" onclick="showSection('reports')">
                    <i class="fas fa-chart-bar"></i> Reports
                </a>
                <a href="#" class="menu-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="page-section active">
                <div class="header">
                    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>                   
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--primary-color);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="total-employees">0</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--success-color);">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-value" id="active-employees">0</div>
                        <div class="stat-label">Active Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--warning-color);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-value" id="today-present">0</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--info-color);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-value" id="monthly-payroll">0</div>
                        <div class="stat-label">Monthly Payroll</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Employees</h3>
                                <button class="btn btn-outline btn-sm" onclick="showSection('employees')">
                                    <i class="fas fa-eye"></i> View All
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="recent-employees-list">
                                    <!-- Recent employees will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Attendance Overview</h3>
                                <button class="btn btn-outline btn-sm" onclick="showSection('attendance')">
                                    <i class="fas fa-eye"></i> View All
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="attendance-overview">
                                    <!-- Attendance overview will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row" style="margin-top: 25px;">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Quick Actions</h3>
                            </div>
                            <div class="card-body">
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="showSection('employees'); document.getElementById('addEmployeeBtn').click();">
                                        <i class="fas fa-user-plus"></i> Add New Employee
                                    </button>
                                    <button class="btn btn-success" onclick="showSection('payroll')">
                                        <i class="fas fa-calculator"></i> Process Payroll
                                    </button>
                                    <button class="btn btn-info" onclick="showSection('attendance')">
                                        <i class="fas fa-clipboard-check"></i> Mark Attendance
                                    </button>
                                    <button class="btn btn-warning" onclick="generateReports()">
                                        <i class="fas fa-chart-bar"></i> Generate Reports
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Employees Section -->
            <div id="employees" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-users"></i> Employee Management</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button id="sync-employees-btn" class="btn btn-info sync-btn">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <div id="sync-employees-status" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>                   
                    </div>
                </div>
                
                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="employeeSearch" class="search-input" placeholder="Search employees...">
                    </div>
                    <div class="btn-group">
                        <button id="addEmployeeBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Employee
                        </button>
                        <button id="exportEmployeesBtn" class="btn btn-outline">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button id="importEmployeesBtn" class="btn btn-outline">
                            <i class="fas fa-upload"></i> Import
                        </button>
                    </div>
                </div>
                
                <!-- Employee Form -->
                <div id="employeeForm" class="form-container">
                    <div class="form-title">
                        <i class="fas fa-user-edit"></i> Employee Details
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" onclick="switchEmployeeTab('personal')">Personal Info</div>
                        <div class="tab" onclick="switchEmployeeTab('employment')">Employment</div>
                        <div class="tab" onclick="switchEmployeeTab('salary')">Salary & Bank</div>
                        <div class="tab" onclick="switchEmployeeTab('documents')">Documents</div>
                    </div>
                    
                    <form id="employeeDataForm">
                        <input type="hidden" id="employeeId">
                        
                        <!-- Personal Information Tab -->
                        <div id="personal-tab" class="tab-content active">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-id-card"></i> Basic Information
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empId">Employee ID *</label>
                                        <input type="text" id="empId" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empName">Full Name *</label>
                                        <input type="text" id="empName" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empGender">Gender</label>
                                        <select id="empGender" class="form-control">
                                            <option value="">Select Gender</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="empDOB">Date of Birth</label>
                                        <input type="date" id="empDOB" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-address-card"></i> Contact Information
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empEmail">Email *</label>
                                        <input type="email" id="empEmail" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empPhone">Phone *</label>
                                        <input type="tel" id="empPhone" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empAddress">Address</label>
                                        <textarea id="empAddress" class="form-control" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empCity">City</label>
                                        <input type="text" id="empCity" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="empState">State</label>
                                        <input type="text" id="empState" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="empPincode">Pincode</label>
                                        <input type="text" id="empPincode" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-user-shield"></i> Government IDs
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empAadhar">Aadhar Number</label>
                                        <input type="text" id="empAadhar" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="empPAN">PAN Number</label>
                                        <input type="text" id="empPAN" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Employment Information Tab -->
                        <div id="employment-tab" class="tab-content">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-briefcase"></i> Employment Details
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empDepartment">Department *</label>
                                        <select id="empDepartment" class="form-control" required>
                                            <option value="">Select Department</option>
                                            <option value="HR">HR</option>
                                            <option value="Finance">Finance</option>
                                            <option value="Operations">Operations</option>
                                            <option value="IT">IT</option>
                                            <option value="Sales">Sales</option>
                                            <option value="Marketing">Marketing</option>
                                            <option value="Production">Production</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="empPosition">Position *</label>
                                        <input type="text" id="empPosition" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empLocation">Location *</label>
                                        <input type="text" id="empLocation" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empManager">Reporting Manager</label>
                                        <input type="text" id="empManager" class="form-control">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empJoinDate">Join Date *</label>
                                        <input type="date" id="empJoinDate" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empStatus">Employment Status *</label>
                                        <select id="empStatus" class="form-control" required>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="probation">Probation</option>
                                            <option value="contract">Contract</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-graduation-cap"></i> Education & Skills
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empEducation">Highest Education</label>
                                        <select id="empEducation" class="form-control">
                                            <option value="">Select Education</option>
                                            <option value="highschool">High School</option>
                                            <option value="diploma">Diploma</option>
                                            <option value="bachelor">Bachelor's Degree</option>
                                            <option value="master">Master's Degree</option>
                                            <option value="phd">PhD</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="empSkills">Skills</label>
                                        <input type="text" id="empSkills" class="form-control" placeholder="Separate skills with commas">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empExperience">Total Experience (Years)</label>
                                        <input type="number" id="empExperience" class="form-control" min="0" step="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Salary & Bank Information Tab -->
                        <div id="salary-tab" class="tab-content">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-money-bill-wave"></i> Salary Information
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empSalary">Base Salary () *</label>
                                        <input type="number" id="empSalary" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empSalaryType">Salary Type</label>
                                        <select id="empSalaryType" class="form-control">
                                            <option value="monthly">Monthly</option>
                                            <option value="hourly">Hourly</option>
                                            <option value="daily">Daily</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empAllowances">Allowances ()</label>
                                        <input type="number" id="empAllowances" class="form-control" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="empDeductions">Deductions ()</label>
                                        <input type="number" id="empDeductions" class="form-control" value="0">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empTaxIdentification">Tax Identification Number</label>
                                        <input type="text" id="empTaxIdentification" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-university"></i> Bank Details
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empBankName">Bank Name *</label>
                                        <input type="text" id="empBankName" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empAccountNo">Account No. *</label>
                                        <input type="text" id="empAccountNo" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empIFSCCode">IFSC Code *</label>
                                        <input type="text" id="empIFSCCode" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="empBranch">Branch Name</label>
                                        <input type="text" id="empBranch" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-file-invoice-dollar"></i> Provident Fund
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empPFID">PF ID</label>
                                        <input type="text" id="empPFID" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="empPFUAN">PF UAN</label>
                                        <input type="text" id="empPFUAN" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Documents Tab -->
                        <div id="documents-tab" class="tab-content">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-file-upload"></i> Document Upload
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empResume">Resume</label>
                                        <input type="file" id="empResume" class="form-control" accept=".pdf,.doc,.docx">
                                    </div>
                                    <div class="form-group">
                                        <label for="empAadharDoc">Aadhar Card</label>
                                        <input type="file" id="empAadharDoc" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empPANDoc">PAN Card</label>
                                        <input type="file" id="empPANDoc" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                                    </div>
                                    <div class="form-group">
                                        <label for="empPhoto">Photograph</label>
                                        <input type="file" id="empPhoto" class="form-control" accept=".jpg,.jpeg,.png">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-file-contract"></i> Employment Documents
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empOfferLetter">Offer Letter</label>
                                        <input type="file" id="empOfferLetter" class="form-control" accept=".pdf,.doc,.docx">
                                    </div>
                                    <div class="form-group">
                                        <label for="empAppointmentLetter">Appointment Letter</label>
                                        <input type="file" id="empAppointmentLetter" class="form-control" accept=".pdf,.doc,.docx">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="empExperienceLetter">Experience Letter</label>
                                        <input type="file" id="empExperienceLetter" class="form-control" accept=".pdf,.doc,.docx">
                                    </div>
                                    <div class="form-group">
                                        <label for="empOtherDocs">Other Documents</label>
                                        <input type="file" id="empOtherDocs" class="form-control" multiple>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="cancelEmployeeBtn" class="btn btn-outline">Cancel</button>
                            <button type="submit" id="saveEmployeeBtn" class="btn btn-primary">Save Employee</button>
                        </div>
                    </form>
                </div>
                
                <!-- Employee Data Table -->
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">Employee Records</div>
                        <div class="table-actions">
                            <div class="btn-group">
                                <button class="btn btn-outline btn-sm" onclick="filterEmployeesByStatus('all')">
                                    <i class="fas fa-filter"></i> All
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="filterEmployeesByStatus('active')">
                                    <i class="fas fa-user-check"></i> Active
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="filterEmployeesByStatus('inactive')">
                                    <i class="fas fa-user-times"></i> Inactive
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="exportEmployeeData()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="refreshEmployeeData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Position</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Location</th>
                                    <th>Salary</th>
                                    <th>Status</th>
                                    <th>Join Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody">
                                <!-- Employee data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Payroll Section -->
            <div id="payroll" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-money-bill-wave"></i> Payroll Processing</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button id="sync-payroll-btn" class="btn btn-info sync-btn">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <div id="sync-payroll-status" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info" id="payrollAlert">
                    <!-- Content will be filled by JavaScript -->
                </div>

                <!-- Payroll Summary -->
                <div class="payroll-summary-grid">
                    <div class="payroll-summary-card">
                        <div class="payroll-summary-value" id="total-employees-payroll">0</div>
                        <div class="payroll-summary-label">Total Employees</div>
                    </div>
                    <div class="payroll-summary-card">
                        <div class="payroll-summary-value" id="total-payroll-amount">0</div>
                        <div class="payroll-summary-label">Total Payroll</div>
                    </div>
                    <div class="payroll-summary-card">
                        <div class="payroll-summary-value" id="processed-payroll">0</div>
                        <div class="payroll-summary-label">Processed</div>
                    </div>
                    <div class="payroll-summary-card">
                        <div class="payroll-summary-value" id="pending-payroll">0</div>
                        <div class="payroll-summary-label">Pending</div>
                    </div>
                </div>

                <!-- Employee Selection and Details - Side by Side Layout -->
                <div class="employee-info-container">
                    <!-- Employee Selection Card -->
                    <div class="card employee-selection-card">
                        <div class="card-header">
                            <h3 class="card-title">Employee Selection</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Employee</label>
                                <select class="form-control" id="employeeSelect">
                                    <option value="">-- Select Employee --</option>
                                    <!-- Options will be filled by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Pay Period</label>
                                <select class="form-control" id="payPeriodSelect">
                                    <!-- Options will be filled by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Date</label>
                                <input type="date" class="form-control" id="paymentDate" value="">
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="loadEmployeePayrollData()">
                                    <i class="fas fa-sync"></i> Load Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Details Card -->
                    <div class="card employee-details-card">
                        <div class="card-header">
                            <h3 class="card-title">Employee Details</h3>
                            <button id="editEmployeeBtn" class="btn btn-edit">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                        <div class="card-body" id="employeeDetailsSection">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Employee ID</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeId" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeName" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control employee-input" id="payrollEmployeeEmail" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" class="form-control employee-input" id="payrollEmployeePhone" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Joining Date</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeJoiningDate" value="" disabled>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Department</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeDept" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Position</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeePosition" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeLocation" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Bank Name</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeBankName" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Account Number</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeBankAccount" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">IFSC Code</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeIFSC" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">PF ID</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeePFID" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">PF UAN</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeePFUAN" value="" disabled>
                                    </div>
                                </div>
                            </div>
                            <div id="employeeActionBtns" style="display: none;">
                                <button id="saveEmployeeBtn" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button id="cancelEmployeeBtn" class="btn btn-primary">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Salary Components</h3>
                                <button id="editSalaryBtn" class="btn btn-edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                            <div class="card-body" id="salarySection">
                                <div class="form-group">
                                    <label class="form-label">Basic Salary</label>
                                    <input type="number" class="form-control salary-input" id="basicSalary" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">HRA</label>
                                    <input type="number" class="form-control salary-input" id="hra" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Special Allowance</label>
                                    <input type="number" class="form-control salary-input" id="specialAllowance" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Other Allowances</label>
                                    <input type="number" class="form-control salary-input" id="otherAllowances" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Gross Salary</label>
                                    <input type="number" class="form-control salary-input" id="gross" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Total Days</label>
                                    <input type="number" class="form-control salary-input" id="totalDays" value="30" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Actual Working Days</label>
                                    <input type="number" class="form-control salary-input" id="workingDays" value="30" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Actual Gross</label>
                                    <input type="number" class="form-control salary-input" id="actualGross" value="" disabled>
                                </div>
                                
                                <div id="salaryActionBtns" style="display: none;">
                                    <button id="saveSalaryBtn" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button id="cancelSalaryBtn" class="btn btn-primary">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Deductions</h3>
                                <button id="editDeductionsBtn" class="btn btn-edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                            <div class="card-body" id="deductionsSection">
                                <div class="form-group">
                                    <label class="form-label">Absent Days</label>
                                    <input type="number" class="form-control deduction-input" id="absentDays" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Half Day</label>
                                    <input type="number" class="form-control deduction-input" id="halfDay" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Late Arrivals</label>
                                    <input type="number" class="form-control deduction-input" id="lateDays" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Advance Deduction</label>
                                    <input type="number" class="form-control deduction-input" id="advanceDeduction" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">TDS</label>
                                    <input type="number" class="form-control deduction-input" id="tds" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">PF</label>
                                    <input type="number" class="form-control deduction-input" id="pf" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ESI</label>
                                    <input type="number" class="form-control deduction-input" id="esi" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">PT</label>
                                    <input type="number" class="form-control deduction-input" id="pt" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Other Deductions</label>
                                    <input type="number" class="form-control deduction-input" id="otherDeductions" value="0" disabled>
                                </div>
                                
                                <div id="deductionsActionBtns" style="display: none;">
                                    <button id="saveDeductionsBtn" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button id="cancelDeductionsBtn" class="btn btn-primary">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>

                                <!-- Submit Button -->
                                <button id="submitPayrollBtn" class="btn btn-primary" style="margin-top: 20px; width: 100%;">
                                    <i class="fas fa-calculator"></i> Calculate & Generate Salary Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Salary Summary Section (Initially Hidden) -->
                <div id="salarySummarySection">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Salary Summary</h3>
                                    <div class="btn-group">
                                        <button class="btn btn-success" onclick="generatePayslipPDF()">
                                            <i class="fas fa-file-pdf"></i> Generate Payslip
                                        </button>
                                        <button class="btn btn-info" onclick="savePayrollRecord()">
                                            <i class="fas fa-save"></i> Save Record
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <h4 class="summary-title">Allowances</h4>
                                                <ul class="summary-details">
                                                    <li>
                                                        <span>Basic Salary</span>
                                                        <span id="displayBasic">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>HRA</span>
                                                        <span id="displayHRA">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Special Allowance</span>
                                                        <span id="displaySpecialAllowance">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Other Allowances</span>
                                                        <span id="displayOtherAllowances">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Gross</span>
                                                        <span id="displayGross">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Actual Gross</span>
                                                        <span id="displayActualGross">0.00</span>
                                                    </li>
                                                    <li class="highlight">
                                                        <span>Total Earnings</span>
                                                        <span id="displayTotalEarnings">0.00</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <h4 class="summary-title">Deductions</h4>
                                                <ul class="summary-details">
                                                    <li>
                                                        <span>Absent Days</span>
                                                        <span id="displayAbsentDays">0</span>
                                                    </li>
                                                    <li>
                                                        <span>Half Day</span>
                                                        <span id="displayHalfDay">0</span>
                                                    </li>
                                                    <li>
                                                        <span>Late Arrivals</span>
                                                        <span id="displayLateDays">0</span>
                                                    </li>
                                                    <li>
                                                        <span>Advance Deduction</span>
                                                        <span id="displayAdvance">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>TDS</span>
                                                        <span id="displayTDS">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>PF</span>
                                                        <span id="displayPF">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>ESI</span>
                                                        <span id="displayESI">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>PT</span>
                                                        <span id="displayPT">0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Other Deductions</span>
                                                        <span id="displayOtherDeductions">0.00</span>
                                                    </li>
                                                    <li class="highlight">
                                                        <span>Total Deductions</span>
                                                        <span id="displayTotalDeductions">0.00</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <h4 class="summary-title">Net Salary</h4>
                                                <div class="summary-value" id="displayNet">0.00</div>
                                                <div class="form-group">
                                                    <label class="form-label">Payment Method</label>
                                                    <select class="form-control" id="paymentMethod">
                                                        <option>Bank Transfer</option>
                                                        <option>Check</option>
                                                        <option>Cash</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Bank Account</label>
                                                    <input type="text" class="form-control" id="bankAccountDisplay" placeholder="Account details" value="" disabled>
                                                </div>
                                                <button class="btn btn-success" style="width: 100%;" id="generatePayslipBtn">
                                                    <i class="fas fa-check-circle"></i> Approve & Process Payslip
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payroll History -->
                <div class="card" style="margin-top: 25px;">
                    <div class="card-header">
                        <h3 class="card-title">Payroll History</h3>
                        <button class="btn btn-outline btn-sm" onclick="refreshPayrollHistory()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="payrollHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Period</th>
                                        <th>Basic Salary</th>
                                        <th>Allowances</th>
                                        <th>Deductions</th>
                                        <th>Net Salary</th>
                                        <th>Payment Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payrollHistoryBody">
                                    <!-- Payroll history will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Section -->
            <div id="attendance" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-clipboard-check"></i> Employee Attendance System</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button id="sync-attendance-btn" class="btn btn-info sync-btn">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <div id="sync-attendance-status" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Attendance Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daily Attendance</h3>
                        <div class="btn-group">
                            <button class="btn btn-info" onclick="openMonthlyRecords()">
                                <i class="fas fa-calendar-alt"></i> Monthly Records
                            </button>
                            <button class="btn btn-warning" onclick="openBulkAttendance()">
                                <i class="fas fa-users"></i> Bulk Attendance
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="date-selector">
                            <label class="form-label">Select Date:</label>
                            <input type="date" class="form-control" id="attendance-date" style="max-width: 200px;">
                            <button class="btn btn-outline" onclick="setTodayDate()">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                        </div>
                        
                        <div class="attendance-actions">
                            <div class="search-container">
                                <input type="text" class="form-control" id="employee-search" placeholder="Search employees...">
                            </div>
                            
                            <div class="attendance-bulk-actions">
                                <button class="btn btn-success" onclick="markAllPresent()">
                                    <i class="fas fa-check-circle"></i> Mark All Present
                                </button>
                                <button class="btn btn-danger" onclick="markAllAbsent()">
                                    <i class="fas fa-times-circle"></i> Mark All Absent
                                </button>
                            </div>
                        </div>
                        
                        <div class="attendance-status-filter">
                            <button class="status-filter-btn active" onclick="filterAttendanceByStatus('all')">All</button>
                            <button class="status-filter-btn" onclick="filterAttendanceByStatus('present')">Present</button>
                            <button class="status-filter-btn" onclick="filterAttendanceByStatus('absent')">Absent</button>
                            <button class="status-filter-btn" onclick="filterAttendanceByStatus('late')">Late</button>
                            <button class="status-filter-btn" onclick="filterAttendanceByStatus('leave')">Leave</button>
                            <button class="status-filter-btn" onclick="filterAttendanceByStatus('halfday')">Half Day</button>
                        </div>
                        
                        <button id="save-attendance-btn" class="btn btn-success" style="margin-bottom: 20px;">
                            <i class="fas fa-save"></i> Save Today's Attendance
                        </button>
                        
                        <div class="table-container">
                            <table id="attendance-table">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                        <th>Remarks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-list">
                                    <!-- Attendance records will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="attendance-summary">
                            <div class="summary-item">
                                <div class="summary-value" id="present-count">0</div>
                                <div class="summary-label">Present</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="absent-count">0</div>
                                <div class="summary-label">Absent</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="late-count">0</div>
                                <div class="summary-label">Late Arrivals</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="leave-count">0</div>
                                <div class="summary-label">Paid Leaves</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="halfday-count">0</div>
                                <div class="summary-label">Half Days</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="total-count">0</div>
                                <div class="summary-label">Total Employees</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Reports Card -->
                <div class="card" style="margin-top: 25px;">
                    <div class="card-header">
                        <h3 class="card-title">Attendance Reports</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Select Employee</label>
                                    <select class="form-control" id="reportEmployeeSelect">
                                        <option value="">-- All Employees --</option>
                                        <!-- Options will be filled by JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Select Month</label>
                                    <input type="month" class="form-control" id="reportMonthSelect">
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="generateAttendanceReport()">
                                <i class="fas fa-chart-bar"></i> Generate Report
                            </button>
                            <button class="btn btn-success" onclick="exportAttendanceReport()">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                            <button class="btn btn-info" onclick="viewAttendanceAnalytics()">
                                <i class="fas fa-chart-line"></i> View Analytics
                            </button>
                        </div>
                        
                        <div id="attendance-report-container" style="margin-top: 20px;">
                            <!-- Attendance report will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Employee Reports</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-control" id="employeeReportType">
                                        <option value="department">Department Wise</option>
                                        <option value="position">Position Wise</option>
                                        <option value="location">Location Wise</option>
                                        <option value="status">Employment Status</option>
                                        <option value="salary">Salary Range</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="generateEmployeeReport()">
                                    <i class="fas fa-chart-pie"></i> Generate Report
                                </button>
                                <button class="btn btn-success" onclick="exportEmployeeReport()">
                                    <i class="fas fa-download"></i> Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Payroll Reports</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Report Period</label>
                                    <input type="month" class="form-control" id="payrollReportMonth">
                                </div>
                                <button class="btn btn-primary" onclick="generatePayrollReport()">
                                    <i class="fas fa-chart-bar"></i> Generate Report
                                </button>
                                <button class="btn btn-success" onclick="exportPayrollReport()">
                                    <i class="fas fa-download"></i> Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 25px;">
                    <div class="card-header">
                        <h3 class="card-title">Report Output</h3>
                    </div>
                    <div class="card-body">
                        <div id="report-output">
                            <!-- Report output will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div id="settings" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-cog"></i> System Settings</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Company Settings</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Company Name</label>
                                    <input type="text" class="form-control" id="companyName" value="Samkitec Resources">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Company Address</label>
                                    <textarea class="form-control" id="companyAddress" rows="3">Pyrogreen Energy Private Limited - FLAT NO 304, SAHITI SRI VIDHYA PETAL, Street No-1, Patrika Nagar, HITEC City, Hyderabad, Telangana 500081</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default Working Days</label>
                                    <input type="number" class="form-control" id="defaultWorkingDays" value="30" min="1" max="31">
                                </div>
                                <button class="btn btn-primary" onclick="saveCompanySettings()">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Payroll Settings</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Default PF Percentage</label>
                                    <input type="number" class="form-control" id="defaultPF" value="12" min="0" max="100" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default ESI Percentage</label>
                                    <input type="number" class="form-control" id="defaultESI" value="1.75" min="0" max="100" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default TDS Percentage</label>
                                    <input type="number" class="form-control" id="defaultTDS" value="10" min="0" max="100" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default PT Amount</label>
                                    <input type="number" class="form-control" id="defaultPT" value="200" min="0">
                                </div>
                                <button class="btn btn-primary" onclick="savePayrollSettings()">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 25px;">
                    <div class="card-header">
                        <h3 class="card-title">Data Management</h3>
                    </div>
                    <div class="card-body">
                        <div class="btn-group">
                            <button class="btn btn-info" onclick="backupData()">
                                <i class="fas fa-download"></i> Backup Data
                            </button>
                            <button class="btn btn-warning" onclick="restoreData()">
                                <i class="fas fa-upload"></i> Restore Data
                            </button>
                            <button class="btn btn-danger" onclick="clearAllData()">
                                <i class="fas fa-trash"></i> Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Records Modal -->
    <div id="monthly-records-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt"></i> Monthly Attendance Records</h2>
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="downloadMonthlyRecords()">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button class="btn btn-danger" onclick="closeMonthlyRecords()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label class="form-label">Select Month: </label>
                <input type="month" class="form-control" id="month-select" onchange="loadMonthlyRecords()" style="max-width: 200px; display: inline-block;">
                <button class="btn btn-danger" onclick="clearCurrentMonthRecords()" style="margin-left: 20px;">
                    <i class="fas fa-trash"></i> Clear This Month's Records
                </button>
            </div>
            
            <div class="table-container">
                <div id="monthly-records-container">
                    <!-- Monthly records will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Attendance Modal -->
    <div id="bulk-attendance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> Bulk Attendance Update</h2>
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="closeBulkAttendance()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Date</label>
                    <input type="date" class="form-control" id="bulk-attendance-date">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Department</label>
                    <select class="form-control" id="bulk-department-select">
                        <option value="">All Departments</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Operations">Operations</option>
                        <option value="IT">IT</option>
                        <option value="Sales">Sales</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Production">Production</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Set Status for Selected Employees</label>
                    <select class="form-control" id="bulk-status-select">
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                        <option value="leave">Leave</option>
                        <option value="halfday">Half Day</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Time (for Present/Late/Half Day)</label>
                    <input type="time" class="form-control" id="bulk-time-input" value="09:00">
                </div>
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="applyBulkAttendance()">
                        <i class="fas fa-check"></i> Apply to All Filtered Employees
                    </button>
                </div>
                
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-bulk"></th>
                                <th>Employee ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Current Status</th>
                            </tr>
                        </thead>
                        <tbody id="bulk-attendance-list">
                            <!-- Bulk attendance list will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Details Modal -->
    <div id="employee-details-modal" class="modal">
        <div class="modal-content" id="employee-details-content">
            <div class="modal-header">
                <h2><i class="fas fa-user"></i> Employee Attendance Details</h2>
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="downloadEmployeeDetails()">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button class="btn btn-danger" onclick="closeEmployeeDetails()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="detail-employee-id" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="detail-employee-name" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Month</label>
                        <input type="month" class="form-control" id="detail-month-select" onchange="filterEmployeeDetailsByMonth()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <input type="text" class="form-control" id="detail-employee-dept" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control" id="detail-employee-position" disabled>
                    </div>
                    <div class="form-group" style="text-align: right; margin-top: 25px;">
                        <button class="btn btn-primary" onclick="editEmployeeAttendance()">
                            <i class="fas fa-edit"></i> Edit Attendance
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3 class="card-title">Attendance Summary</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="summary-card">
                                <h4 class="summary-title">Attendance Counts</h4>
                                <ul class="summary-details">
                                    <li>
                                        <span>Present Days</span>
                                        <span id="detail-present-days">0</span>
                                    </li>
                                    <li>
                                        <span>Absent Days</span>
                                        <span id="detail-absent-days">0</span>
                                    </li>
                                    <li>
                                        <span>Late Arrivals</span>
                                        <span id="detail-late-days">0</span>
                                    </li>
                                    <li>
                                        <span>Paid Leaves</span>
                                        <span id="detail-leave-days">0</span>
                                    </li>
                                    <li>
                                        <span>Half Days</span>
                                        <span id="detail-halfday-days">0</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="summary-card">
                                <h4 class="summary-title">Calculated Values</h4>
                                <ul class="summary-details">
                                    <li>
                                        <span>Total Days Present</span>
                                        <span id="detail-total-present">0</span>
                                    </li>
                                    <li>
                                        <span>Total Days Absent</span>
                                        <span id="detail-total-absent">0</span>
                                    </li>
                                    <li>
                                        <span>Half Days Left</span>
                                        <span id="detail-halfday-left">Null</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="summary-card">
                                <h4 class="summary-title">Attendance Records</h4>
                                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detail-attendance-records">
                                            <!-- Attendance records will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Data Management with Firebase
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || {};
        let monthlyReports = JSON.parse(localStorage.getItem('monthlyReports')) || {};
        let savedDays = JSON.parse(localStorage.getItem('savedDays')) || [];
        let payrollRecords = JSON.parse(localStorage.getItem('payrollRecords')) || [];
        let companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
            companyName: "Samkitec Resources",
            companyAddress: "Pyrogreen Energy Private Limited - FLAT NO 304, SAHITI SRI VIDHYA PETAL, Street No-1, Patrika Nagar, HITEC City, Hyderabad, Telangana 500081",
            defaultWorkingDays: 30,
            defaultPF: 12,
            defaultESI: 1.75,
            defaultTDS: 10,
            defaultPT: 200
        };
        
        // DOM Elements for Employee Management
        const employeeElements = {
            form: document.getElementById('employeeForm'),
            formFields: {
                id: document.getElementById('employeeId'),
                empId: document.getElementById('empId'),
                name: document.getElementById('empName'),
                gender: document.getElementById('empGender'),
                dob: document.getElementById('empDOB'),
                department: document.getElementById('empDepartment'),
                position: document.getElementById('empPosition'),
                email: document.getElementById('empEmail'),
                phone: document.getElementById('empPhone'),
                address: document.getElementById('empAddress'),
                city: document.getElementById('empCity'),
                state: document.getElementById('empState'),
                pincode: document.getElementById('empPincode'),
                aadhar: document.getElementById('empAadhar'),
                pan: document.getElementById('empPAN'),
                manager: document.getElementById('empManager'),
                location: document.getElementById('empLocation'),
                salary: document.getElementById('empSalary'),
                salaryType: document.getElementById('empSalaryType'),
                bankName: document.getElementById('empBankName'),
                accountNo: document.getElementById('empAccountNo'),
                IFSCCode: document.getElementById('empIFSCCode'),
                branch: document.getElementById('empBranch'),
                PFID: document.getElementById('empPFID'),
                PFUAN: document.getElementById('empPFUAN'),
                allowances: document.getElementById('empAllowances'),
                deductions: document.getElementById('empDeductions'),
                taxIdentification: document.getElementById('empTaxIdentification'),
                status: document.getElementById('empStatus'),
                joinDate: document.getElementById('empJoinDate'),
                education: document.getElementById('empEducation'),
                skills: document.getElementById('empSkills'),
                experience: document.getElementById('empExperience')
            },
            buttons: {
                add: document.getElementById('addEmployeeBtn'),
                save: document.getElementById('saveEmployeeBtn'),
                cancel: document.getElementById('cancelEmployeeBtn')
            },
            table: {
                body: document.getElementById('employeeTableBody'),
                search: document.getElementById('employeeSearch')
            }
        };

        // Initialize the application
        function initializeApplication() {
            renderEmployeeTable();
            setupEmployeeEventListeners();
            setupPayrollEventListeners();
            setupAttendanceEventListeners();
            updatePayrollDates();
            loadDashboardData();
            loadCompanySettings();
            
            // Load sample data if empty
            if (employees.length === 0) {
                loadSampleData();
            }
            
            // Populate employee dropdowns
            populatePayrollEmployeeDropdown();
            populateReportEmployeeDropdown();
            
            // Set today's date as default for attendance
            setTodayDate();
            
            // Set current month as default for attendance
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('month-select').value = currentMonth;
            document.getElementById('reportMonthSelect').value = currentMonth;
            document.getElementById('payrollReportMonth').value = currentMonth;
            
            // Show dashboard section by default
            showSection('dashboard');
            
            // Render initial attendance list
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
            updateAttendanceSaveButtonState();
            
            // Sync with Firebase
            syncEmployeesWithFirebase();
            syncAttendanceWithFirebase();
            syncPayrollWithFirebase();
        }

        // Enhanced Firebase Sync Functions
        async function syncEmployeesWithFirebase() {
            try {
                updateSyncStatus('employees', 'syncing');
                
                const { collection, getDocs, doc, setDoc, deleteDoc } = window.firestoreFunctions;
                
                // Get employees from Firebase
                const snapshot = await getDocs(collection(window.firebaseDb, 'employees'));
                const firebaseEmployees = [];
                
                snapshot.forEach(doc => {
                    firebaseEmployees.push({ id: doc.id, ...doc.data() });
                });
                
                // If Firebase has data, use it (Firebase as source of truth)
                if (firebaseEmployees.length > 0) {
                    employees = firebaseEmployees;
                    localStorage.setItem('employees', JSON.stringify(employees));
                    renderEmployeeTable();
                    populatePayrollEmployeeDropdown();
                    populateReportEmployeeDropdown();
                    updateSyncStatus('employees', 'synced');
                } else {
                    // If no data in Firebase, push local data to Firebase
                    await pushEmployeesToFirebase();
                    updateSyncStatus('employees', 'synced');
                }
            } catch (error) {
                console.error('Error syncing employees with Firebase:', error);
                updateSyncStatus('employees', 'error');
            }
        }

        async function pushEmployeesToFirebase() {
            try {
                const { collection, doc, setDoc, getDocs, deleteDoc } = window.firestoreFunctions;
                
                // Clear existing employees in Firebase
                const snapshot = await getDocs(collection(window.firebaseDb, 'employees'));
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // Add all local employees to Firebase
                const addPromises = employees.map(employee => {
                    const docRef = doc(collection(window.firebaseDb, 'employees'), employee.id);
                    return setDoc(docRef, employee);
                });
                
                await Promise.all(addPromises);
                updateSyncStatus('employees', 'synced');
            } catch (error) {
                console.error('Error pushing employees to Firebase:', error);
                updateSyncStatus('employees', 'error');
            }
        }

        async function syncAttendanceWithFirebase() {
            try {
                updateSyncStatus('attendance', 'syncing');
                
                const { collection, getDocs, doc, setDoc } = window.firestoreFunctions;
                
                // Get attendance from Firebase
                const snapshot = await getDocs(collection(window.firebaseDb, 'attendance'));
                const firebaseAttendance = {};
                
                snapshot.forEach(doc => {
                    firebaseAttendance[doc.id] = doc.data();
                });
                
                // If Firebase has data, use it (Firebase as source of truth)
                if (Object.keys(firebaseAttendance).length > 0) {
                    attendanceRecords = firebaseAttendance;
                    localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                    updateSyncStatus('attendance', 'synced');
                } else {
                    // If no data in Firebase, push local data to Firebase
                    await pushAttendanceToFirebase();
                    updateSyncStatus('attendance', 'synced');
                }
            } catch (error) {
                console.error('Error syncing attendance with Firebase:', error);
                updateSyncStatus('attendance', 'error');
            }
        }

        async function pushAttendanceToFirebase() {
            try {
                const { collection, doc, setDoc, getDocs, deleteDoc } = window.firestoreFunctions;
                
                // Clear existing attendance in Firebase
                const snapshot = await getDocs(collection(window.firebaseDb, 'attendance'));
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // Add all local attendance records to Firebase
                const addPromises = Object.keys(attendanceRecords).map(date => {
                    const docRef = doc(collection(window.firebaseDb, 'attendance'), date);
                    return setDoc(docRef, attendanceRecords[date]);
                });
                
                await Promise.all(addPromises);
                updateSyncStatus('attendance', 'synced');
            } catch (error) {
                console.error('Error pushing attendance to Firebase:', error);
                updateSyncStatus('attendance', 'error');
            }
        }

        async function syncPayrollWithFirebase() {
            try {
                const { collection, getDocs, doc, setDoc } = window.firestoreFunctions;
                
                // Get payroll records from Firebase
                const snapshot = await getDocs(collection(window.firebaseDb, 'payroll'));
                const firebasePayroll = [];
                
                snapshot.forEach(doc => {
                    firebasePayroll.push({ id: doc.id, ...doc.data() });
                });
                
                // If Firebase has data, use it (Firebase as source of truth)
                if (firebasePayroll.length > 0) {
                    payrollRecords = firebasePayroll;
                    localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
                    renderPayrollHistory();
                } else {
                    // If no data in Firebase, push local data to Firebase
                    await pushPayrollToFirebase();
                }
            } catch (error) {
                console.error('Error syncing payroll with Firebase:', error);
            }
        }

        async function pushPayrollToFirebase() {
            try {
                const { collection, doc, setDoc, getDocs, deleteDoc } = window.firestoreFunctions;
                
                // Clear existing payroll in Firebase
                const snapshot = await getDocs(collection(window.firebaseDb, 'payroll'));
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // Add all local payroll records to Firebase
                const addPromises = payrollRecords.map(record => {
                    const docRef = doc(collection(window.firebaseDb, 'payroll'), record.id || generateId());
                    return setDoc(docRef, record);
                });
                
                await Promise.all(addPromises);
            } catch (error) {
                console.error('Error pushing payroll to Firebase:', error);
            }
        }

        function updateSyncStatus(section, status) {
            const statusElement = document.getElementById(`sync-${section}-status`);
            if (!statusElement) return;
            
            const icon = statusElement.querySelector('i');
            
            statusElement.className = `sync-status ${status}`;
            
            switch(status) {
                case 'syncing':
                    icon.className = 'fas fa-sync fa-spin';
                    statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...';
                    break;
                case 'synced':
                    icon.className = 'fas fa-check-circle';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Synced';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-triangle';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sync Error';
                    break;
            }
        }

        // Enhanced Navigation between sections
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update active menu item
            document.querySelectorAll('.sidebar-menu .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the corresponding menu item
            const menuItem = document.querySelector(`.sidebar-menu .menu-item[onclick="showSection('${sectionId}')"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Special handling for sections
            if (sectionId === 'attendance') {
                renderEmployeeAttendanceList();
                updateAttendanceSummary();
                updateAttendanceSaveButtonState();
            } else if (sectionId === 'payroll') {
                renderPayrollHistory();
                updatePayrollSummary();
            } else if (sectionId === 'dashboard') {
                loadDashboardData();
            }
        }

        // Enhanced Employee Management Functions
        function setupEmployeeEventListeners() {
            // Add employee button
            employeeElements.buttons.add.addEventListener('click', showEmployeeForm);
            
            // Cancel button
            employeeElements.buttons.cancel.addEventListener('click', hideEmployeeForm);
            
            // Save button - using form submission
            document.getElementById('employeeDataForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEmployee();
            });
            
            // Search functionality
            employeeElements.table.search.addEventListener('input', filterEmployees);
            
            // Sync button
            document.getElementById('sync-employees-btn').addEventListener('click', function() {
                syncEmployeesWithFirebase();
            });

            // Export button
            document.getElementById('exportEmployeesBtn').addEventListener('click', exportEmployeeData);
            
            // Import button
            document.getElementById('importEmployeesBtn').addEventListener('click', importEmployeeData);

        }

        // Enhanced Payroll Functions
        function setupPayrollEventListeners() {
            // Employee Details Edit/Save functionality
            document.getElementById('editEmployeeBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#employeeDetailsSection .employee-input');
                inputs.forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('employeeActionBtns').style.display = 'block';
                this.style.display = 'none';
            });
            
            document.getElementById('saveEmployeeBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#employeeDetailsSection .employee-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('employeeActionBtns').style.display = 'none';
                document.getElementById('editEmployeeBtn').style.display = 'block';
                alert('Employee details updated successfully!');
            });
            
            document.getElementById('cancelEmployeeBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#employeeDetailsSection .employee-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('employeeActionBtns').style.display = 'none';
                document.getElementById('editEmployeeBtn').style.display = 'block';
            });
            
            // Edit/Save functionality for Salary Components
            document.getElementById('editSalaryBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#salarySection .salary-input');
                inputs.forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('salaryActionBtns').style.display = 'block';
                this.style.display = 'none';
            });
            
            document.getElementById('saveSalaryBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#salarySection .salary-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('salaryActionBtns').style.display = 'none';
                document.getElementById('editSalaryBtn').style.display = 'block';
                calculateSalary();
            });
            
            document.getElementById('cancelSalaryBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#salarySection .salary-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('salaryActionBtns').style.display = 'none';
                document.getElementById('editSalaryBtn').style.display = 'block';
                calculateSalary();
            });
            
            // Edit/Save functionality for Deductions
            document.getElementById('editDeductionsBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#deductionsSection .deduction-input');
                inputs.forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('deductionsActionBtns').style.display = 'block';
                this.style.display = 'none';
            });
            
            document.getElementById('saveDeductionsBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#deductionsSection .deduction-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('deductionsActionBtns').style.display = 'none';
                document.getElementById('editDeductionsBtn').style.display = 'block';
                calculateSalary();
            });
            
            document.getElementById('cancelDeductionsBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#deductionsSection .deduction-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('deductionsActionBtns').style.display = 'none';
                document.getElementById('editDeductionsBtn').style.display = 'block';
                calculateSalary();
            });

            // Submit button functionality to show salary summary
            document.getElementById('submitPayrollBtn').addEventListener('click', function() {
                calculateSalary();
                document.getElementById('salarySummarySection').style.display = 'block';
                // Scroll to the summary section
                document.getElementById('salarySummarySection').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Add event listener to the payslip generation button
            document.getElementById('generatePayslipBtn').addEventListener('click', generatePayslipPDF);
            
            // Update summary when employee is selected
            document.getElementById('employeeSelect').addEventListener('change', function() {
                const selectedEmployeeId = this.value;
                if (selectedEmployeeId) {
                    const employee = employees.find(emp => emp.id === selectedEmployeeId);
                    if (employee) {
                        updatePayrollEmployeeDetails(employee);
                        updateAttendanceDeductions(employee.id);
                    }
                }
                // Recalculate salary
                calculateSalary();
                // Hide salary summary when changing employee
                document.getElementById('salarySummarySection').style.display = 'none';
            });
            
            // Sync button
            document.getElementById('sync-payroll-btn').addEventListener('click', function() {
                syncEmployeesWithFirebase();
                syncPayrollWithFirebase();
            });
        }

        // Enhanced Attendance Functions
        function setupAttendanceEventListeners() {
            // Date change handler
            document.getElementById('attendance-date').addEventListener('change', function() {
                renderEmployeeAttendanceList();
                updateAttendanceSummary();
                updateAttendanceSaveButtonState();
            });
            
            // Search functionality
            document.getElementById('employee-search').addEventListener('input', function() {
                renderEmployeeAttendanceList();
            });
            
            // Save attendance button handler
            document.getElementById('save-attendance-btn').addEventListener('click', function() {
                const date = document.getElementById('attendance-date').value;
                
                if (!attendanceRecords[date] || Object.keys(attendanceRecords[date]).length === 0) {
                    alert('No attendance data to save for this date');
                    return;
                }
                
                // Mark this day as saved
                if (!savedDays.includes(date)) {
                    savedDays.push(date);
                    localStorage.setItem('savedDays', JSON.stringify(savedDays));
                }
                
                // Update monthly reports
                const [year, month] = date.split('-');
                const monthKey = `${year}-${month}`;
                
                if (!monthlyReports[monthKey]) {
                    monthlyReports[monthKey] = {};
                }
                
                monthlyReports[monthKey][date] = attendanceRecords[date];
                localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
                
                // Sync with Firebase
                pushAttendanceToFirebase();
                
                updateAttendanceSaveButtonState();
                alert('Attendance for ' + date + ' has been saved successfully!');
            });
            
            // Sync button
            document.getElementById('sync-attendance-btn').addEventListener('click', function() {
                syncAttendanceWithFirebase();
            });
        }

        // Enhanced Employee Form Functions
        function switchEmployeeTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the clicked tab
            event.target.classList.add('active');
        }

        // Show/hide employee form
        function showEmployeeForm() {
            employeeElements.form.style.display = 'block';
            employeeElements.formFields.id.value = '';
            employeeElements.formFields.empId.value = generateEmployeeId();
            employeeElements.formFields.name.focus();
            
            // Switch to personal tab
            switchEmployeeTab('personal');
        }

        function hideEmployeeForm() {
            employeeElements.form.style.display = 'none';
            document.getElementById('employeeDataForm').reset();
        }

        // Enhanced Save employee function
        function saveEmployee() {
            // Validate form
            if (!validateEmployeeForm()) {
                return false;
            }
            
            // Prepare employee data
            const employeeData = {
                id: employeeElements.formFields.empId.value,
                name: employeeElements.formFields.name.value.trim(),
                gender: employeeElements.formFields.gender.value,
                dob: employeeElements.formFields.dob.value,
                department: employeeElements.formFields.department.value,
                position: employeeElements.formFields.position.value.trim(),
                email: employeeElements.formFields.email.value.trim(),
                phone: employeeElements.formFields.phone.value.trim(),
                address: employeeElements.formFields.address.value.trim(),
                city: employeeElements.formFields.city.value.trim(),
                state: employeeElements.formFields.state.value.trim(),
                pincode: employeeElements.formFields.pincode.value.trim(),
                aadhar: employeeElements.formFields.aadhar.value.trim(),
                pan: employeeElements.formFields.pan.value.trim(),
                manager: employeeElements.formFields.manager.value.trim(),
                location: employeeElements.formFields.location.value.trim(),
                salary: parseFloat(employeeElements.formFields.salary.value),
                salaryType: employeeElements.formFields.salaryType.value,
                bankName: employeeElements.formFields.bankName.value.trim(),
                accountNo: employeeElements.formFields.accountNo.value.trim(),
                IFSCCode: employeeElements.formFields.IFSCCode.value.trim(),
                branch: employeeElements.formFields.branch.value.trim(),
                PFID: employeeElements.formFields.PFID.value.trim(),
                PFUAN: employeeElements.formFields.PFUAN.value.trim(),
                allowances: parseFloat(employeeElements.formFields.allowances.value) || 0,
                deductions: parseFloat(employeeElements.formFields.deductions.value) || 0,
                taxIdentification: employeeElements.formFields.taxIdentification.value.trim(),
                status: employeeElements.formFields.status.value,
                joinDate: employeeElements.formFields.joinDate.value,
                education: employeeElements.formFields.education.value,
                skills: employeeElements.formFields.skills.value,
                experience: parseFloat(employeeElements.formFields.experience.value) || 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Check if editing existing employee
            const existingIndex = employees.findIndex(emp => emp.id === employeeData.id);
            
            if (existingIndex >= 0) {
                // Update existing employee
                employees[existingIndex] = { ...employees[existingIndex], ...employeeData, updatedAt: new Date().toISOString() };
                alert('Employee updated successfully!');
            } else {
                // Add new employee
                employees.push(employeeData);
                alert('Employee added successfully!');
            }
            
            // Save to localStorage
            localStorage.setItem('employees', JSON.stringify(employees));
            
            // Sync with Firebase
            pushEmployeesToFirebase();
            
            // Refresh UI
            renderEmployeeTable();
            hideEmployeeForm();
            populatePayrollEmployeeDropdown();
            populateReportEmployeeDropdown();
            loadDashboardData();
            return true;
        }

        // Enhanced Form validation
        function validateEmployeeForm() {
            let isValid = true;
            const requiredFields = [
                employeeElements.formFields.empId,
                employeeElements.formFields.name,
                employeeElements.formFields.department,
                employeeElements.formFields.position,
                employeeElements.formFields.email,
                employeeElements.formFields.phone,
                employeeElements.formFields.location,
                employeeElements.formFields.salary,
                employeeElements.formFields.bankName,
                employeeElements.formFields.accountNo,
                employeeElements.formFields.IFSCCode,
                employeeElements.formFields.joinDate
            ];
            
            // Reset error states
            requiredFields.forEach(field => {
                field.style.borderColor = '';
            });
            
            // Check required fields
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = 'red';
                    isValid = false;
                }
            });
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(employeeElements.formFields.email.value)) {
                employeeElements.formFields.email.style.borderColor = 'red';
                alert('Please enter a valid email address');
                isValid = false;
            }
            
            // Validate salary
            if (isNaN(employeeElements.formFields.salary.value)) {
                employeeElements.formFields.salary.style.borderColor = 'red';
                alert('Please enter a valid salary amount');
                isValid = false;
            }
            
            if (!isValid) {
                alert('Please fill all required fields correctly');
            }
            
            return isValid;
        }

        // Generate unique employee ID
        function generateEmployeeId() {
            return 'EMP-' + Date.now().toString().slice(-6);
        }

        // Generate unique ID for records
        function generateId() {
            return 'REC-' + Date.now().toString();
        }

        // Enhanced Render employee table
        function renderEmployeeTable(data = employees) {
            employeeElements.table.body.innerHTML = '';
            
            if (data.length === 0) {
                employeeElements.table.body.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px;">
                            No employees found
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.position}</td>
                    <td>${emp.email || 'N/A'}</td>
                    <td>${emp.phone || 'N/A'}</td>
                    <td>${emp.location || 'N/A'}</td>
                    <td>${emp.salary.toLocaleString('en-IN')}</td>
                    <td><span class="status ${emp.status}">${emp.status.charAt(0).toUpperCase() + emp.status.slice(1)}</span></td>
                    <td>${emp.joinDate || 'N/A'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="table-action-btn view" onclick="viewEmployeeDetails('${emp.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-action-btn edit" onclick="editEmployee('${emp.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-action-btn delete" onclick="deleteEmployee('${emp.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                employeeElements.table.body.appendChild(row);
            });
        }

        // Enhanced Edit employee
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (employee) {
                // Fill form with employee data
                Object.keys(employeeElements.formFields).forEach(key => {
                    if (employeeElements.formFields[key] && employee[key] !== undefined) {
                        employeeElements.formFields[key].value = employee[key];
                    }
                });
                
                employeeElements.formFields.id.value = employee.id;
                showEmployeeForm();
            }
        }

        // Enhanced Delete employee
        function deleteEmployee(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                employees = employees.filter(emp => emp.id !== id);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // Sync with Firebase
                pushEmployeesToFirebase();
                
                renderEmployeeTable();
                populatePayrollEmployeeDropdown();
                populateReportEmployeeDropdown();
                loadDashboardData();
                alert('Employee deleted successfully!');
            }
        }

        // Enhanced Filter employees
        function filterEmployees() {
            const searchTerm = employeeElements.table.search.value.toLowerCase();
            const filtered = employees.filter(emp => 
                emp.id.toLowerCase().includes(searchTerm) ||
                emp.name.toLowerCase().includes(searchTerm) ||
                (emp.department && emp.department.toLowerCase().includes(searchTerm)) ||
                (emp.position && emp.position.toLowerCase().includes(searchTerm)) ||
                (emp.email && emp.email.toLowerCase().includes(searchTerm)) ||
                (emp.phone && emp.phone.toLowerCase().includes(searchTerm)) ||
                (emp.location && emp.location.toLowerCase().includes(searchTerm))
            );
            renderEmployeeTable(filtered);
        }

        function filterEmployeesByStatus(status) {
            let filtered = employees;
            if (status !== 'all') {
                filtered = employees.filter(emp => emp.status === status);
            }
            renderEmployeeTable(filtered);
        }

        // Enhanced Load sample data
        function loadSampleData() {
            const sampleEmployees = [
                {
                    id: 'EMP-1001',
                    name: 'Rajesh Kumar',
                    gender: 'male',
                    department: 'IT',
                    position: 'Software Developer',
                    email: 'rajesh.kumar@company.com',
                    phone: '9876543210',
                    location: 'Hyderabad',
                    salary: 50000,
                    salaryType: 'monthly',
                    bankName: 'HDFC Bank',
                    accountNo: '123456789012',
                    IFSCCode: 'HDFC0001234',
                    PFID: 'PF/12345/6789',
                    PFUAN: '123456789012',
                    allowances: 5000,
                    deductions: 2000,
                    status: 'active',
                    joinDate: '2023-01-15',
                    education: 'bachelor',
                    skills: 'JavaScript, React, Node.js',
                    experience: 3
                },
                {
                    id: 'EMP-1002',
                    name: 'Priya Sharma',
                    gender: 'female',
                    department: 'HR',
                    position: 'HR Manager',
                    email: 'priya.sharma@company.com',
                    phone: '9876543211',
                    location: 'Hyderabad',
                    salary: 60000,
                    salaryType: 'monthly',
                    bankName: 'ICICI Bank',
                    accountNo: '123456789013',
                    IFSCCode: 'ICIC0001234',
                    PFID: 'PF/12345/6790',
                    PFUAN: '123456789013',
                    allowances: 6000,
                    deductions: 2500,
                    status: 'active',
                    joinDate: '2022-11-20',
                    education: 'master',
                    skills: 'Recruitment, Employee Relations',
                    experience: 5
                }
            ];
            
            employees = sampleEmployees;
            localStorage.setItem('employees', JSON.stringify(employees));
        }

        // Enhanced Payroll Functions
        function formatCurrency(amount) {
            return '' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        function calculateSalary() {
            // Get all input values
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const hra = parseFloat(document.getElementById('hra').value) || 0;
            const specialAllowance = parseFloat(document.getElementById('specialAllowance').value) || 0;
            const otherAllowances = parseFloat(document.getElementById('otherAllowances').value) || 0;
            const gross = parseFloat(document.getElementById('gross').value) || 0;
            const actualGross = parseFloat(document.getElementById('actualGross').value) || 0;
            const totalDays = parseInt(document.getElementById('totalDays').value) || companySettings.defaultWorkingDays;
            const workingDays = parseInt(document.getElementById('workingDays').value) || companySettings.defaultWorkingDays;
            
            const absentDays = parseInt(document.getElementById('absentDays').value) || 0;
            const halfDay = parseInt(document.getElementById('halfDay').value) || 0;
            const lateDays = parseInt(document.getElementById('lateDays').value) || 0;
            const advanceDeduction = parseFloat(document.getElementById('advanceDeduction').value) || 0;
            const tds = parseFloat(document.getElementById('tds').value) || 0;
            const pf = parseFloat(document.getElementById('pf').value) || 0;
            const esi = parseFloat(document.getElementById('esi').value) || 0;
            const pt = parseFloat(document.getElementById('pt').value) || 0;
            const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
            
            // Calculate daily salary
            const dailySalary = actualGross / totalDays;
            
            // Calculate deductions for absent days, half days, and late arrivals
            const absentDeduction = absentDays * dailySalary;
            const halfDayDeduction = halfDay * (dailySalary / 2);
            const lateDeduction = lateDays * (dailySalary * 0.1); // 10% deduction for late arrivals
            
            // Calculate totals
            const totalEarnings = actualGross;
            const totalDeductions = absentDeduction + halfDayDeduction + lateDeduction + advanceDeduction + tds + pf + esi + pt + otherDeductions;
            const netSalary = totalEarnings - totalDeductions;
            
            // Update display values with rupee symbol
            document.getElementById('displayBasic').textContent = formatCurrency(basicSalary);
            document.getElementById('displayHRA').textContent = formatCurrency(hra);
            document.getElementById('displaySpecialAllowance').textContent = formatCurrency(specialAllowance);
            document.getElementById('displayOtherAllowances').textContent = formatCurrency(otherAllowances);
            document.getElementById('displayGross').textContent = formatCurrency(gross);
            document.getElementById('displayActualGross').textContent = formatCurrency(actualGross);
            document.getElementById('displayTotalEarnings').textContent = formatCurrency(totalEarnings);
            
            document.getElementById('displayAbsentDays').textContent = absentDays;
            document.getElementById('displayHalfDay').textContent = halfDay;
            document.getElementById('displayLateDays').textContent = lateDays;
            document.getElementById('displayAdvance').textContent = formatCurrency(advanceDeduction);
            document.getElementById('displayTDS').textContent = formatCurrency(tds);
            document.getElementById('displayPF').textContent = formatCurrency(pf);
            document.getElementById('displayESI').textContent = formatCurrency(esi);
            document.getElementById('displayPT').textContent = formatCurrency(pt);
            document.getElementById('displayOtherDeductions').textContent = formatCurrency(otherDeductions);
            document.getElementById('displayTotalDeductions').textContent = formatCurrency(totalDeductions);
            
            document.getElementById('displayNet').textContent = formatCurrency(netSalary);
        }
        
        function updatePayrollDates() {
            const now = new Date();
            const currentMonth = now.toLocaleString('default', { month: 'long' });
            const currentYear = now.getFullYear();
            
            // Calculate next payroll date (15th of next month)
            let nextMonth = now.getMonth() + 1;
            let nextYear = currentYear;
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }
            const nextPayrollDate = new Date(nextYear, nextMonth, 15);
            const nextPayrollMonth = nextPayrollDate.toLocaleString('default', { month: 'long' });
            const nextPayrollDay = nextPayrollDate.getDate();
            const nextPayrollYear = nextPayrollDate.getFullYear();
            
            // Update alert text
            document.getElementById('payrollAlert').innerHTML = `
                Payroll processing for <strong>${currentMonth} ${currentYear}</strong>. 
                Next payroll run scheduled for <strong>${nextPayrollMonth} ${nextPayrollDay}, ${nextPayrollYear}</strong>.
            `;
            
            // Set default payment date to today
            document.getElementById('paymentDate').valueAsDate = now;
            
            // Generate pay period options
            const payPeriodSelect = document.getElementById('payPeriodSelect');
            payPeriodSelect.innerHTML = '';
            
            // Add current month option
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            payPeriodSelect.add(new Option(
                `${firstDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${lastDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`,
                'current'
            ));
            
            // Add previous months options
            for (let i = 1; i <= 3; i++) {
                const prevMonth = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const prevLastDay = new Date(now.getYear(), now.getMonth() - i + 1, 0);
                payPeriodSelect.add(new Option(
                    `${prevMonth.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${prevLastDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`,
                    `prev-${i}`
                ));
            }
        }
        
        function generatePayslipPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current date and month
            const today = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
            const currentMonth = monthNames[today.getMonth()];
            const currentYear = today.getFullYear();
            
            // Get all employee data from the form
            const employeeName = document.getElementById('payrollEmployeeName').value;
            const employeeId = document.getElementById('payrollEmployeeId').value;
            const joiningDate = document.getElementById('payrollEmployeeJoiningDate').value || '18.04.2023';
            const designation = document.getElementById('payrollEmployeePosition').value;
            const department = document.getElementById('payrollEmployeeDept').value;
            const location = document.getElementById('payrollEmployeeLocation').value;
            const bankName = document.getElementById('payrollEmployeeBankName').value;
            const bankAccount = document.getElementById('payrollEmployeeBankAccount').value;
            const ifscCode = document.getElementById('payrollEmployeeIFSC').value;
            const pfId = document.getElementById('payrollEmployeePFID').value;
            const pfUan = document.getElementById('payrollEmployeePFUAN').value;
            
            // Get salary data
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const hra = parseFloat(document.getElementById('hra').value) || 0;
            const specialAllowance = parseFloat(document.getElementById('specialAllowance').value) || 0;
            const otherAllowances = parseFloat(document.getElementById('otherAllowances').value) || 0;
            const gross = parseFloat(document.getElementById('gross').value) || 0;
            const actualGross = parseFloat(document.getElementById('actualGross').value) || 0;
            const totalDays = document.getElementById('totalDays').value || companySettings.defaultWorkingDays;
            const workingDays = document.getElementById('workingDays').value || companySettings.defaultWorkingDays;
            
            // Get deductions
            const absentDays = parseInt(document.getElementById('absentDays').value) || 0;
            const halfDay = parseInt(document.getElementById('halfDay').value) || 0;
            const lateDays = parseInt(document.getElementById('lateDays').value) || 0;
            const pfDeduction = parseFloat(document.getElementById('pf').value) || 0;
            const ptDeduction = parseFloat(document.getElementById('pt').value) || 0;
            const tdsDeduction = parseFloat(document.getElementById('tds').value) || 0;
            const esiDeduction = parseFloat(document.getElementById('esi').value) || 0;
            const advanceDeduction = parseFloat(document.getElementById('advanceDeduction').value) || 0;
            const otherDeductions = parseFloat(document.getElementById('otherDeductions').value) || 0;
            
            // Calculate daily salary and absent deductions
            const dailySalary = actualGross / totalDays;
            const absentDeduction = absentDays * dailySalary;
            const halfDayDeduction = halfDay * (dailySalary / 2);
            const lateDeduction = lateDays * (dailySalary * 0.1); // 10% deduction for late arrivals
            
            // Calculate totals
            const totalEarnings = actualGross;
            const totalDeductions = absentDeduction + halfDayDeduction + lateDeduction + pfDeduction + ptDeduction + tdsDeduction + esiDeduction + advanceDeduction + otherDeductions;
            const netPay = totalEarnings - totalDeductions;
            
            // Set font styles for the entire document to match your sample
            doc.setFont('helvetica');
            doc.setFontSize(10);
            
            // Company header (exactly as in your sample)
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text("M/s. PYROGREEN ENERGY PVT. LTD", 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            // Split address into two lines as requested
            doc.text("Pyrogreen Energy Private Limited - FLAT NO 304, SAHITI SRI VIDHYA PETAL,", 105, 22, { align: 'center' });
            doc.text("Street No-1, Patrika Nagar, HITEC City, Hyderabad, Telangana 500081", 105, 27, { align: 'center' });
            
            // Payslip title
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`Payslip for the Month of ${currentMonth} ${currentYear}`, 105, 35, { align: 'center' });
            
            // Employee details table (matching your sample's style)
            let yPos = 45;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Name:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(employeeName, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("Employee No:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(employeeId, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Joining Date:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(joiningDate, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("Bank Name:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(bankName, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Designation:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(designation, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("Bank Account No:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(bankAccount, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Department:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(department, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("IFSC Code:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(ifscCode, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Location:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(location, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("PF ID:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(pfId, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Effective Work Days:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(workingDays, 60, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("PF UAN:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(pfUan, 160, yPos);
            yPos += 12;
            
            // Earnings and Deductions table (matching your sample's style)
            doc.setFont('helvetica', 'bold');
            doc.text("Earnings", 20, yPos);
            doc.text("Full", 70, yPos);
            doc.text("Actual", 100, yPos);
            doc.text("Deductions", 140, yPos);
            doc.text("Actual", 180, yPos);
            yPos += 7;
            
            // Horizontal line
            doc.line(20, yPos, 190, yPos);
            yPos += 5;
            
            // Basic Salary row
            doc.setFont('helvetica', 'normal');
            doc.text("BASIC", 20, yPos);
            doc.text(basicSalary.toFixed(2), 70, yPos);
            doc.text(basicSalary.toFixed(2), 100, yPos);
            doc.text("ABSENT DAYS", 140, yPos);
            doc.text(absentDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // HRA row
            doc.text("HRA", 20, yPos);
            doc.text(hra.toFixed(2), 70, yPos);
            doc.text(hra.toFixed(2), 100, yPos);
            doc.text("HALF DAY", 140, yPos);
            doc.text(halfDayDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Special Allowance row
            doc.text("SPECIAL ALLOWANCE", 20, yPos);
            doc.text(specialAllowance.toFixed(2), 70, yPos);
            doc.text(specialAllowance.toFixed(2), 100, yPos);
            doc.text("LATE ARRIVALS", 140, yPos);
            doc.text(lateDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Other Allowances row
            doc.text("OTHER ALLOWANCES", 20, yPos);
            doc.text(otherAllowances.toFixed(2), 70, yPos);
            doc.text(otherAllowances.toFixed(2), 100, yPos);
            doc.text("PF", 140, yPos);
            doc.text(pfDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("PROFESSION TAX", 140, yPos);
            doc.text(ptDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("TDS", 140, yPos);
            doc.text(tdsDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("ESI", 140, yPos);
            doc.text(esiDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("SALARY ADVANCE", 140, yPos);
            doc.text(advanceDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Other Deductions row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("OTHER DEDUCTIONS", 140, yPos);
            doc.text(otherDeductions.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Totals row
            doc.setFont('helvetica', 'bold');
            doc.text("Total Earnings:INR.", 20, yPos);
            doc.text("", 70, yPos);
            doc.text(totalEarnings.toFixed(2), 100, yPos);
            doc.text("Total Deductions:INR.", 140, yPos);
            doc.text(totalDeductions.toFixed(2), 180, yPos);
            yPos += 12;
            
            // Net pay
            doc.setFont('helvetica', 'bold');
            doc.text(`Net Pay for the month (Total Earnings - Total Deductions): ${netPay.toFixed(2)}`, 20, yPos);
            yPos += 10;
            
            // Footer note (exactly as in your sample)
            doc.setFont('helvetica', 'italic');
            doc.text("This is a system generated payslip and does not require signature.", 105, yPos, { align: 'center' });
            
            // Save the PDF with employee name and month/year
            doc.save(`Payslip_${employeeName.replace(/\s+/g, '_')}_${currentMonth}_${currentYear}.pdf`);
        }

        // Enhanced Populate employee dropdown in payroll section
        function populatePayrollEmployeeDropdown() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- Select Employee --</option>';
            
            employees.forEach(employee => {
                if (employee.status === 'active') {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.id})`;
                    select.appendChild(option);
                }
            });
        }

        function populateReportEmployeeDropdown() {
            const select = document.getElementById('reportEmployeeSelect');
            select.innerHTML = '<option value="">-- All Employees --</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.id})`;
                select.appendChild(option);
            });
        }

        // Enhanced Update payroll employee details when selected
        function updatePayrollEmployeeDetails(employee) {
            document.getElementById('payrollEmployeeId').value = employee.id;
            document.getElementById('payrollEmployeeName').value = employee.name;
            document.getElementById('payrollEmployeeEmail').value = employee.email || '';
            document.getElementById('payrollEmployeePhone').value = employee.phone || '';
            document.getElementById('payrollEmployeeDept').value = employee.department || '';
            document.getElementById('payrollEmployeePosition').value = employee.position || '';
            document.getElementById('payrollEmployeeLocation').value = employee.location || '';
            document.getElementById('payrollEmployeeBankName').value = employee.bankName || '';
            document.getElementById('payrollEmployeeBankAccount').value = employee.accountNo || '';
            document.getElementById('payrollEmployeeIFSC').value = employee.IFSCCode || '';
            document.getElementById('payrollEmployeePFID').value = employee.PFID || '';
            document.getElementById('payrollEmployeePFUAN').value = employee.PFUAN || '';
            
            // Format joining date
            const joinDate = employee.joinDate ? new Date(employee.joinDate) : new Date();
            document.getElementById('payrollEmployeeJoiningDate').value = joinDate.toLocaleDateString('en-GB');
            
            // Update salary fields
            document.getElementById('basicSalary').value = employee.salary || 0;
            document.getElementById('hra').value = Math.round((employee.salary || 0) * 0.4); // 40% of basic as HRA
            document.getElementById('specialAllowance').value = employee.allowances || 0;
            document.getElementById('otherAllowances').value = 0;
            document.getElementById('gross').value = (employee.salary || 0) + (employee.allowances || 0) + Math.round((employee.salary || 0) * 0.4);
            document.getElementById('actualGross').value = (employee.salary || 0) + (employee.allowances || 0) + Math.round((employee.salary || 0) * 0.4);
            
            // Set total days based on current month
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            document.getElementById('totalDays').value = daysInMonth;
            document.getElementById('workingDays').value = daysInMonth;
            
            // Update deductions with default values from settings
            document.getElementById('tds').value = Math.round((employee.salary || 0) * (companySettings.defaultTDS / 100));
            document.getElementById('pf').value = Math.round((employee.salary || 0) * (companySettings.defaultPF / 100));
            document.getElementById('esi').value = Math.round((employee.salary || 0) * (companySettings.defaultESI / 100));
            document.getElementById('pt').value = companySettings.defaultPT;
            document.getElementById('advanceDeduction').value = 0;
            document.getElementById('otherDeductions').value = 0;
            
            // Update bank account display in summary
            document.getElementById('bankAccountDisplay').value = 
                `${employee.accountNo || 'XXXX-XXXX-XXXX'} (${employee.bankName || 'Bank'})`;
        }
        
        function loadEmployeePayrollData() {
            const employeeId = document.getElementById('employeeSelect').value;
            const payPeriod = document.getElementById('payPeriodSelect').value;
            
            if (!employeeId) {
                alert('Please select an employee');
                return;
            }
            
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                updatePayrollEmployeeDetails(employee);
                updateAttendanceDeductions(employee.id, payPeriod);
                calculateSalary();
            }
        }
        
        // Enhanced Update attendance deductions based on selected employee and payroll period
        function updateAttendanceDeductions(employeeId, payPeriod) {
            const selectedPeriod = payPeriod || document.getElementById('payPeriodSelect').value;
            
            // Initialize counters
            let absentDays = 0;
            let halfDays = 0;
            let lateDays = 0;
            
            // Determine the month to check based on selected payroll period
            let targetMonth = '';
            const now = new Date();
            
            if (selectedPeriod === 'current') {
                targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            } else if (selectedPeriod.startsWith('prev-')) {
                const monthsBack = parseInt(selectedPeriod.split('-')[1]);
                const targetDate = new Date(now.getFullYear(), now.getMonth() - monthsBack, 1);
                targetMonth = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
            }
            
            // Check if we have monthly reports for the target month
            if (targetMonth && monthlyReports[targetMonth]) {
                // Loop through all dates in this month's report
                Object.keys(monthlyReports[targetMonth]).forEach(date => {
                    // Check if this employee has a record for this date
                    if (monthlyReports[targetMonth][date][employeeId]) {
                        const record = monthlyReports[targetMonth][date][employeeId];
                        
                        // Count absent days, half days, and late arrivals
                        if (record.status === 'absent') absentDays++;
                        else if (record.status === 'halfday') halfDays++;
                        else if (record.status === 'late') lateDays++;
                    }
                });
            }
            
            // Update the form fields
            document.getElementById('absentDays').value = absentDays;
            document.getElementById('halfDay').value = halfDays;
            document.getElementById('lateDays').value = lateDays;
            
            // Update working days
            const totalDays = parseInt(document.getElementById('totalDays').value) || companySettings.defaultWorkingDays;
            const presentDays = totalDays - absentDays - Math.ceil(halfDays / 2);
            document.getElementById('workingDays').value = Math.max(0, presentDays);
            
            // Recalculate actual gross
            const gross = parseFloat(document.getElementById('gross').value) || 0;
            const dailyRate = gross / totalDays;
            const actualGross = presentDays * dailyRate;
            document.getElementById('actualGross').value = actualGross.toFixed(2);
        }

        // Enhanced Attendance Functions
        function renderEmployeeAttendanceList() {
            const date = document.getElementById('attendance-date').value;
            const searchTerm = document.getElementById('employee-search').value.toLowerCase();
            const statusFilter = document.querySelector('.status-filter-btn.active').getAttribute('onclick').replace("filterAttendanceByStatus('", "").replace("')", "");
            
            // Initialize attendance records for the date if not exists
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            }
            
            // Filter employees based on search term and status
            let filteredEmployees = employees.filter(emp => 
                emp.id.toLowerCase().includes(searchTerm) ||
                emp.name.toLowerCase().includes(searchTerm) || 
                emp.department.toLowerCase().includes(searchTerm) ||
                (emp.phone && emp.phone.includes(searchTerm))
            );
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredEmployees = filteredEmployees.filter(emp => {
                    const record = attendanceRecords[date][emp.id];
                    return record && record.status === statusFilter;
                });
            }
            
            // Clear the table
            document.getElementById('attendance-list').innerHTML = '';
            
            // Add each employee to the table
            filteredEmployees.forEach(emp => {
                const record = attendanceRecords[date][emp.id] || {
                    status: 'absent',
                    time: '',
                    remarks: ''
                };
                
                const row = document.createElement('tr');
                
                // Status class for styling
                let statusClass = '';
                if (record.status === 'present') statusClass = 'status-present';
                else if (record.status === 'absent') statusClass = 'status-absent';
                else if (record.status === 'late') statusClass = 'status-late';
                else if (record.status === 'leave') statusClass = 'status-leave';
                else if (record.status === 'halfday') statusClass = 'status-halfday';
                
                // Status display with time if applicable
                const statusDisplay = record.time 
                    ? `${record.status.toUpperCase()} <span class="late-time">(${record.time})</span>`
                    : record.status.toUpperCase();
                
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.phone || 'N/A'}</td>
                    <td class="${statusClass}">${statusDisplay}</td>
                    <td>${record.time || '--:--'}</td>
                    <td>
                        <input type="text" class="form-control" value="${record.remarks || ''}" 
                               onchange="updateAttendanceRemarks('${emp.id}', this.value)" 
                               placeholder="Add remarks" style="width: 150px;">
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-success" onclick="markAttendanceWithTime('${emp.id}', 'present')">
                            <i class="fas fa-check"></i> Present
                        </button>
                        <button class="btn btn-danger" onclick="toggleAttendance('${emp.id}', 'absent')">
                            <i class="fas fa-times"></i> Absent
                        </button>
                        <button class="btn btn-warning" onclick="markAttendanceWithTime('${emp.id}', 'late')">
                            <i class="fas fa-clock"></i> Late
                        </button>
                        <button class="btn btn-leave" onclick="toggleAttendance('${emp.id}', 'leave')">
                            <i class="fas fa-umbrella-beach"></i> Leave
                        </button>
                        <button class="btn btn-halfday" onclick="markAttendanceWithTime('${emp.id}', 'halfday')">
                            <i class="fas fa-adjust"></i> Half Day
                        </button>
                    </td>
                `;
                
                document.getElementById('attendance-list').appendChild(row);
            });
        }
        
        function updateAttendanceRemarks(employeeId, remarks) {
            const date = document.getElementById('attendance-date').value;
            
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
            }
            
            if (!attendanceRecords[date][employeeId]) {
                attendanceRecords[date][employeeId] = {
                    status: 'absent',
                    time: '',
                    remarks: ''
                };
            }
            
            attendanceRecords[date][employeeId].remarks = remarks;
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
        }
        
        // Enhanced Mark attendance with time input for present, late, and halfday statuses
        function markAttendanceWithTime(employeeId, status) {
            const date = document.getElementById('attendance-date').value;
            
            // Initialize date if not exists
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
            }
            
            // Initialize employee record if not exists
            if (!attendanceRecords[date][employeeId]) {
                attendanceRecords[date][employeeId] = {
                    status: 'absent',
                    time: '',
                    remarks: ''
                };
            }
            
            const record = attendanceRecords[date][employeeId];
            
            // If already the same status, toggle to absent
            if (record.status === status) {
                record.status = 'absent';
                record.time = '';
            } else {
                const currentTime = new Date();
                const timeString = currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                record.status = status;
                record.time = timeString;
            }
            
            // Save to localStorage
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Refresh the list
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
        }
        
        // Enhanced Toggle attendance status (for statuses without time)
        function toggleAttendance(employeeId, status) {
            const date = document.getElementById('attendance-date').value;
            
            // Initialize date if not exists
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
            }
            
            // Initialize employee record if not exists
            if (!attendanceRecords[date][employeeId]) {
                attendanceRecords[date][employeeId] = {
                    status: 'absent',
                    time: '',
                    remarks: ''
                };
            }
            
            const record = attendanceRecords[date][employeeId];
            
            // Toggle status - if current status is same as clicked status, set to absent
            if (record.status === status) {
                record.status = 'absent';
            } else {
                record.status = status;
            }
            // Clear time for statuses that don't need it
            record.time = '';
            
            // Save to localStorage
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Refresh the list
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
        }
        
        // Enhanced Update attendance summary counters
        function updateAttendanceSummary() {
            const date = document.getElementById('attendance-date').value;
            let present = 0;
            let absent = 0;
            let late = 0;
            let leave = 0;
            let halfday = 0;
            
            if (attendanceRecords[date]) {
                Object.values(attendanceRecords[date]).forEach(record => {
                    if (record.status === 'present') present++;
                    else if (record.status === 'absent') absent++;
                    else if (record.status === 'late') late++;
                    else if (record.status === 'leave') leave++;
                    else if (record.status === 'halfday') halfday++;
                });
            }
            
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
            document.getElementById('late-count').textContent = late;
            document.getElementById('leave-count').textContent = leave;
            document.getElementById('halfday-count').textContent = halfday;
            document.getElementById('total-count').textContent = employees.length;
        }
        
        // Enhanced Update attendance save button state
        function updateAttendanceSaveButtonState() {
            const date = document.getElementById('attendance-date').value;
            const saveBtn = document.getElementById('save-attendance-btn');
            
            if (savedDays.includes(date)) {
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Attendance Saved';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-primary');
                saveBtn.disabled = true;
            } else {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Today\'s Attendance';
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-success');
                saveBtn.disabled = false;
            }
        }
        
        function setTodayDate() {
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            document.getElementById('attendance-date').value = todayFormatted;
            document.getElementById('bulk-attendance-date').value = todayFormatted;
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
            updateAttendanceSaveButtonState();
        }
        
        function filterAttendanceByStatus(status) {
            // Update active filter button
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderEmployeeAttendanceList();
        }
        
        function markAllPresent() {
            const date = document.getElementById('attendance-date').value;
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            employees.forEach(emp => {
                if (!attendanceRecords[date]) {
                    attendanceRecords[date] = {};
                }
                
                attendanceRecords[date][emp.id] = {
                    status: 'present',
                    time: timeString,
                    remarks: 'Bulk marked present'
                };
            });
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
            alert('All employees marked as present!');
        }
        
        function markAllAbsent() {
            const date = document.getElementById('attendance-date').value;
            
            employees.forEach(emp => {
                if (!attendanceRecords[date]) {
                    attendanceRecords[date] = {};
                }
                
                attendanceRecords[date][emp.id] = {
                    status: 'absent',
                    time: '',
                    remarks: 'Bulk marked absent'
                };
            });
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
            alert('All employees marked as absent!');
        }
        
        function openBulkAttendance() {
            document.getElementById('bulk-attendance-modal').style.display = 'flex';
            renderBulkAttendanceList();
        }
        
        function closeBulkAttendance() {
            document.getElementById('bulk-attendance-modal').style.display = 'none';
        }
        
        function renderBulkAttendanceList() {
            const departmentFilter = document.getElementById('bulk-department-select').value;
            let filteredEmployees = employees;
            
            if (departmentFilter) {
                filteredEmployees = employees.filter(emp => emp.department === departmentFilter);
            }
            
            const list = document.getElementById('bulk-attendance-list');
            list.innerHTML = '';
            
            filteredEmployees.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="employee-checkbox" value="${emp.id}"></td>
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${getCurrentAttendanceStatus(emp.id)}</td>
                `;
                list.appendChild(row);
            });
            
            // Select all checkbox functionality
            document.getElementById('select-all-bulk').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.employee-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        }
        
        function getCurrentAttendanceStatus(employeeId) {
            const date = document.getElementById('bulk-attendance-date').value;
            if (attendanceRecords[date] && attendanceRecords[date][employeeId]) {
                return attendanceRecords[date][employeeId].status.toUpperCase();
            }
            return 'ABSENT';
        }
        
        function applyBulkAttendance() {
            const date = document.getElementById('bulk-attendance-date').value;
            const status = document.getElementById('bulk-status-select').value;
            const time = document.getElementById('bulk-time-input').value;
            const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one employee');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const employeeId = checkbox.value;
                
                if (!attendanceRecords[date]) {
                    attendanceRecords[date] = {};
                }
                
                attendanceRecords[date][employeeId] = {
                    status: status,
                    time: (status === 'present' || status === 'late' || status === 'halfday') ? time : '',
                    remarks: 'Bulk attendance update'
                };
            });
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            alert(`Attendance updated for ${checkboxes.length} employees`);
            closeBulkAttendance();
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
        }

        // Enhanced Monthly Attendance Records Functions
        function openMonthlyRecords() {
            document.getElementById('monthly-records-modal').style.display = 'flex';
            loadMonthlyRecords();
        }
        
        function closeMonthlyRecords() {
            document.getElementById('monthly-records-modal').style.display = 'none';
        }
        
        function downloadMonthlyRecords() {
            const month = document.getElementById('month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Prepare data for Excel
            const data = [];
            
            // Add header row
            data.push([
                'Date', 'Employee ID', 'Name', 'Department', 'Phone',
                'Status', 'Time', 'Remarks', 'Saved'
            ]);
            
            // Add data rows
            Object.keys(attendanceRecords).forEach(date => {
                if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    Object.keys(attendanceRecords[date]).forEach(empId => {
                        const record = attendanceRecords[date][empId];
                        const employee = employees.find(emp => emp.id === empId) || { 
                            name: 'Unknown', 
                            department: '',
                            phone: 'N/A'
                        };
                        
                        data.push([
                            date,
                            empId,
                            employee.name,
                            employee.department,
                            employee.phone || 'N/A',
                            record.status.toUpperCase(),
                            record.time || '--:--',
                            record.remarks || '',
                            savedDays.includes(date) ? 'Yes' : 'No'
                        ]);
                    });
                }
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Records");
            
            // Generate file name
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            const fileName = `Attendance_Records_${monthName}_${year}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, fileName);
        }
        
        function loadMonthlyRecords() {
            const month = document.getElementById('month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Filter records for the selected month
            const monthRecords = {};
            Object.keys(attendanceRecords).forEach(date => {
                if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    monthRecords[date] = attendanceRecords[date];
                }
            });
            
            // Generate HTML for the monthly report
            let html = '<div style="margin-bottom: 30px;">';
            
            // Summary for the month
            let totalDays = 0;
            let totalPresent = 0;
            let totalAbsent = 0;
            let totalLate = 0;
            let totalLeave = 0;
            let totalHalfday = 0;
            let totalSavedDays = 0;
            
            Object.keys(monthRecords).forEach(date => {
                totalDays++;
                if (savedDays.includes(date)) totalSavedDays++;
                Object.values(monthRecords[date]).forEach(record => {
                    if (record.status === 'present') totalPresent++;
                    else if (record.status === 'absent') totalAbsent++;
                    else if (record.status === 'late') totalLate++;
                    else if (record.status === 'leave') totalLeave++;
                    else if (record.status === 'halfday') totalHalfday++;
                });
            });
            
            html += `
                <h3>Monthly Summary</h3>
                <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalDays}</div>
                        <div>Days Recorded</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalSavedDays}</div>
                        <div>Days Saved</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalPresent}</div>
                        <div>Present Markings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalAbsent}</div>
                        <div>Absent Markings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalLate}</div>
                        <div>Late Markings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalLeave}</div>
                        <div>Paid Leaves</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalHalfday}</div>
                        <div>Half Days</div>
                    </div>
                </div>
            `;
            
            // Detailed records by date
            html += '<h3>Daily Records</h3>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 800px;">';
            html += `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Saved</th>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // Sort dates in descending order
            const sortedDates = Object.keys(monthRecords).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const isSaved = savedDays.includes(date);
                
                Object.keys(monthRecords[date]).forEach(empId => {
                    const record = monthRecords[date][empId];
                    const employee = employees.find(emp => emp.id === empId) || { name: 'Unknown', id: empId, department: '', phone: 'N/A' };
                    
                    let statusClass = '';
                    if (record.status === 'present') statusClass = 'status-present';
                    else if (record.status === 'absent') statusClass = 'status-absent';
                    else if (record.status === 'late') statusClass = 'status-late';
                    else if (record.status === 'leave') statusClass = 'status-leave';
                    else if (record.status === 'halfday') statusClass = 'status-halfday';
                    
                    const statusDisplay = record.time 
                        ? `${record.status.toUpperCase()} <span class="late-time">(${record.time})</span>`
                        : record.status.toUpperCase();
                    
                    html += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>${isSaved ? '' : ''}</td>
                            <td>${employee.id}</td>
                            <td>${employee.name}</td>
                            <td>${employee.department}</td>
                            <td>${employee.phone || 'N/A'}</td>
                            <td class="${statusClass}">${statusDisplay}</td>
                            <td>${record.time || '--:--'}</td>
                            <td>${record.remarks || ''}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="viewEmployeeDetails('${empId}', '${month}')">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            html += '</tbody></table></div>';
            document.getElementById('monthly-records-container').innerHTML = html;
            
            // Save this monthly view for potential export
            monthlyReports[month] = monthRecords;
            localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
        }
        
        function clearCurrentMonthRecords() {
            if (!confirm('Are you sure you want to clear all attendance records for this month? This cannot be undone.')) {
                return;
            }
            
            const month = document.getElementById('month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Filter out records for the selected month
            const newAttendanceRecords = {};
            Object.keys(attendanceRecords).forEach(date => {
                if (!date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    newAttendanceRecords[date] = attendanceRecords[date];
                }
            });
            
            attendanceRecords = newAttendanceRecords;
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Also remove from monthly reports and saved days
            delete monthlyReports[month];
            localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
            
            savedDays = savedDays.filter(date => !date.startsWith(`${year}-${monthNum.padStart(2, '0')}`));
            localStorage.setItem('savedDays', JSON.stringify(savedDays));
            
            // Sync with Firebase
            pushAttendanceToFirebase();
            
            alert('Records cleared for this month!');
            loadMonthlyRecords();
        }

        // Enhanced Employee Details Functions
        function viewEmployeeDetails(employeeId, monthFilter = '') {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) {
                alert('Employee not found!');
                return;
            }
            
            // Set employee details
            document.getElementById('detail-employee-id').value = employee.id;
            document.getElementById('detail-employee-name').value = employee.name;
            document.getElementById('detail-employee-dept').value = employee.department;
            document.getElementById('detail-employee-position').value = employee.position;
            
            // Set default month filter to current month if not provided
            if (!monthFilter) {
                const today = new Date();
                monthFilter = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            }
            document.getElementById('detail-month-select').value = monthFilter;
            
            // Filter records by month
            filterEmployeeDetailsByMonth();
            
            // Show the modal
            document.getElementById('employee-details-modal').style.display = 'flex';
        }
        
        function filterEmployeeDetailsByMonth() {
            const employeeId = document.getElementById('detail-employee-id').value;
            const month = document.getElementById('detail-month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Initialize counters for the selected month
            let presentDays = 0;
            let absentDays = 0;
            let lateDays = 0;
            let leaveDays = 0;
            let halfdayDays = 0;
            
            // Prepare attendance records for display
            let recordsHtml = '';
            
            // Get all dates in the selected month that have attendance records
            const monthDates = Object.keys(attendanceRecords)
                .filter(date => date.startsWith(`${year}-${monthNum.padStart(2, '0')}`))
                .sort((a, b) => new Date(a) - new Date(b));
            
            // Loop through each date in the month
            monthDates.forEach(date => {
                if (attendanceRecords[date][employeeId]) {
                    const record = attendanceRecords[date][employeeId];
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        weekday: 'short'
                    });
                    
                    // Count status types
                    if (record.status === 'present') presentDays++;
                    else if (record.status === 'absent') absentDays++;
                    else if (record.status === 'late') lateDays++;
                    else if (record.status === 'leave') leaveDays++;
                    else if (record.status === 'halfday') halfdayDays++;
                    
                    // Add to records table
                    let statusClass = '';
                    if (record.status === 'present') statusClass = 'status-present';
                    else if (record.status === 'absent') statusClass = 'status-absent';
                    else if (record.status === 'late') statusClass = 'status-late';
                    else if (record.status === 'leave') statusClass = 'status-leave';
                    else if (record.status === 'halfday') statusClass = 'status-halfday';
                    
                    const statusDisplay = record.time 
                        ? `${record.status.toUpperCase()} (${record.time})`
                        : record.status.toUpperCase();
                    
                    recordsHtml += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td class="${statusClass}">${statusDisplay}</td>
                        </tr>
                    `;
                }
            });
            
            // Calculate totals based on rules
            const halfdayPairs = Math.floor(halfdayDays / 2);
            const halfdayLeft = halfdayDays % 2;
            
            const totalPresent = presentDays + lateDays + leaveDays + halfdayPairs;
            const totalAbsent = absentDays + halfdayPairs;
            
            // Update display
            document.getElementById('detail-present-days').textContent = presentDays;
            document.getElementById('detail-absent-days').textContent = absentDays;
            document.getElementById('detail-late-days').textContent = lateDays;
            document.getElementById('detail-leave-days').textContent = leaveDays;
            document.getElementById('detail-halfday-days').textContent = halfdayDays;
            
            document.getElementById('detail-total-present').textContent = totalPresent;
            document.getElementById('detail-total-absent').textContent = totalAbsent;
            document.getElementById('detail-halfday-left').textContent = halfdayLeft > 0 ? halfdayLeft : 'Null';
            
            document.getElementById('detail-attendance-records').innerHTML = recordsHtml;
        }
        
        function editEmployeeAttendance() {
            const employeeId = document.getElementById('detail-employee-id').value;
            const month = document.getElementById('detail-month-select').value;
            
            // Close the details modal
            closeEmployeeDetails();
            
            // Set the attendance date to the first day of the selected month
            const [year, monthNum] = month.split('-');
            const firstDayOfMonth = `${year}-${monthNum}-01`;
            document.getElementById('attendance-date').value = firstDayOfMonth;
            
            // Show the attendance section
            showSection('attendance');
            
            // Scroll to the attendance section
            setTimeout(() => {
                document.getElementById('attendance').scrollIntoView({ behavior: 'smooth' });
                
                // Focus on the search field and filter by employee ID
                document.getElementById('employee-search').value = employeeId;
                renderEmployeeAttendanceList();
                
                // Show a message to the user
                alert(`Now editing attendance for ${employeeId}. Please navigate through dates using the date picker.`);
            }, 100);
        }
        
        function closeEmployeeDetails() {
            document.getElementById('employee-details-modal').style.display = 'none';
        }
        
        function downloadEmployeeDetails() {
            const employeeId = document.getElementById('detail-employee-id').value;
            const employeeName = document.getElementById('detail-employee-name').value;
            const month = document.getElementById('detail-month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Prepare data for Excel
            const data = [];
            
            // Add header row
            data.push([
                'Date', 'Status', 'Time', 'Remarks'
            ]);
            
            // Add data rows from the filtered records
            const rows = document.querySelectorAll('#detail-attendance-records tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const date = cells[0].textContent;
                const statusCell = cells[1];
                const status = statusCell.textContent.split(' (')[0];
                const time = statusCell.querySelector('.late-time') ? statusCell.querySelector('.late-time').textContent.replace(/[()]/g, '') : '';
                
                // Get remarks from attendance records
                const recordDate = new Date(date).toISOString().split('T')[0];
                const remarks = attendanceRecords[recordDate] && attendanceRecords[recordDate][employeeId] ? 
                    attendanceRecords[recordDate][employeeId].remarks || '' : '';
                
                data.push([date, status, time, remarks]);
            });
            
            // Add summary data
            data.push([]); // Empty row
            data.push(['Summary', '']);
            data.push(['Present Days', document.getElementById('detail-present-days').textContent]);
            data.push(['Absent Days', document.getElementById('detail-absent-days').textContent]);
            data.push(['Late Arrivals', document.getElementById('detail-late-days').textContent]);
            data.push(['Paid Leaves', document.getElementById('detail-leave-days').textContent]);
            data.push(['Half Days', document.getElementById('detail-halfday-days').textContent]);
            data.push(['Total Days Present', document.getElementById('detail-total-present').textContent]);
            data.push(['Total Days Absent', document.getElementById('detail-total-absent').textContent]);
            data.push(['Half Days Left', document.getElementById('detail-halfday-left').textContent]);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Details");
            
            // Generate file name
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            const fileName = `Attendance_Details_${employeeName.replace(/\s+/g, '_')}_${monthName}_${year}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, fileName);
        }

        // Dashboard Functions
        function loadDashboardData() {
            // Update employee counts
            const totalEmployees = employees.length;
            const activeEmployees = employees.filter(emp => emp.status === 'active').length;
            
            document.getElementById('total-employees').textContent = totalEmployees;
            document.getElementById('active-employees').textContent = activeEmployees;
            document.getElementById('total-employees-payroll').textContent = activeEmployees;
            
            // Update today's attendance
            const today = new Date().toISOString().split('T')[0];
            let todayPresent = 0;
            if (attendanceRecords[today]) {
                Object.values(attendanceRecords[today]).forEach(record => {
                    if (record.status === 'present') todayPresent++;
                });
            }
            document.getElementById('today-present').textContent = todayPresent;
            
            // Update monthly payroll
            const monthlyPayroll = employees.reduce((total, emp) => {
                return total + (emp.status === 'active' ? emp.salary : 0);
            }, 0);
            document.getElementById('monthly-payroll').textContent = formatCurrency(monthlyPayroll);
            document.getElementById('total-payroll-amount').textContent = formatCurrency(monthlyPayroll);
            
            // Update payroll processed counts
            const currentMonth = new Date().toISOString().slice(0, 7);
            const processedThisMonth = payrollRecords.filter(record => 
                record.period && record.period.startsWith(currentMonth)
            ).length;
            
            document.getElementById('processed-payroll').textContent = processedThisMonth;
            document.getElementById('pending-payroll').textContent = activeEmployees - processedThisMonth;
            
            // Load recent employees
            loadRecentEmployees();
            
            // Load attendance overview
            loadAttendanceOverview();
        }
        
        function loadRecentEmployees() {
            const recentEmployees = employees
                .sort((a, b) => new Date(b.createdAt || b.joinDate) - new Date(a.createdAt || a.joinDate))
                .slice(0, 5);
            
            const list = document.getElementById('recent-employees-list');
            list.innerHTML = '';
            
            if (recentEmployees.length === 0) {
                list.innerHTML = '<p>No employees found</p>';
                return;
            }
            
            recentEmployees.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.style.padding = '10px';
                item.style.borderBottom = '1px solid #f1f3f5';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                
                item.innerHTML = `
                    <div>
                        <strong>${emp.name}</strong>
                        <div style="font-size: 0.8rem; color: #6c757d;">${emp.department}  ${emp.position}</div>
                    </div>
                    <span class="status ${emp.status}">${emp.status.charAt(0).toUpperCase() + emp.status.slice(1)}</span>
                `;
                
                list.appendChild(item);
            });
        }
        
        function loadAttendanceOverview() {
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            
            // Calculate attendance statistics for the current month
            let presentCount = 0;
            let absentCount = 0;
            let lateCount = 0;
            let leaveCount = 0;
            let halfdayCount = 0;
            
            Object.keys(attendanceRecords).forEach(date => {
                if (date.startsWith(currentMonth)) {
                    Object.values(attendanceRecords[date]).forEach(record => {
                        if (record.status === 'present') presentCount++;
                        else if (record.status === 'absent') absentCount++;
                        else if (record.status === 'late') lateCount++;
                        else if (record.status === 'leave') leaveCount++;
                        else if (record.status === 'halfday') halfdayCount++;
                    });
                }
            });
            
            const container = document.getElementById('attendance-overview');
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">${presentCount}</div>
                    <div>Present Days This Month</div>
                </div>
                <div style="display: flex; justify-content: space-around;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold;">${absentCount}</div>
                        <div style="font-size: 0.8rem;">Absent</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold;">${lateCount}</div>
                        <div style="font-size: 0.8rem;">Late</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold;">${leaveCount}</div>
                        <div style="font-size: 0.8rem;">Leave</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold;">${halfdayCount}</div>
                        <div style="font-size: 0.8rem;">Half Day</div>
                    </div>
                </div>
            `;
        }

        // Payroll History Functions
        function renderPayrollHistory() {
            const tableBody = document.getElementById('payrollHistoryBody');
            tableBody.innerHTML = '';
            
            if (payrollRecords.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 20px;">
                            No payroll records found
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by payment date (newest first)
            const sortedRecords = payrollRecords.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.employeeId}</td>
                    <td>${record.employeeName}</td>
                    <td>${record.period}</td>
                    <td>${formatCurrency(record.basicSalary)}</td>
                    <td>${formatCurrency(record.allowances)}</td>
                    <td>${formatCurrency(record.deductions)}</td>
                    <td>${formatCurrency(record.netSalary)}</td>
                    <td>${record.paymentDate}</td>
                    <td><span class="status active">Processed</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="table-action-btn view" onclick="viewPayrollRecord('${record.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="table-action-btn delete" onclick="deletePayrollRecord('${record.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function savePayrollRecord() {
            const employeeId = document.getElementById('payrollEmployeeId').value;
            const employeeName = document.getElementById('payrollEmployeeName').value;
            const period = document.getElementById('payPeriodSelect').options[document.getElementById('payPeriodSelect').selectedIndex].text;
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const allowances = parseFloat(document.getElementById('displayTotalEarnings').textContent.replace(/[,]/g, '')) || 0;
            const deductions = parseFloat(document.getElementById('displayTotalDeductions').textContent.replace(/[,]/g, '')) || 0;
            const netSalary = parseFloat(document.getElementById('displayNet').textContent.replace(/[,]/g, '')) || 0;
            
            const payrollRecord = {
                id: generateId(),
                employeeId,
                employeeName,
                period,
                paymentDate,
                paymentMethod,
                basicSalary,
                allowances,
                deductions,
                netSalary,
                createdAt: new Date().toISOString()
            };
            
            payrollRecords.push(payrollRecord);
            localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
            
            // Sync with Firebase
            pushPayrollToFirebase();
            
            alert('Payroll record saved successfully!');
            renderPayrollHistory();
            updatePayrollSummary();
        }
        
        function viewPayrollRecord(recordId) {
            const record = payrollRecords.find(r => r.id === recordId);
            if (record) {
                alert(`Payroll Record Details:\n
Employee: ${record.employeeName} (${record.employeeId})
Period: ${record.period}
Basic Salary: ${formatCurrency(record.basicSalary)}
Allowances: ${formatCurrency(record.allowances)}
Deductions: ${formatCurrency(record.deductions)}
Net Salary: ${formatCurrency(record.netSalary)}
Payment Date: ${record.paymentDate}
Payment Method: ${record.paymentMethod}`);
            }
        }
        
        function deletePayrollRecord(recordId) {
            if (confirm('Are you sure you want to delete this payroll record?')) {
                payrollRecords = payrollRecords.filter(r => r.id !== recordId);
                localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
                
                // Sync with Firebase
                pushPayrollToFirebase();
                
                renderPayrollHistory();
                updatePayrollSummary();
                alert('Payroll record deleted successfully!');
            }
        }
        
        function refreshPayrollHistory() {
            renderPayrollHistory();
        }
        
        function updatePayrollSummary() {
            // This function is called when payroll records are updated
            loadDashboardData();
        }

        // Report Functions
        function generateEmployeeReport() {
            const reportType = document.getElementById('employeeReportType').value;
            let reportData = [];
            let reportTitle = '';
            
            switch(reportType) {
                case 'department':
                    reportTitle = 'Employees by Department';
                    const departments = [...new Set(employees.map(emp => emp.department))];
                    departments.forEach(dept => {
                        const deptEmployees = employees.filter(emp => emp.department === dept);
                        reportData.push({
                            category: dept,
                            count: deptEmployees.length,
                            details: deptEmployees.map(emp => `${emp.name} (${emp.id})`).join(', ')
                        });
                    });
                    break;
                    
                case 'position':
                    reportTitle = 'Employees by Position';
                    const positions = [...new Set(employees.map(emp => emp.position))];
                    positions.forEach(position => {
                        const positionEmployees = employees.filter(emp => emp.position === position);
                        reportData.push({
                            category: position,
                            count: positionEmployees.length,
                            details: positionEmployees.map(emp => `${emp.name} (${emp.id})`).join(', ')
                        });
                    });
                    break;
                    
                case 'location':
                    reportTitle = 'Employees by Location';
                    const locations = [...new Set(employees.map(emp => emp.location))];
                    locations.forEach(location => {
                        const locationEmployees = employees.filter(emp => emp.location === location);
                        reportData.push({
                            category: location,
                            count: locationEmployees.length,
                            details: locationEmployees.map(emp => `${emp.name} (${emp.id})`).join(', ')
                        });
                    });
                    break;
                    
                case 'status':
                    reportTitle = 'Employees by Employment Status';
                    const statuses = [...new Set(employees.map(emp => emp.status))];
                    statuses.forEach(status => {
                        const statusEmployees = employees.filter(emp => emp.status === status);
                        reportData.push({
                            category: status.charAt(0).toUpperCase() + status.slice(1),
                            count: statusEmployees.length,
                            details: statusEmployees.map(emp => `${emp.name} (${emp.id})`).join(', ')
                        });
                    });
                    break;
                    
                case 'salary':
                    reportTitle = 'Employees by Salary Range';
                    const salaryRanges = [
                        { range: 'Below 25,000', min: 0, max: 24999 },
                        { range: '25,000 - 50,000', min: 25000, max: 50000 },
                        { range: '50,001 - 75,000', min: 50001, max: 75000 },
                        { range: '75,001 - 1,00,000', min: 75001, max: 100000 },
                        { range: 'Above 1,00,000', min: 100001, max: Infinity }
                    ];
                    
                    salaryRanges.forEach(range => {
                        const rangeEmployees = employees.filter(emp => 
                            emp.salary >= range.min && emp.salary <= range.max
                        );
                        reportData.push({
                            category: range.range,
                            count: rangeEmployees.length,
                            details: rangeEmployees.map(emp => `${emp.name} (${emp.id}) - ${formatCurrency(emp.salary)}`).join(', ')
                        });
                    });
                    break;
            }
            
            displayReport(reportTitle, reportData);
        }
        
        function generatePayrollReport() {
            const month = document.getElementById('payrollReportMonth').value;
            if (!month) {
                alert('Please select a month');
                return;
            }
            
            const monthRecords = payrollRecords.filter(record => 
                record.period && record.period.includes(month)
            );
            
            if (monthRecords.length === 0) {
                alert('No payroll records found for the selected month');
                return;
            }
            
            const reportTitle = `Payroll Report for ${month}`;
            const reportData = monthRecords.map(record => ({
                category: `${record.employeeName} (${record.employeeId})`,
                count: '',
                details: `Basic: ${formatCurrency(record.basicSalary)} | Allowances: ${formatCurrency(record.allowances)} | Deductions: ${formatCurrency(record.deductions)} | Net: ${formatCurrency(record.netSalary)}`
            }));
            
            // Add summary
            const totalBasic = monthRecords.reduce((sum, record) => sum + record.basicSalary, 0);
            const totalAllowances = monthRecords.reduce((sum, record) => sum + record.allowances, 0);
            const totalDeductions = monthRecords.reduce((sum, record) => sum + record.deductions, 0);
            const totalNet = monthRecords.reduce((sum, record) => sum + record.netSalary, 0);
            
            reportData.push({
                category: 'TOTAL',
                count: '',
                details: `Basic: ${formatCurrency(totalBasic)} | Allowances: ${formatCurrency(totalAllowances)} | Deductions: ${formatCurrency(totalDeductions)} | Net: ${formatCurrency(totalNet)}`
            });
            
            displayReport(reportTitle, reportData);
        }
        
        function displayReport(title, data) {
            const output = document.getElementById('report-output');
            let html = `
                <h3>${title}</h3>
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Count</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.category}</td>
                        <td>${item.count}</td>
                        <td>${item.details}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            output.innerHTML = html;
        }
        
        function exportEmployeeReport() {
            const reportType = document.getElementById('employeeReportType').value;
            let data = [];
            let fileName = '';
            
            switch(reportType) {
                case 'department':
                    fileName = 'Employee_Department_Report';
                    const departments = [...new Set(employees.map(emp => emp.department))];
                    data.push(['Department', 'Employee Count', 'Employees']);
                    departments.forEach(dept => {
                        const deptEmployees = employees.filter(emp => emp.department === dept);
                        data.push([
                            dept,
                            deptEmployees.length,
                            deptEmployees.map(emp => `${emp.name} (${emp.id})`).join('; ')
                        ]);
                    });
                    break;
                    
                case 'position':
                    fileName = 'Employee_Position_Report';
                    const positions = [...new Set(employees.map(emp => emp.position))];
                    data.push(['Position', 'Employee Count', 'Employees']);
                    positions.forEach(position => {
                        const positionEmployees = employees.filter(emp => emp.position === position);
                        data.push([
                            position,
                            positionEmployees.length,
                            positionEmployees.map(emp => `${emp.name} (${emp.id})`).join('; ')
                        ]);
                    });
                    break;
                    
                // Add other report types as needed
            }
            
            if (data.length > 0) {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "Employee Report");
                XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);
            }
        }
        
        function exportPayrollReport() {
            const month = document.getElementById('payrollReportMonth').value;
            if (!month) {
                alert('Please select a month');
                return;
            }
            
            const monthRecords = payrollRecords.filter(record => 
                record.period && record.period.includes(month)
            );
            
            if (monthRecords.length === 0) {
                alert('No payroll records found for the selected month');
                return;
            }
            
            const data = [
                ['Employee ID', 'Employee Name', 'Period', 'Basic Salary', 'Allowances', 'Deductions', 'Net Salary', 'Payment Date', 'Payment Method']
            ];
            
            monthRecords.forEach(record => {
                data.push([
                    record.employeeId,
                    record.employeeName,
                    record.period,
                    record.basicSalary,
                    record.allowances,
                    record.deductions,
                    record.netSalary,
                    record.paymentDate,
                    record.paymentMethod
                ]);
            });
            
            // Add totals
            const totalBasic = monthRecords.reduce((sum, record) => sum + record.basicSalary, 0);
            const totalAllowances = monthRecords.reduce((sum, record) => sum + record.allowances, 0);
            const totalDeductions = monthRecords.reduce((sum, record) => sum + record.deductions, 0);
            const totalNet = monthRecords.reduce((sum, record) => sum + record.netSalary, 0);
            
            data.push([]);
            data.push(['TOTAL', '', '', totalBasic, totalAllowances, totalDeductions, totalNet, '', '']);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Payroll Report");
            XLSX.writeFile(wb, `Payroll_Report_${month}.xlsx`);
        }

        // Settings Functions
        function loadCompanySettings() {
            document.getElementById('companyName').value = companySettings.companyName;
            document.getElementById('companyAddress').value = companySettings.companyAddress;
            document.getElementById('defaultWorkingDays').value = companySettings.defaultWorkingDays;
            document.getElementById('defaultPF').value = companySettings.defaultPF;
            document.getElementById('defaultESI').value = companySettings.defaultESI;
            document.getElementById('defaultTDS').value = companySettings.defaultTDS;
            document.getElementById('defaultPT').value = companySettings.defaultPT;
        }
        
        function saveCompanySettings() {
            companySettings.companyName = document.getElementById('companyName').value;
            companySettings.companyAddress = document.getElementById('companyAddress').value;
            companySettings.defaultWorkingDays = parseInt(document.getElementById('defaultWorkingDays').value);
            
            localStorage.setItem('companySettings', JSON.stringify(companySettings));
            alert('Company settings saved successfully!');
        }
        
        function savePayrollSettings() {
            companySettings.defaultPF = parseFloat(document.getElementById('defaultPF').value);
            companySettings.defaultESI = parseFloat(document.getElementById('defaultESI').value);
            companySettings.defaultTDS = parseFloat(document.getElementById('defaultTDS').value);
            companySettings.defaultPT = parseFloat(document.getElementById('defaultPT').value);
            
            localStorage.setItem('companySettings', JSON.stringify(companySettings));
            alert('Payroll settings saved successfully!');
        }
        
        function backupData() {
            const backup = {
                employees,
                attendanceRecords,
                monthlyReports,
                savedDays,
                payrollRecords,
                companySettings,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `payroll_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Data backup created successfully!');
        }
        
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        
                        if (confirm('This will replace all current data. Are you sure?')) {
                            employees = backup.employees || [];
                            attendanceRecords = backup.attendanceRecords || {};
                            monthlyReports = backup.monthlyReports || {};
                            savedDays = backup.savedDays || [];
                            payrollRecords = backup.payrollRecords || [];
                            companySettings = backup.companySettings || {};
                            
                            localStorage.setItem('employees', JSON.stringify(employees));
                            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                            localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
                            localStorage.setItem('savedDays', JSON.stringify(savedDays));
                            localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
                            localStorage.setItem('companySettings', JSON.stringify(companySettings));
                            
                            // Sync with Firebase
                            pushEmployeesToFirebase();
                            pushAttendanceToFirebase();
                            pushPayrollToFirebase();
                            
                            // Refresh UI
                            initializeApplication();
                            alert('Data restored successfully!');
                        }
                    } catch (error) {
                        alert('Error restoring data: Invalid backup file');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function clearAllData() {
            if (confirm('This will delete ALL data and cannot be undone. Are you sure?')) {
                if (confirm('This is your final warning. All data will be permanently deleted. Continue?')) {
                    employees = [];
                    attendanceRecords = {};
                    monthlyReports = {};
                    savedDays = [];
                    payrollRecords = [];
                    
                    localStorage.setItem('employees', JSON.stringify(employees));
                    localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
                    localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
                    localStorage.setItem('savedDays', JSON.stringify(savedDays));
                    localStorage.setItem('payrollRecords', JSON.stringify(payrollRecords));
                    
                    // Sync with Firebase
                    pushEmployeesToFirebase();
                    pushAttendanceToFirebase();
                    pushPayrollToFirebase();
                    
                    // Refresh UI
                    initializeApplication();
                    alert('All data has been cleared!');
                }
            }
        }

        // Enhanced Export/Import Functions
        function exportEmployeeData() {
            const data = [
                ['Employee ID', 'Name', 'Gender', 'Date of Birth', 'Department', 'Position', 'Email', 'Phone', 'Address', 'City', 'State', 'Pincode', 'Aadhar', 'PAN', 'Manager', 'Location', 'Salary', 'Salary Type', 'Bank Name', 'Account No', 'IFSC Code', 'Branch', 'PF ID', 'PF UAN', 'Allowances', 'Deductions', 'Tax Identification', 'Status', 'Join Date', 'Education', 'Skills', 'Experience']
            ];
            
            employees.forEach(emp => {
                data.push([
                    emp.id,
                    emp.name,
                    emp.gender,
                    emp.dob,
                    emp.department,
                    emp.position,
                    emp.email,
                    emp.phone,
                    emp.address,
                    emp.city,
                    emp.state,
                    emp.pincode,
                    emp.aadhar,
                    emp.pan,
                    emp.manager,
                    emp.location,
                    emp.salary,
                    emp.salaryType,
                    emp.bankName,
                    emp.accountNo,
                    emp.IFSCCode,
                    emp.branch,
                    emp.PFID,
                    emp.PFUAN,
                    emp.allowances,
                    emp.deductions,
                    emp.taxIdentification,
                    emp.status,
                    emp.joinDate,
                    emp.education,
                    emp.skills,
                    emp.experience
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Employees");
            XLSX.writeFile(wb, `Employee_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        function importEmployeeData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Remove header row
                        jsonData.shift();
                        
                        const importedEmployees = jsonData.map(row => ({
                            id: row[0] || generateEmployeeId(),
                            name: row[1],
                            gender: row[2],
                            dob: row[3],
                            department: row[4],
                            position: row[5],
                            email: row[6],
                            phone: row[7],
                            address: row[8],
                            city: row[9],
                            state: row[10],
                            pincode: row[11],
                            aadhar: row[12],
                            pan: row[13],
                            manager: row[14],
                            location: row[15],
                            salary: parseFloat(row[16]) || 0,
                            salaryType: row[17] || 'monthly',
                            bankName: row[18],
                            accountNo: row[19],
                            IFSCCode: row[20],
                            branch: row[21],
                            PFID: row[22],
                            PFUAN: row[23],
                            allowances: parseFloat(row[24]) || 0,
                            deductions: parseFloat(row[25]) || 0,
                            taxIdentification: row[26],
                            status: row[27] || 'active',
                            joinDate: row[28],
                            education: row[29],
                            skills: row[30],
                            experience: parseFloat(row[31]) || 0,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }));
                        
                        if (confirm(`Import ${importedEmployees.length} employees? This will add them to your current employee list.`)) {
                            employees = [...employees, ...importedEmployees];
                            localStorage.setItem('employees', JSON.stringify(employees));
                            
                            // Sync with Firebase
                            pushEmployeesToFirebase();
                            
                            // Refresh UI
                            renderEmployeeTable();
                            populatePayrollEmployeeDropdown();
                            populateReportEmployeeDropdown();
                            loadDashboardData();
                            alert('Employees imported successfully!');
                        }
                    } catch (error) {
                        alert('Error importing data: Invalid file format');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            input.click();
        }

        // Attendance Report Functions
        function generateAttendanceReport() {
            const employeeId = document.getElementById('reportEmployeeSelect').value;
            const month = document.getElementById('reportMonthSelect').value;
            
            if (!month) {
                alert('Please select a month');
                return;
            }
            
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            
            let reportEmployees = employees;
            if (employeeId) {
                reportEmployees = employees.filter(emp => emp.id === employeeId);
            }
            
            let reportHtml = `
                <h3>Attendance Report for ${monthName} ${year}</h3>
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Late</th>
                            <th>Leave</th>
                            <th>Half Day</th>
                            <th>Attendance %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            reportEmployees.forEach(emp => {
                let present = 0, absent = 0, late = 0, leave = 0, halfday = 0;
                
                Object.keys(attendanceRecords).forEach(date => {
                    if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                        if (attendanceRecords[date][emp.id]) {
                            const record = attendanceRecords[date][emp.id];
                            if (record.status === 'present') present++;
                            else if (record.status === 'absent') absent++;
                            else if (record.status === 'late') late++;
                            else if (record.status === 'leave') leave++;
                            else if (record.status === 'halfday') halfday++;
                        } else {
                            absent++;
                        }
                    }
                });
                
                const totalDays = present + absent + late + leave + halfday;
                const attendancePercentage = totalDays > 0 ? ((present + (halfday / 2)) / totalDays * 100).toFixed(2) : 0;
                
                reportHtml += `
                    <tr>
                        <td>${emp.id}</td>
                        <td>${emp.name}</td>
                        <td>${emp.department}</td>
                        <td>${present}</td>
                        <td>${absent}</td>
                        <td>${late}</td>
                        <td>${leave}</td>
                        <td>${halfday}</td>
                        <td>${attendancePercentage}%</td>
                    </tr>
                `;
            });
            
            reportHtml += '</tbody></table>';
            document.getElementById('attendance-report-container').innerHTML = reportHtml;
        }
        
        function exportAttendanceReport() {
            const employeeId = document.getElementById('reportEmployeeSelect').value;
            const month = document.getElementById('reportMonthSelect').value;
            
            if (!month) {
                alert('Please select a month');
                return;
            }
            
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            
            let reportEmployees = employees;
            if (employeeId) {
                reportEmployees = employees.filter(emp => emp.id === employeeId);
            }
            
            const data = [
                ['Employee ID', 'Name', 'Department', 'Present', 'Absent', 'Late', 'Leave', 'Half Day', 'Attendance %']
            ];
            
            reportEmployees.forEach(emp => {
                let present = 0, absent = 0, late = 0, leave = 0, halfday = 0;
                
                Object.keys(attendanceRecords).forEach(date => {
                    if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                        if (attendanceRecords[date][emp.id]) {
                            const record = attendanceRecords[date][emp.id];
                            if (record.status === 'present') present++;
                            else if (record.status === 'absent') absent++;
                            else if (record.status === 'late') late++;
                            else if (record.status === 'leave') leave++;
                            else if (record.status === 'halfday') halfday++;
                        } else {
                            absent++;
                        }
                    }
                });
                
                const totalDays = present + absent + late + leave + halfday;
                const attendancePercentage = totalDays > 0 ? ((present + (halfday / 2)) / totalDays * 100).toFixed(2) : 0;
                
                data.push([
                    emp.id,
                    emp.name,
                    emp.department,
                    present,
                    absent,
                    late,
                    leave,
                    halfday,
                    attendancePercentage
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");
            XLSX.writeFile(wb, `Attendance_Report_${monthName}_${year}.xlsx`);
        }
        
        function viewAttendanceAnalytics() {
            const month = document.getElementById('reportMonthSelect').value;
            
            if (!month) {
                alert('Please select a month');
                return;
            }
            
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            
            let present = 0, absent = 0, late = 0, leave = 0, halfday = 0;
            
            Object.keys(attendanceRecords).forEach(date => {
                if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    Object.values(attendanceRecords[date]).forEach(record => {
                        if (record.status === 'present') present++;
                        else if (record.status === 'absent') absent++;
                        else if (record.status === 'late') late++;
                        else if (record.status === 'leave') leave++;
                        else if (record.status === 'halfday') halfday++;
                    });
                }
            });
            
            const total = present + absent + late + leave + halfday;
            
            const analyticsHtml = `
                <h3>Attendance Analytics for ${monthName} ${year}</h3>
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--success-color);">${present}</div>
                        <div>Present</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--danger-color);">${absent}</div>
                        <div>Absent</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--warning-color);">${late}</div>
                        <div>Late</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--leave-color);">${leave}</div>
                        <div>Leave</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: var(--halfday-color);">${halfday}</div>
                        <div>Half Day</div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold;">Total Attendance Markings: ${total}</div>
                </div>
            `;
            
            document.getElementById('attendance-report-container').innerHTML = analyticsHtml;
        }

        // Make functions available globally
        window.editEmployee = editEmployee;
        window.deleteEmployee = deleteEmployee;
        window.showSection = showSection;
        window.switchEmployeeTab = switchEmployeeTab;
        window.toggleAttendance = toggleAttendance;
        window.markAttendanceWithTime = markAttendanceWithTime;
        window.updateAttendanceRemarks = updateAttendanceRemarks;
        window.openMonthlyRecords = openMonthlyRecords;
        window.closeMonthlyRecords = closeMonthlyRecords;
        window.downloadMonthlyRecords = downloadMonthlyRecords;
        window.clearCurrentMonthRecords = clearCurrentMonthRecords;
        window.viewEmployeeDetails = viewEmployeeDetails;
        window.closeEmployeeDetails = closeEmployeeDetails;
        window.downloadEmployeeDetails = downloadEmployeeDetails;
        window.editEmployeeAttendance = editEmployeeAttendance;
        window.filterEmployeeDetailsByMonth = filterEmployeeDetailsByMonth;
        window.setTodayDate = setTodayDate;
        window.filterAttendanceByStatus = filterAttendanceByStatus;
        window.markAllPresent = markAllPresent;
        window.markAllAbsent = markAllAbsent;
        window.openBulkAttendance = openBulkAttendance;
        window.closeBulkAttendance = closeBulkAttendance;
        window.applyBulkAttendance = applyBulkAttendance;
        window.loadEmployeePayrollData = loadEmployeePayrollData;
        window.savePayrollRecord = savePayrollRecord;
        window.refreshPayrollHistory = refreshPayrollHistory;
        window.generateEmployeeReport = generateEmployeeReport;
        window.generatePayrollReport = generatePayrollReport;
        window.exportEmployeeReport = exportEmployeeReport;
        window.exportPayrollReport = exportPayrollReport;
        window.saveCompanySettings = saveCompanySettings;
        window.savePayrollSettings = savePayrollSettings;
        window.backupData = backupData;
        window.restoreData = restoreData;
        window.clearAllData = clearAllData;
        window.exportEmployeeData = exportEmployeeData;
        window.importEmployeeData = importEmployeeData;
        window.generateAttendanceReport = generateAttendanceReport;
        window.exportAttendanceReport = exportAttendanceReport;
        window.viewAttendanceAnalytics = viewAttendanceAnalytics;
        window.filterEmployeesByStatus = filterEmployeesByStatus;
        window.refreshEmployeeData = function() {
            renderEmployeeTable();
        };
        window.generateReports = function() {
            showSection('reports');
        };
    </script>
</body>
</html>
