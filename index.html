<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayrollPro HR System</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --danger-color: #e74c3c;
            --warning-color: #f8961e;
            --info-color: #4895ef;
            --edit-color: #7209b7;
            --leave-color: #3a86ff;
            --halfday-color: #ffbe0b;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: #ffffff;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Login Page Styles */
        .login-container {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        
        .login-box {
            background-color: #2ecc71;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 400px;
            max-width: 90%;
            transition: all 0.3s ease;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            font-size: 24px;
            position: relative;
        }
        
        .login-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            width: 100%;
            max-width: 300px;
            text-align: left;
            color: white;
        }
        
        .form-group input {
            width: 100%;
            max-width: 300px;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            border-color: #27ae60;
            outline: none;
        }
        
        .form-group button {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            background-color: #27ae60;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .form-group button:hover {
            background-color: #219653;
        }
        
        .toggle-form {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            width: 100%;
            color: white;
        }
        
        .toggle-form a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .toggle-form a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
            width: 100%;
            max-width: 300px;
            text-align: left;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, var(--dark-color) 0%, #343a40 100%);
            color: white;
            padding: 25px 0;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }
        
        .sidebar-header {
            padding: 0 25px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h2 {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .sidebar-header h2 i {
            margin-right: 12px;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 14px 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            margin: 5px 0;
            position: relative;
            font-weight: 500;
            color: white;
            text-decoration: none;
        }
        
        .menu-item:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: var(--primary-color);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: white;
        }
        
        .menu-item i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            background-color: #f5f7ff;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            font-size: 2rem;
            color: var(--dark-color);
            font-weight: 700;
            display: flex;
            align-items: center;
        }
        
        .header h1 i {
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }
        
        .user-info:hover {
            transform: translateY(-2px);
        }
        
        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        
        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: none;
            border-radius: 8px;
            background: white;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            font-size: 0.95rem;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #dee2e6;
            color: #495057;
        }
        
        .btn-outline:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }
        
        .btn-success:hover {
            background-color: #3aa8d8;
            transform: translateY(-2px);
            color: white !important;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
            box-shadow: 0 4px 15px rgba(248, 150, 30, 0.3);
        }
        
        .btn-warning:hover {
            background-color: #e07e0c;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-info:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-edit {
            background-color: var(--edit-color);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(114, 9, 183, 0.3);
        }
        
        .btn-edit:hover {
            background-color: #5a0891;
            transform: translateY(-2px);
            color: white;
        }
        
        .btn-leave {
            background-color: var(--leave-color);
            color: white;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
        }
        
        .btn-leave:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        
        .btn-halfday {
            background-color: var(--halfday-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 190, 11, 0.3);
        }
        
        .btn-halfday:hover {
            background-color: #eab308;
            transform: translateY(-2px);
        }
        
        /* Data Table Styles */
        .data-table {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-top: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .table-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f3f5;
        }
        
        .table-title {
            font-size: 1.25rem;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
            width: max-content;
        }
        
        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f3f5;
            white-space: nowrap;
        }
        
        th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        tr:not(:last-child) {
            border-bottom: 1px solid #f1f3f5;
        }
        
        tr:hover {
            background-color: #f8fafd;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status.active {
            background-color: #e6fcf5;
            color: #12b886;
        }
        
        .status.inactive {
            background-color: #fff3bf;
            color: #f08c00;
        }
        
        .status-present {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .status-absent {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .status-late {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .status-leave {
            color: var(--leave-color);
            font-weight: bold;
        }
        
        .status-halfday {
            color: var(--halfday-color);
            font-weight: bold;
        }
        
        .late-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 5px;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }
        
        /* Employee Form Styles */
        .form-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            display: none;
        }
        
        .form-title {
            font-size: 1.25rem;
            margin-bottom: 20px;
            color: var(--dark-color);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .form-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid #f1f3f5;
            margin-top: 20px;
        }
        
        /* Alert/Notification Styles */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            background-color: white;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-color);
        }
        
        .alert-info {
            background-color: #f8f9fa;
            border-left-color: var(--info-color);
        }
        
        /* Card Styles */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }
        
        .card-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f3f5;
        }
        
        .card-title {
            font-size: 1.25rem;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Layout Styles */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 0 15px;
        }
        
        .col-md-4 {
            flex: 0 0 33.33%;
            max-width: 33.33%;
            padding: 0 15px;
        }
        
        .col-md-12 {
            flex: 0 0 100%;
            max-width: 100%;
            padding: 0 15px;
        }
        
        /* Employee Info Container */
        .employee-info-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .employee-selection-card {
            flex: 1;
        }
        
        .employee-details-card {
            flex: 1.5;
        }
        
        /* Summary Card Styles */
        .summary-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            height: 100%;
        }
        
        .summary-title {
            font-size: 1rem;
            color: var(--dark-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #f1f3f5;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .summary-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 15px 0;
        }
        
        .summary-details {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .summary-details li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #f1f3f5;
            font-size: 0.95rem;
        }
        
        .summary-details li:last-child {
            border-bottom: none;
        }
        
        .highlight {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        /* Attendance Summary Styles */
        .attendance-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        .summary-item {
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* Date Selector */
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Hide salary summary initially */
        #salarySummarySection {
            display: none;
        }
        
        /* Page Sections */
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        /* Employee Details Modal */
        #employee-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #employee-details-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .employee-info-container {
                flex-direction: column;
            }
            
            .col-md-6, .col-md-4 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .attendance-summary {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .summary-item {
                flex: 1 1 45%;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        /* Firebase Sync Styles - Minimal additions */
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .sync-status.syncing {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .sync-status.synced {
            background-color: #d1edff;
            color: #0c5460;
        }
        
        .sync-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .sync-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    
</head>
<body>
    <!-- Login Page (Initially shown) -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <!-- Login Form -->
            <div id="login-form">
                <div class="login-title">Samkitec Resources</div>
                <h2>Login</h2>
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                    <div class="error-message" id="login-email-error"></div>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                    <div class="error-message" id="login-password-error"></div>
                </div>
                <div class="form-group">
                    <button onclick="login()">Login</button>
                </div>
                <div class="toggle-form">
                    Don't have an account? <a id="show-signup">Sign up</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <div class="login-title">Samkitec Resources</div>
                <h2>Sign Up</h2>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                    <div class="error-message" id="signup-email-error"></div>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password">
                    <div class="error-message" id="signup-password-error"></div>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" placeholder="Confirm your password">
                    <div class="error-message" id="confirm-password-error"></div>
                </div>
                <div class="form-group">
                    <button onclick="signUp()">Sign Up</button>
                </div>
                <div class="toggle-form">
                    Already have an account? <a id="show-login">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (Initially hidden) -->
    <div id="app-container" class="container" style="display: none;">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-calculator"></i> PayrollPro</h2>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="menu-item" onclick="showSection('employees')">
                    <i class="fas fa-users"></i> Employees
                </a>
                <a href="#" class="menu-item" onclick="showSection('payroll')">
                    <i class="fas fa-money-bill-wave"></i> Payroll
                </a>
                <a href="#" class="menu-item" onclick="showSection('attendance')">
                    <i class="fas fa-clipboard-check"></i> Attendance
                </a>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Employees Section -->
            <div id="employees" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-users"></i> Employee Management</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button id="sync-employees-btn" class="btn btn-info sync-btn">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <div id="sync-employees-status" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>                   
                    </div>
                </div>
                
                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="employeeSearch" class="search-input" placeholder="Search employees...">
                    </div>
                    <div class="btn-group">
                        <button id="addEmployeeBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Employee
                        </button>
                    </div>
                </div>
                
                <!-- Employee Form -->
                <div id="employeeForm" class="form-container">
                    <div class="form-title">
                        <i class="fas fa-user-edit"></i> Employee Details
                    </div>
                    <form id="employeeDataForm">
                        <input type="hidden" id="employeeId">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empId">Employee ID *</label>
                                <input type="text" id="empId" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empName">Full Name *</label>
                                <input type="text" id="empName" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empDepartment">Department *</label>
                                <select id="empDepartment" class="form-control" required>
                                    <option value="">Select Department</option>
                                    <option value="HR">HR</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Operations">Operations</option>
                                    <option value="IT">IT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empPosition">Position *</label>
                                <input type="text" id="empPosition" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empEmail">Email *</label>
                                <input type="email" id="empEmail" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empPhone">Phone *</label>
                                <input type="tel" id="empPhone" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empLocation">Location *</label>
                                <input type="text" id="empLocation" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empSalary">Base Salary (â‚¹) *</label>
                                <input type="number" id="empSalary" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empBankName">Bank Name *</label>
                                <input type="text" id="empBankName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empAccountNo">Account No. *</label>
                                <input type="number" id="empAccountNo" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empIFSCCode">IFSC Code *</label>
                                <input type="text" id="empIFSCCode" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empPFID">PF ID *</label>
                                <input type="text" id="empPFID" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empPFUAN">PF UAN *</label>
                                <input type="text" id="empPFUAN" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empAllowances">Allowances *</label>
                                <input type="number" id="empAllowances" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empDeductions">Deductions *</label>
                                <input type="number" id="empDeductions" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="empTaxIdentification">Tax identification *</label>
                                <input type="text" id="empTaxIdentification" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="empStatus">Employment Status *</label>
                                <select id="empStatus" class="form-control" required>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="empJoinDate">Join Date *</label>
                                <input type="date" id="empJoinDate" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="cancelEmployeeBtn" class="btn btn-outline">Cancel</button>
                            <button type="submit" id="saveEmployeeBtn" class="btn btn-primary">Save Employee</button>
                        </div>
                    </form>
                </div>
                
                <!-- Employee Data Table -->
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">Employee Records</div>
                        <div class="table-actions">
                            <div class="btn-group">
                                <button class="btn btn-outline btn-sm">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                                <button class="btn btn-outline btn-sm">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Location</th>
                                <th>Bank Name</th>
                                <th>PF ID</th>
                                <th>PF UAN</th>
                                <th>Salary</th>
                                <th>Allowance</th>
                                <th>Deduction</th>
                                <th>Account No.</th>
                                <th>IFSC Code</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <!-- Employee data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Payroll Section -->
            <div id="payroll" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-money-bill-wave"></i> Payroll Processing</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button id="sync-payroll-btn" class="btn btn-info sync-btn">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <div id="sync-payroll-status" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info" id="payrollAlert">
                    <!-- Content will be filled by JavaScript -->
                </div>

                <!-- Employee Selection and Details - Side by Side Layout -->
                <div class="employee-info-container">
                    <!-- Employee Selection Card -->
                    <div class="card employee-selection-card">
                        <div class="card-header">
                            <h3 class="card-title">Employee Selection</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select Employee</label>
                                <select class="form-control" id="employeeSelect">
                                    <option value="">-- Select Employee --</option>
                                    <!-- Options will be filled by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Pay Period</label>
                                <select class="form-control" id="payPeriodSelect">
                                    <!-- Options will be filled by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Date</label>
                                <input type="date" class="form-control" id="paymentDate" value="">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Details Card -->
                    <div class="card employee-details-card">
                        <div class="card-header">
                            <h3 class="card-title">Employee Details</h3>
                            <button id="editEmployeeBtn" class="btn btn-edit">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                        <div class="card-body" id="employeeDetailsSection">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Employee ID</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeId" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeName" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control employee-input" id="payrollEmployeeEmail" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Phone</label>
                                        <input type="tel" class="form-control employee-input" id="payrollEmployeePhone" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Joining Date</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeJoiningDate" value="" disabled>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Department</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeDept" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Position</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeePosition" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeLocation" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Bank Name</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeBankName" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Account Number</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeBankAccount" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">IFSC Code</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeeIFSC" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">PF ID</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeePFID" value="" disabled>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">PF UAN</label>
                                        <input type="text" class="form-control employee-input" id="payrollEmployeePFUAN" value="" disabled>
                                    </div>
                                </div>
                            </div>
                            <div id="employeeActionBtns" style="display: none;">
                                <button id="saveEmployeeBtn" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button id="cancelEmployeeBtn" class="btn btn-primary">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Salary Components</h3>
                                <button id="editSalaryBtn" class="btn btn-edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                            <div class="card-body" id="salarySection">
                                <div class="form-group">
                                    <label class="form-label">Basic Salary</label>
                                    <input type="number" class="form-control salary-input" id="basicSalary" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Allowances</label>
                                    <input type="number" class="form-control salary-input" id="allowances" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Gross</label>
                                    <input type="number" class="form-control salary-input" id="gross" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Actual Gross</label>
                                    <input type="number" class="form-control salary-input" id="actualGross" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Total Days</label>
                                    <input type="number" class="form-control salary-input" id="totalDays" value="30" disabled>
                                </div>
                                
                                <div id="salaryActionBtns" style="display: none;">
                                    <button id="saveSalaryBtn" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button id="cancelSalaryBtn" class="btn btn-primary">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Deductions</h3>
                                <button id="editDeductionsBtn" class="btn btn-edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                            <div class="card-body" id="deductionsSection">
                                <div class="form-group">
                                    <label class="form-label">Absent Days</label>
                                    <input type="number" class="form-control deduction-input" id="absentDays" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Half Day</label>
                                    <input type="number" class="form-control deduction-input" id="halfDay" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Advance Deduction</label>
                                    <input type="number" class="form-control deduction-input" id="advanceDeduction" value="0" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">TDS</label>
                                    <input type="number" class="form-control deduction-input" id="tds" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">PF</label>
                                    <input type="number" class="form-control deduction-input" id="pf" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ESI</label>
                                    <input type="number" class="form-control deduction-input" id="esi" value="" disabled>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">PT</label>
                                    <input type="number" class="form-control deduction-input" id="pt" value="" disabled>
                                </div>
                                
                                <div id="deductionsActionBtns" style="display: none;">
                                    <button id="saveDeductionsBtn" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button id="cancelDeductionsBtn" class="btn btn-primary">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>

                                <!-- Submit Button -->
                                <button id="submitPayrollBtn" class="btn btn-submit">
                                    <i class="fas fa-calculator"></i> Calculate & Generate Salary Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Salary Summary Section (Initially Hidden) -->
                <div id="salarySummarySection">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Salary Summary</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <h4 class="summary-title">Allowances</h4>
                                                <ul class="summary-details">
                                                    <li>
                                                        <span>Basic Salary</span>
                                                        <span id="displayBasic">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Allowances</span>
                                                        <span id="displayAllowances">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Gross</span>
                                                        <span id="displayGross">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>Actual Gross</span>
                                                        <span id="displayActualGross">â‚¹0.00</span>
                                                    </li>
                                                    <li class="highlight">
                                                        <span>Total Earnings</span>
                                                        <span id="displayTotalEarnings">â‚¹0.00</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <h4 class="summary-title">Deductions</h4>
                                                <ul class="summary-details">
                                                    <li>
                                                        <span>Absent Days</span>
                                                        <span id="displayAbsentDays">0</span>
                                                    </li>
                                                    <li>
                                                        <span>Half Day</span>
                                                        <span id="displayHalfDay">0</span>
                                                    </li>
                                                    <li>
                                                        <span>Advance Deduction</span>
                                                        <span id="displayAdvance">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>TDS</span>
                                                        <span id="displayTDS">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>PF</span>
                                                        <span id="displayPF">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>ESI</span>
                                                        <span id="displayESI">â‚¹0.00</span>
                                                    </li>
                                                    <li>
                                                        <span>PT</span>
                                                        <span id="displayPT">â‚¹0.00</span>
                                                    </li>
                                                    <li class="highlight">
                                                        <span>Total Deductions</span>
                                                        <span id="displayTotalDeductions">â‚¹0.00</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="summary-card">
                                                <h4 class="summary-title">Net Salary</h4>
                                                <div class="summary-value" id="displayNet">â‚¹0.00</div>
                                                <div class="form-group">
                                                    <label class="form-label">Payment Method</label>
                                                    <select class="form-control">
                                                        <option>Bank Transfer</option>
                                                        <option>Check</option>
                                                        <option>Cash</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Bank Account</label>
                                                    <input type="text" class="form-control" placeholder="Account details" value="" disabled>
                                                </div>
                                                <button class="btn btn-success" style="width: 100%;" id="generatePayslipBtn">
                                                    <i class="fas fa-check-circle"></i> Approve & Process Payslip
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Section -->
            <div id="attendance" class="page-section">
                <div class="header">
                    <h1><i class="fas fa-clipboard-check"></i> Employee Attendance System</h1>
                    <div class="user-info">
                        <span id="logged-in-user">Admin User</span>
                        <button id="sync-attendance-btn" class="btn btn-info sync-btn">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <div id="sync-attendance-status" class="sync-status synced">
                            <i class="fas fa-check-circle"></i> Synced
                        </div>
                        <button onclick="logout()" class="btn btn-danger" style="margin-left: 10px; padding: 5px 10px;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Attendance Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daily Attendance</h3>
                        <button class="btn btn-info" onclick="openMonthlyRecords()">
                            <i class="fas fa-calendar-alt"></i> Monthly Records
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="date-selector">
                            <label class="form-label">Select Date:</label>
                            <input type="date" class="form-control" id="attendance-date" style="max-width: 200px;">
                        </div>
                        
                        <div class="search-container">
                            <input type="text" class="form-control" id="employee-search" placeholder="Search employees...">
                        </div>
                        
                        <button id="save-attendance-btn" class="btn btn-success" style="margin-bottom: 20px;">
                            <i class="fas fa-save"></i> Save Today's Attendance
                        </button>
                        
                        <div class="table-container">
                            <table id="attendance-table">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-list">
                                    <!-- Attendance records will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="attendance-summary">
                            <div class="summary-item">
                                <div class="summary-value" id="present-count">0</div>
                                <div class="summary-label">Present</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="absent-count">0</div>
                                <div class="summary-label">Absent</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="late-count">0</div>
                                <div class="summary-label">Late Arrivals</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="leave-count">0</div>
                                <div class="summary-label">Paid Leaves</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="halfday-count">0</div>
                                <div class="summary-label">Half Days</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="total-count">0</div>
                                <div class="summary-label">Total Employees</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Records Modal -->
    <div id="monthly-records-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt"></i> Monthly Attendance Records</h2>
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="downloadMonthlyRecords()">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button class="btn btn-danger" onclick="closeMonthlyRecords()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label class="form-label">Select Month: </label>
                <input type="month" class="form-control" id="month-select" onchange="loadMonthlyRecords()" style="max-width: 200px; display: inline-block;">
                <button class="btn btn-danger" onclick="clearCurrentMonthRecords()" style="margin-left: 20px;">
                    <i class="fas fa-trash"></i> Clear This Month's Records
                </button>
            </div>
            
            <div class="table-container">
                <div id="monthly-records-container">
                    <!-- Monthly records will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Details Modal -->
    <div id="employee-details-modal" class="modal">
        <div class="modal-content" id="employee-details-content">
            <div class="modal-header">
                <h2><i class="fas fa-user"></i> Employee Attendance Details</h2>
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="downloadEmployeeDetails()">
                        <i class="fas fa-download"></i> Download Excel
                    </button>
                    <button class="btn btn-danger" onclick="closeEmployeeDetails()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Employee ID</label>
                        <input type="text" class="form-control" id="detail-employee-id" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="detail-employee-name" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Month</label>
                        <input type="month" class="form-control" id="detail-month-select" onchange="filterEmployeeDetailsByMonth()">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <input type="text" class="form-control" id="detail-employee-dept" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Position</label>
                        <input type="text" class="form-control" id="detail-employee-position" disabled>
                    </div>
                    <div class="form-group" style="text-align: right; margin-top: 25px;">
                        <button class="btn btn-primary" onclick="editEmployeeAttendance()">
                            <i class="fas fa-edit"></i> Edit Attendance
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3 class="card-title">Attendance Summary</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="summary-card">
                                <h4 class="summary-title">Attendance Counts</h4>
                                <ul class="summary-details">
                                    <li>
                                        <span>Present Days</span>
                                        <span id="detail-present-days">0</span>
                                    </li>
                                    <li>
                                        <span>Absent Days</span>
                                        <span id="detail-absent-days">0</span>
                                    </li>
                                    <li>
                                        <span>Late Arrivals</span>
                                        <span id="detail-late-days">0</span>
                                    </li>
                                    <li>
                                        <span>Paid Leaves</span>
                                        <span id="detail-leave-days">0</span>
                                    </li>
                                    <li>
                                        <span>Half Days</span>
                                        <span id="detail-halfday-days">0</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="summary-card">
                                <h4 class="summary-title">Calculated Values</h4>
                                <ul class="summary-details">
                                    <li>
                                        <span>Total Days Present</span>
                                        <span id="detail-total-present">0</span>
                                    </li>
                                    <li>
                                        <span>Total Days Absent</span>
                                        <span id="detail-total-absent">0</span>
                                    </li>
                                    <li>
                                        <span>Half Days Left</span>
                                        <span id="detail-halfday-left">Null</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="summary-card">
                                <h4 class="summary-title">Attendance Records</h4>
                                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="detail-attendance-records">
                                            <!-- Attendance records will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Employee Data Management
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        
        // Attendance Data Management
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || {};
        let monthlyReports = JSON.parse(localStorage.getItem('monthlyReports')) || {};
        let savedDays = JSON.parse(localStorage.getItem('savedDays')) || [];
        
        // DOM Elements for Employee Management
        const employeeElements = {
            form: document.getElementById('employeeForm'),
            formFields: {
                id: document.getElementById('employeeId'),
                empId: document.getElementById('empId'),
                name: document.getElementById('empName'),
                department: document.getElementById('empDepartment'),
                position: document.getElementById('empPosition'),
                email: document.getElementById('empEmail'),
                phone: document.getElementById('empPhone'),
                location: document.getElementById('empLocation'),
                salary: document.getElementById('empSalary'),
                bankName: document.getElementById('empBankName'),
                accountNo: document.getElementById('empAccountNo'),
                IFSCCode: document.getElementById('empIFSCCode'),
                PFID: document.getElementById('empPFID'),
                PFUAN: document.getElementById('empPFUAN'),
                allowances: document.getElementById('empAllowances'),
                deductions: document.getElementById('empDeductions'),
                taxIdentification: document.getElementById('empTaxIdentification'),
                status: document.getElementById('empStatus'),
                joinDate: document.getElementById('empJoinDate')
            },
            buttons: {
                add: document.getElementById('addEmployeeBtn'),
                save: document.getElementById('saveEmployeeBtn'),
                cancel: document.getElementById('cancelEmployeeBtn')
            },
            table: {
                body: document.getElementById('employeeTableBody'),
                search: document.getElementById('employeeSearch')
            }
        };

        // Initialize the application
        async function initializeApplication() {
            renderEmployeeTable();
            setupEmployeeEventListeners();
            setupPayrollEventListeners();
            setupAttendanceEventListeners();
            updatePayrollDates();
            
            // Load sample data if empty
            if (employees.length === 0) {
                loadSampleData();
            }
            
            // Populate employee dropdown in payroll section
            populatePayrollEmployeeDropdown();
            
            // Set today's date as default for attendance
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            document.getElementById('attendance-date').value = todayFormatted;
            
            // Set current month as default for attendance
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('month-select').value = currentMonth;
            
            // Show employees section by default
            showSection('employees');
            
            // Render initial attendance list
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
            updateAttendanceSaveButtonState();
            
            // Sync with Firebase
            syncEmployeesWithFirebase();
            syncAttendanceWithFirebase();
        }

        // Firebase Sync Functions - UPDATED FOR v9
async async function syncEmployeesFromFirebase() {
    if (!currentUserId) return;

    try {
        updateSyncStatus('employees', 'syncing');
        
        const employeesRef = collection(db, 'users', currentUserId, 'employees');
        const snapshot = await getDocs(employeesRef);
        
        if (!snapshot.empty) {
            const firebaseEmployees = [];
            snapshot.forEach(docSnap => {
                firebaseEmployees.push({ id: docSnap.id, ...docSnap.data() });
            });
            
            window.employees = firebaseEmployees;
            localStorage.setItem('employees', JSON.stringify(firebaseEmployees));
            
            if (typeof renderEmployeeTable === 'function') renderEmployeeTable();
            if (typeof populatePayrollEmployeeDropdown === 'function') populatePayrollEmployeeDropdown();
            
            console.log(`âœ… Synced ${firebaseEmployees.length} employees from Firebase`);
            updateSyncStatus('employees', 'synced');
        } else {
            console.log("â„¹ï¸ No employees in Firebase yet");
            updateSyncStatus('employees', 'synced');
        }
        
    } catch (error) {
        console.error("âŒ Error syncing employees:", error);
        updateSyncStatus('employees', 'error');
    }
}

                
                // If Firebase has data, use it (Firebase as source of truth)
                if (firebaseEmployees.length > 0) {
                    employees = firebaseEmployees;
                    localStorage.setItem('employees', JSON.stringify(employees));
                    renderEmployeeTable();
                    populatePayrollEmployeeDropdown();
                    updateSyncStatus('employees', 'synced');
                } else {
                    // If no data in Firebase, push local data to Firebase
                    await pushEmployeesToFirebase();
                    updateSyncStatus('employees', 'synced');
                }
            } catch (error) {
                console.error('Error syncing employees with Firebase:', error);
                updateSyncStatus('employees', 'error');
            }
        }

       async async function pushEmployeesToFirebase() {
    if (!currentUserId) {
        console.error("âŒ No user logged in");
        return;
    }

    if (!window.employees || window.employees.length === 0) {
        console.log("â„¹ï¸ No employees to push");
        return;
    }

    try {
        updateSyncStatus('employees', 'syncing');
        
        const employeesRef = collection(db, 'users', currentUserId, 'employees');
        
        for (const employee of window.employees) {
            const employeeDocRef = doc(employeesRef, employee.id);
            await setDoc(employeeDocRef, employee, { merge: true });
        }
        
        console.log(`âœ… Pushed ${window.employees.length} employees to Firebase`);
        updateSyncStatus('employees', 'synced');
        
    } catch (error) {
        console.error("âŒ Error pushing employees:", error);
        updateSyncStatus('employees', 'error');
        alert("âš ï¸ Failed to sync employees: " + error.message);
    }
}


              updateSyncStatus('attendance', 'syncing');
                
                // Get attendance from Firebase
              async async function syncAttendanceFromFirebase() {
    if (!currentUserId) return;

    try {
        updateSyncStatus('attendance', 'syncing');
        
        const attendanceRef = collection(db, 'users', currentUserId, 'attendance');
        const snapshot = await getDocs(attendanceRef);
        
        if (!snapshot.empty) {
            const firebaseAttendance = {};
            snapshot.forEach(docSnap => {
                firebaseAttendance[docSnap.id] = docSnap.data();
            });
            
            window.attendanceRecords = firebaseAttendance;
            localStorage.setItem('attendanceRecords', JSON.stringify(firebaseAttendance));
            
            console.log(`âœ… Synced ${Object.keys(firebaseAttendance).length} attendance records`);
            updateSyncStatus('attendance', 'synced');
        } else {
            console.log("â„¹ï¸ No attendance records in Firebase yet");
            updateSyncStatus('attendance', 'synced');
        }
        
    } catch (error) {
        console.error("âŒ Error syncing attendance:", error);
        updateSyncStatus('attendance', 'error');
    }
}


       async async function pushAttendanceToFirebase() {
    if (!currentUserId) {
        console.error("âŒ No user logged in");
        return;
    }

    if (!window.attendanceRecords || Object.keys(window.attendanceRecords).length === 0) {
        console.log("â„¹ï¸ No attendance to push");
        return;
    }

    try {
        updateSyncStatus('attendance', 'syncing');
        
        const attendanceRef = collection(db, 'users', currentUserId, 'attendance');
        
        for (const date in window.attendanceRecords) {
            const attendanceDocRef = doc(attendanceRef, date);
            await setDoc(attendanceDocRef, window.attendanceRecords[date], { merge: true });
        }
        
        console.log(`âœ… Pushed ${Object.keys(window.attendanceRecords).length} attendance records`);
        updateSyncStatus('attendance', 'synced');
        
    } catch (error) {
        console.error("âŒ Error pushing attendance:", error);
        updateSyncStatus('attendance', 'error');
        alert("âš ï¸ Failed to sync attendance: " + error.message);
    }
}


        async function updateSyncStatus(section, status) {
            const statusElement = document.getElementById(`sync-${section}-status`);
            const icon = statusElement.querySelector('i');
            
            statusElement.className = `sync-status ${status}`;
            
            switch(status) {
                case 'syncing':
                    icon.className = 'fas fa-sync fa-spin';
                    statusElement.innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...';
                    break;
                case 'synced':
                    icon.className = 'fas fa-check-circle';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Synced';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-triangle';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sync Error';
                    break;
            }
        }

        // Navigation between sections
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update active menu item
            document.querySelectorAll('.sidebar-menu .menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the corresponding menu item
            const menuItem = document.querySelector(`.sidebar-menu .menu-item[onclick="showSection('${sectionId}')"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Special handling for attendance section
            if (sectionId === 'attendance') {
                renderEmployeeAttendanceList();
                updateAttendanceSummary();
                updateAttendanceSaveButtonState();
            }
        }

        // Setup event listeners for employee management
        function setupEmployeeEventListeners() {
            // Add employee button
            employeeElements.buttons.add.addEventListener('click', showEmployeeForm);
            
            // Cancel button
            employeeElements.buttons.cancel.addEventListener('click', hideEmployeeForm);
            
            // Save button - using form submission
            document.getElementById('employeeDataForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEmployee();
            });
            
            // Search functionality
            employeeElements.table.search.addEventListener('input', filterEmployees);
            
            // Sync button
            document.getElementById('sync-employees-btn').addEventListener('click', function() {
                syncEmployeesWithFirebase();
            });

            // Toggle between login/signup forms
            document.getElementById('show-signup').addEventListener('click', () => {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            });
            
            document.getElementById('show-login').addEventListener('click', () => {
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });
        }

        // Setup event listeners for payroll processing
        function setupPayrollEventListeners() {
            // Employee Details Edit/Save functionality
            document.getElementById('editEmployeeBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#employeeDetailsSection .employee-input');
                inputs.forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('employeeActionBtns').style.display = 'block';
                this.style.display = 'none';
            });
            
            document.getElementById('saveEmployeeBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#employeeDetailsSection .employee-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('employeeActionBtns').style.display = 'none';
                document.getElementById('editEmployeeBtn').style.display = 'block';
                alert('Employee details updated successfully!');
            });
            
            document.getElementById('cancelEmployeeBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#employeeDetailsSection .employee-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('employeeActionBtns').style.display = 'none';
                document.getElementById('editEmployeeBtn').style.display = 'block';
            });
            
            // Edit/Save functionality for Salary Components
            document.getElementById('editSalaryBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#salarySection .salary-input');
                inputs.forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('salaryActionBtns').style.display = 'block';
                this.style.display = 'none';
            });
            
            document.getElementById('saveSalaryBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#salarySection .salary-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('salaryActionBtns').style.display = 'none';
                document.getElementById('editSalaryBtn').style.display = 'block';
                calculateSalary();
            });
            
            document.getElementById('cancelSalaryBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#salarySection .salary-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('salaryActionBtns').style.display = 'none';
                document.getElementById('editSalaryBtn').style.display = 'block';
                calculateSalary();
            });
            
            // Edit/Save functionality for Deductions
            document.getElementById('editDeductionsBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#deductionsSection .deduction-input');
                inputs.forEach(input => {
                    input.disabled = false;
                });
                document.getElementById('deductionsActionBtns').style.display = 'block';
                this.style.display = 'none';
            });
            
            document.getElementById('saveDeductionsBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#deductionsSection .deduction-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('deductionsActionBtns').style.display = 'none';
                document.getElementById('editDeductionsBtn').style.display = 'block';
                calculateSalary();
            });
            
            document.getElementById('cancelDeductionsBtn').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#deductionsSection .deduction-input');
                inputs.forEach(input => {
                    input.disabled = true;
                });
                document.getElementById('deductionsActionBtns').style.display = 'none';
                document.getElementById('editDeductionsBtn').style.display = 'block';
                calculateSalary();
            });

            // Submit button functionality to show salary summary
            document.getElementById('submitPayrollBtn').addEventListener('click', function() {
                calculateSalary();
                document.getElementById('salarySummarySection').style.display = 'block';
                // Scroll to the summary section
                document.getElementById('salarySummarySection').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Add event listener to the payslip generation button
            document.getElementById('generatePayslipBtn').addEventListener('click', generatePayslipPDF);
            
            // Update summary when employee is selected
            document.getElementById('employeeSelect').addEventListener('change', function() {
                const selectedEmployeeId = this.value;
                if (selectedEmployeeId) {
                    const employee = employees.find(emp => emp.id === selectedEmployeeId);
                    if (employee) {
                        updatePayrollEmployeeDetails(employee);
                        updateAttendanceDeductions(employee.id);
                    }
                }
                // Recalculate salary
                calculateSalary();
                // Hide salary summary when changing employee
                document.getElementById('salarySummarySection').style.display = 'none';
            });
            
            // Sync button
            document.getElementById('sync-payroll-btn').addEventListener('click', function() {
                syncEmployeesWithFirebase();
            });
        }

        // Setup event listeners for attendance management
        function setupAttendanceEventListeners() {
            // Date change handler
            document.getElementById('attendance-date').addEventListener('change', function() {
                renderEmployeeAttendanceList();
                updateAttendanceSummary();
                updateAttendanceSaveButtonState();
            });
            
            // Search functionality
            document.getElementById('employee-search').addEventListener('input', function() {
                renderEmployeeAttendanceList();
            });
            
            // Save attendance button handler
            document.getElementById('save-attendance-btn').addEventListener('click', function() {
                const date = document.getElementById('attendance-date').value;
                
                if (!attendanceRecords[date] || Object.keys(attendanceRecords[date]).length === 0) {
                    alert('No attendance data to save for this date');
                    return;
                }
                
                // Mark this day as saved
                if (!savedDays.includes(date)) {
                    savedDays.push(date);
                    localStorage.setItem('savedDays', JSON.stringify(savedDays));
                }
                
                // Update monthly reports
                const [year, month] = date.split('-');
                const monthKey = `${year}-${month}`;
                
                if (!monthlyReports[monthKey]) {
                    monthlyReports[monthKey] = {};
                }
                
                monthlyReports[monthKey][date] = attendanceRecords[date];
                localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
                
                // Sync with Firebase
                pushAttendanceToFirebase();
                
                updateAttendanceSaveButtonState();
                alert('Attendance for ' + date + ' has been saved successfully!');
            });
            
            // Sync button
            document.getElementById('sync-attendance-btn').addEventListener('click', function() {
                syncAttendanceWithFirebase();
            });
        }

        // Show/hide employee form
        function showEmployeeForm() {
            employeeElements.form.style.display = 'block';
            employeeElements.formFields.id.value = '';
            employeeElements.formFields.empId.value = generateEmployeeId();
            employeeElements.formFields.name.focus();
        }

        function hideEmployeeForm() {
            employeeElements.form.style.display = 'none';
            document.getElementById('employeeDataForm').reset();
        }

        // Save employee function
        function saveEmployee() {
            // Validate form
            if (!validateEmployeeForm()) {
                return false;
            }
            
            // Prepare employee data
            const employeeData = {
                id: employeeElements.formFields.empId.value,
                name: employeeElements.formFields.name.value.trim(),
                department: employeeElements.formFields.department.value,
                position: employeeElements.formFields.position.value.trim(),
                email: employeeElements.formFields.email.value.trim(),
                phone: employeeElements.formFields.phone.value.trim(),
                location: employeeElements.formFields.location.value.trim(),
                salary: parseFloat(employeeElements.formFields.salary.value),
                bankName: employeeElements.formFields.bankName.value.trim(),
                accountNo: employeeElements.formFields.accountNo.value.trim(),
                IFSCCode: employeeElements.formFields.IFSCCode.value.trim(),
                PFID: employeeElements.formFields.PFID.value.trim(),
                PFUAN: employeeElements.formFields.PFUAN.value.trim(),
                allowances: parseFloat(employeeElements.formFields.allowances.value),
                deductions: parseFloat(employeeElements.formFields.deductions.value),
                taxIdentification: employeeElements.formFields.taxIdentification.value.trim(),
                status: employeeElements.formFields.status.value,
                joinDate: employeeElements.formFields.joinDate.value
            };
            
            // Check if editing existing employee
            const existingIndex = employees.findIndex(emp => emp.id === employeeData.id);
            
            if (existingIndex >= 0) {
                // Update existing employee
                employees[existingIndex] = employeeData;
                alert('Employee updated successfully!');
            } else {
                // Add new employee
                employees.push(employeeData);
                alert('Employee added successfully!');
            }
            
            // Save to localStorage
            localStorage.setItem('employees', JSON.stringify(employees));
            
            // Sync with Firebase
            pushEmployeesToFirebase();
            
            // Refresh UI
            renderEmployeeTable();
            hideEmployeeForm();
            populatePayrollEmployeeDropdown();
            return true;
        }

        // Form validation
        function validateEmployeeForm() {
            let isValid = true;
            const requiredFields = [
                employeeElements.formFields.empId,
                employeeElements.formFields.name,
                employeeElements.formFields.department,
                employeeElements.formFields.position,
                employeeElements.formFields.email,
                employeeElements.formFields.phone,
                employeeElements.formFields.location,
                employeeElements.formFields.salary,
                employeeElements.formFields.bankName,
                employeeElements.formFields.accountNo,
                employeeElements.formFields.IFSCCode,
                employeeElements.formFields.PFID,
                employeeElements.formFields.PFUAN,
                employeeElements.formFields.allowances,
                employeeElements.formFields.deductions,
                employeeElements.formFields.taxIdentification,
                employeeElements.formFields.joinDate
            ];
            
            // Reset error states
            requiredFields.forEach(field => {
                field.style.borderColor = '';
            });
            
            // Check required fields
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = 'red';
                    isValid = false;
                }
            });
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(employeeElements.formFields.email.value)) {
                employeeElements.formFields.email.style.borderColor = 'red';
                alert('Please enter a valid email address');
                isValid = false;
            }
            
            // Validate salary
            if (isNaN(employeeElements.formFields.salary.value)) {
                employeeElements.formFields.salary.style.borderColor = 'red';
                alert('Please enter a valid salary amount');
                isValid = false;
            }
            
            if (!isValid) {
                alert('Please fill all required fields correctly');
            }
            
            return isValid;
        }

        // Generate unique employee ID
        function generateEmployeeId() {
            return 'EMP-' + Date.now().toString().slice(-6);
        }

        // Render employee table
        async function renderEmployeeTable(data = employees) {
            employeeElements.table.body.innerHTML = '';
            
            if (data.length === 0) {
                employeeElements.table.body.innerHTML = `
                    <tr>
                        <td colspan="17" style="text-align: center; padding: 20px;">
                            No employees found
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.position}</td>
                    <td>${emp.email || 'N/A'}</td>
                    <td>${emp.phone || 'N/A'}</td>
                    <td>${emp.location || 'N/A'}</td>
                    <td>${emp.bankName || 'N/A'}</td>
                    <td>${emp.PFID || 'N/A'}</td>
                    <td>${emp.PFUAN || 'N/A'}</td>
                    <td>â‚¹${emp.salary.toLocaleString('en-IN')}</td>
                    <td>â‚¹${emp.allowances ? emp.allowances.toLocaleString('en-IN') : '0'}</td>
                    <td>â‚¹${emp.deductions ? emp.deductions.toLocaleString('en-IN') : '0'}</td>
                    <td>${emp.accountNo || 'N/A'}</td>
                    <td>${emp.IFSCCode || 'N/A'}</td>
                    <td><span class="status ${emp.status}">${emp.status.charAt(0).toUpperCase() + emp.status.slice(1)}</span></td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editEmployee('${emp.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="deleteEmployee('${emp.id}')" style="color: #f03e3e; border-color: #f03e3e;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                employeeElements.table.body.appendChild(row);
            });
        }

        // Edit employee
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (employee) {
                employeeElements.formFields.id.value = employee.id;
                employeeElements.formFields.empId.value = employee.id;
                employeeElements.formFields.name.value = employee.name;
                employeeElements.formFields.department.value = employee.department;
                employeeElements.formFields.position.value = employee.position;
                employeeElements.formFields.email.value = employee.email || '';
                employeeElements.formFields.phone.value = employee.phone || '';
                employeeElements.formFields.location.value = employee.location || '';
                employeeElements.formFields.salary.value = employee.salary;
                employeeElements.formFields.bankName.value = employee.bankName || '';
                employeeElements.formFields.accountNo.value = employee.accountNo || '';
                employeeElements.formFields.IFSCCode.value = employee.IFSCCode || '';
                employeeElements.formFields.PFID.value = employee.PFID || '';
                employeeElements.formFields.PFUAN.value = employee.PFUAN || '';
                employeeElements.formFields.allowances.value = employee.allowances || '';
                employeeElements.formFields.deductions.value = employee.deductions || '';
                employeeElements.formFields.taxIdentification.value = employee.taxIdentification || '';
                employeeElements.formFields.status.value = employee.status;
                employeeElements.formFields.joinDate.value = employee.joinDate;
                showEmployeeForm();
            }
        }

        // Delete employee
        function deleteEmployee(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                employees = employees.filter(emp => emp.id !== id);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                // Sync with Firebase
                pushEmployeesToFirebase();
                
                renderEmployeeTable();
                populatePayrollEmployeeDropdown();
                alert('Employee deleted successfully!');
            }
        }

        // Filter employees
        function filterEmployees() {
            const searchTerm = employeeElements.table.search.value.toLowerCase();
            const filtered = employees.filter(emp => 
                emp.id.toLowerCase().includes(searchTerm) ||
                emp.name.toLowerCase().includes(searchTerm) ||
                (emp.department && emp.department.toLowerCase().includes(searchTerm)) ||
                (emp.position && emp.position.toLowerCase().includes(searchTerm)) ||
                (emp.email && emp.email.toLowerCase().includes(searchTerm)) ||
                (emp.phone && emp.phone.toLowerCase().includes(searchTerm)) ||
                (emp.location && emp.location.toLowerCase().includes(searchTerm))
            );
            renderEmployeeTable(filtered);
        }

        // Load sample data
        function loadSampleData() {
            employees = [];
            localStorage.setItem('employees', JSON.stringify(employees));
        }

        // Payroll Functions
        function formatCurrency(amount) {
            return 'â‚¹' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        function calculateSalary() {
            // Get all input values
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const allowances = parseFloat(document.getElementById('allowances').value) || 0;
            const gross = parseFloat(document.getElementById('gross').value) || 0;
            const actualGross = parseFloat(document.getElementById('actualGross').value) || 0;
            const totalDays = parseInt(document.getElementById('totalDays').value) || 30;
            
            const absentDays = parseInt(document.getElementById('absentDays').value) || 0;
            const halfDay = parseInt(document.getElementById('halfDay').value) || 0;
            const advanceDeduction = parseFloat(document.getElementById('advanceDeduction').value) || 0;
            const tds = parseFloat(document.getElementById('tds').value) || 0;
            const pf = parseFloat(document.getElementById('pf').value) || 0;
            const esi = parseFloat(document.getElementById('esi').value) || 0;
            const pt = parseFloat(document.getElementById('pt').value) || 0;
            
            // Calculate daily salary
            const dailySalary = actualGross / totalDays;
            
            // Calculate deductions for absent days and half days
            const absentDeduction = absentDays * dailySalary;
            const halfDayDeduction = halfDay * (dailySalary / 2);
            
            // Calculate totals
            const totalEarnings = actualGross;
            const totalDeductions = absentDeduction + halfDayDeduction + advanceDeduction + tds + pf + esi + pt;
            const netSalary = totalEarnings - totalDeductions;
            
            // Update display values with rupee symbol
            document.getElementById('displayBasic').textContent = formatCurrency(basicSalary);
            document.getElementById('displayAllowances').textContent = formatCurrency(allowances);
            document.getElementById('displayGross').textContent = formatCurrency(gross);
            document.getElementById('displayActualGross').textContent = formatCurrency(actualGross);
            document.getElementById('displayTotalEarnings').textContent = formatCurrency(totalEarnings);
            
            document.getElementById('displayAbsentDays').textContent = absentDays;
            document.getElementById('displayHalfDay').textContent = halfDay;
            document.getElementById('displayAdvance').textContent = formatCurrency(advanceDeduction);
            document.getElementById('displayTDS').textContent = formatCurrency(tds);
            document.getElementById('displayPF').textContent = formatCurrency(pf);
            document.getElementById('displayESI').textContent = formatCurrency(esi);
            document.getElementById('displayPT').textContent = formatCurrency(pt);
            document.getElementById('displayTotalDeductions').textContent = formatCurrency(totalDeductions);
            
            document.getElementById('displayNet').textContent = formatCurrency(netSalary);
        }
        
        function updatePayrollDates() {
            const now = new Date();
            const currentMonth = now.toLocaleString('default', { month: 'long' });
            const currentYear = now.getFullYear();
            
            // Calculate next payroll date (15th of next month)
            let nextMonth = now.getMonth() + 1;
            let nextYear = currentYear;
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }
            const nextPayrollDate = new Date(nextYear, nextMonth, 15);
            const nextPayrollMonth = nextPayrollDate.toLocaleString('default', { month: 'long' });
            const nextPayrollDay = nextPayrollDate.getDate();
            const nextPayrollYear = nextPayrollDate.getFullYear();
            
            // Update alert text
            document.getElementById('payrollAlert').innerHTML = `
                Payroll processing for <strong>${currentMonth} ${currentYear}</strong>. 
                Next payroll run scheduled for <strong>${nextPayrollMonth} ${nextPayrollDay}, ${nextPayrollYear}</strong>.
            `;
            
            // Set default payment date to today
            document.getElementById('paymentDate').valueAsDate = now;
            
            // Generate pay period options
            const payPeriodSelect = document.getElementById('payPeriodSelect');
            payPeriodSelect.innerHTML = '';
            
            // Add current month option
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            payPeriodSelect.add(new Option(
                `${firstDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${lastDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`,
                'current'
            ));
            
            // Add previous months options
            for (let i = 1; i <= 3; i++) {
                const prevMonth = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const prevLastDay = new Date(now.getYear(), now.getMonth() - i + 1, 0);
                payPeriodSelect.add(new Option(
                    `${prevMonth.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${prevLastDay.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`,
                    `prev-${i}`
                ));
            }
        }
        
        function generatePayslipPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current date and month
            const today = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
            const currentMonth = monthNames[today.getMonth()];
            const currentYear = today.getFullYear();
            
            // Get all employee data from the form
            const employeeName = document.getElementById('payrollEmployeeName').value;
            const employeeId = document.getElementById('payrollEmployeeId').value;
            const joiningDate = document.getElementById('payrollEmployeeJoiningDate').value || '18.04.2023';
            const designation = document.getElementById('payrollEmployeePosition').value;
            const department = document.getElementById('payrollEmployeeDept').value;
            const location = document.getElementById('payrollEmployeeLocation').value;
            const bankName = document.getElementById('payrollEmployeeBankName').value;
            const bankAccount = document.getElementById('payrollEmployeeBankAccount').value;
            const ifscCode = document.getElementById('payrollEmployeeIFSC').value;
            const pfId = document.getElementById('payrollEmployeePFID').value;
            const pfUan = document.getElementById('payrollEmployeePFUAN').value;
            
            // Get salary data
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const allowances = parseFloat(document.getElementById('allowances').value) || 0;
            const gross = parseFloat(document.getElementById('gross').value) || 0;
            const actualGross = parseFloat(document.getElementById('actualGross').value) || 0;
            const totalDays = document.getElementById('totalDays').value || '30';
            
            // Get deductions
            const absentDays = parseInt(document.getElementById('absentDays').value) || 0;
            const halfDay = parseInt(document.getElementById('halfDay').value) || 0;
            const pfDeduction = parseFloat(document.getElementById('pf').value) || 0;
            const ptDeduction = parseFloat(document.getElementById('pt').value) || 0;
            const tdsDeduction = parseFloat(document.getElementById('tds').value) || 0;
            const esiDeduction = parseFloat(document.getElementById('esi').value) || 0;
            const advanceDeduction = parseFloat(document.getElementById('advanceDeduction').value) || 0;
            
            // Calculate daily salary and absent deductions
            const dailySalary = actualGross / totalDays;
            const absentDeduction = absentDays * dailySalary;
            const halfDayDeduction = halfDay * (dailySalary / 2);
            
            // Calculate totals
            const totalEarnings = actualGross;
            const totalDeductions = absentDeduction + halfDayDeduction + pfDeduction + ptDeduction + tdsDeduction + esiDeduction + advanceDeduction;
            const netPay = totalEarnings - totalDeductions;
            
            // Set font styles for the entire document to match your sample
            doc.setFont('helvetica');
            doc.setFontSize(10);
            
            // Company header (exactly as in your sample)
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text("M/s. PYROGREEN ENERGY PVT. LTD", 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            // Split address into two lines as requested
            doc.text("Pyrogreen Energy Private Limited - FLAT NO 304, SAHITI SRI VIDHYA PETAL,", 105, 22, { align: 'center' });
            doc.text("Street No-1, Patrika Nagar, HITEC City, Hyderabad, Telangana 500081", 105, 27, { align: 'center' });
            
            // Payslip title
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`Payslip for the Month of ${currentMonth} ${currentYear}`, 105, 35, { align: 'center' });
            
            // Employee details table (matching your sample's style)
            let yPos = 45;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("Name:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(employeeName, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("Employee No:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(employeeId, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Joining Date:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(joiningDate, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("Bank Name:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(bankName, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Designation:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(designation, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("Bank Account No:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(bankAccount, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Department:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(department, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("IFSC Code:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(ifscCode, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Location:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(location, 40, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("PF ID:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(pfId, 160, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("Effective Work Days:", 20, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(totalDays, 60, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("PF UAN:", 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(pfUan, 160, yPos);
            yPos += 12;
            
            // Earnings and Deductions table (matching your sample's style)
            doc.setFont('helvetica', 'bold');
            doc.text("Earnings", 20, yPos);
            doc.text("Full", 70, yPos);
            doc.text("Actual", 100, yPos);
            doc.text("Deductions", 140, yPos);
            doc.text("Actual", 180, yPos);
            yPos += 7;
            
            // Horizontal line
            doc.line(20, yPos, 190, yPos);
            yPos += 5;
            
            // Basic Salary row
            doc.setFont('helvetica', 'normal');
            doc.text("BASIC", 20, yPos);
            doc.text(basicSalary.toFixed(2), 70, yPos);
            doc.text(basicSalary.toFixed(2), 100, yPos);
            doc.text("ABSENT DAYS", 140, yPos);
            doc.text(absentDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // HRA row
            doc.text("HRA", 20, yPos);
            doc.text("-", 70, yPos);
            doc.text("-", 100, yPos);
            doc.text("HALF DAY", 140, yPos);
            doc.text(halfDayDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Special Allowance row
            doc.text("SPECIAL ALLOWANCE", 20, yPos);
            doc.text(allowances.toFixed(2), 70, yPos);
            doc.text(allowances.toFixed(2), 100, yPos);
            doc.text("PF", 140, yPos);
            doc.text(pfDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("PROFESSION TAX", 140, yPos);
            doc.text(ptDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("TDS", 140, yPos);
            doc.text(tdsDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("ESI", 140, yPos);
            doc.text(esiDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Empty row
            doc.text("", 20, yPos);
            doc.text("", 70, yPos);
            doc.text("", 100, yPos);
            doc.text("SALARY ADVANCE", 140, yPos);
            doc.text(advanceDeduction.toFixed(2), 180, yPos);
            yPos += 7;
            
            // Totals row
            doc.setFont('helvetica', 'bold');
            doc.text("Total Earnings:INR.", 20, yPos);
            doc.text("", 70, yPos);
            doc.text(totalEarnings.toFixed(2), 100, yPos);
            doc.text("Total Deductions:INR.", 140, yPos);
            doc.text(totalDeductions.toFixed(2), 180, yPos);
            yPos += 12;
            
            // Net pay
            doc.setFont('helvetica', 'bold');
            doc.text(`Net Pay for the month (Total Earnings - Total Deductions): ${netPay.toFixed(2)}`, 20, yPos);
            yPos += 10;
            
            // Footer note (exactly as in your sample)
            doc.setFont('helvetica', 'italic');
            doc.text("This is a system generated payslip and does not require signature.", 105, yPos, { align: 'center' });
            
            // Save the PDF with employee name and month/year
            doc.save(`Payslip_${employeeName.replace(/\s+/g, '_')}_${currentMonth}_${currentYear}.pdf`);
        }

        // Populate employee dropdown in payroll section
        async function populatePayrollEmployeeDropdown() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- Select Employee --</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.id})`;
                select.appendChild(option);
            });
        }

        // Update payroll employee details when selected
        function updatePayrollEmployeeDetails(employee) {
            document.getElementById('payrollEmployeeId').value = employee.id;
            document.getElementById('payrollEmployeeName').value = employee.name;
            document.getElementById('payrollEmployeeEmail').value = employee.email || '';
            document.getElementById('payrollEmployeePhone').value = employee.phone || '';
            document.getElementById('payrollEmployeeDept').value = employee.department || '';
            document.getElementById('payrollEmployeePosition').value = employee.position || '';
            document.getElementById('payrollEmployeeLocation').value = employee.location || '';
            document.getElementById('payrollEmployeeBankName').value = employee.bankName || '';
            document.getElementById('payrollEmployeeBankAccount').value = employee.accountNo || '';
            document.getElementById('payrollEmployeeIFSC').value = employee.IFSCCode || '';
            document.getElementById('payrollEmployeePFID').value = employee.PFID || '';
            document.getElementById('payrollEmployeePFUAN').value = employee.PFUAN || '';
            
            // Format joining date
            const joinDate = employee.joinDate ? new Date(employee.joinDate) : new Date();
            document.getElementById('payrollEmployeeJoiningDate').value = joinDate.toLocaleDateString('en-GB');
            
            // Update salary fields
            document.getElementById('basicSalary').value = employee.salary || 0;
            document.getElementById('allowances').value = employee.allowances || 0;
            document.getElementById('gross').value = (employee.salary || 0) + (employee.allowances || 0);
            document.getElementById('actualGross').value = (employee.salary || 0) + (employee.allowances || 0);
            
            // Set total days based on current month
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            document.getElementById('totalDays').value = daysInMonth;
            
            // Update deductions
            document.getElementById('tds').value = '1500'; // Default TDS
            document.getElementById('pf').value = '1800'; // Default PF
            document.getElementById('esi').value = '500'; // Default ESI
            document.getElementById('pt').value = '200'; // Default PT
            document.getElementById('advanceDeduction').value = '0'; // Default advance
            
            // Update bank account display in summary
            document.querySelector('#salarySummarySection .form-control[placeholder="Account details"]').value = 
                `${employee.accountNo || 'XXXX-XXXX-XXXX'} (${employee.bankName || 'Bank'})`;
        }
        
        // Update attendance deductions based on selected employee and payroll period
        function updateAttendanceDeductions(employeeId) {
            const payPeriodSelect = document.getElementById('payPeriodSelect');
            const selectedPeriod = payPeriodSelect.value;
            
            // Initialize counters
            let absentDays = 0;
            let halfDays = 0;
            
            // Determine the month to check based on selected payroll period
            let targetMonth = '';
            const now = new Date();
            
            if (selectedPeriod === 'current') {
                targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            } else if (selectedPeriod.startsWith('prev-')) {
                const monthsBack = parseInt(selectedPeriod.split('-')[1]);
                const targetDate = new Date(now.getFullYear(), now.getMonth() - monthsBack, 1);
                targetMonth = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
            }
            
            // Check if we have monthly reports for the target month
            if (targetMonth && monthlyReports[targetMonth]) {
                // Loop through all dates in this month's report
                Object.keys(monthlyReports[targetMonth]).forEach(date => {
                    // Check if this employee has a record for this date
                    if (monthlyReports[targetMonth][date][employeeId]) {
                        const record = monthlyReports[targetMonth][date][employeeId];
                        
                        // Count absent days and half days
                        if (record.status === 'absent') absentDays++;
                        else if (record.status === 'halfday') halfDays++;
                    }
                });
            }
            
            // Update the form fields
            document.getElementById('absentDays').value = absentDays;
            document.getElementById('halfDay').value = halfDays % 2; // Only show unpaired half days
        }

        // Attendance Functions
        async function renderEmployeeAttendanceList() {
            const date = document.getElementById('attendance-date').value;
            const searchTerm = document.getElementById('employee-search').value.toLowerCase();
            
            // Initialize attendance records for the date if not exists
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
                localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            }
            
            // Filter employees based on search term
            const filteredEmployees = employees.filter(emp => 
                emp.id.toLowerCase().includes(searchTerm) ||
                emp.name.toLowerCase().includes(searchTerm) || 
                emp.department.toLowerCase().includes(searchTerm) ||
                (emp.phone && emp.phone.includes(searchTerm))
            );
            
            // Clear the table
            document.getElementById('attendance-list').innerHTML = '';
            
            // Add each employee to the table
            filteredEmployees.forEach(emp => {
                const record = attendanceRecords[date][emp.id] || {
                    status: 'absent',
                    time: ''
                };
                
                const row = document.createElement('tr');
                
                // Status class for styling
                let statusClass = '';
                if (record.status === 'present') statusClass = 'status-present';
                else if (record.status === 'absent') statusClass = 'status-absent';
                else if (record.status === 'late') statusClass = 'status-late';
                else if (record.status === 'leave') statusClass = 'status-leave';
                else if (record.status === 'halfday') statusClass = 'status-halfday';
                
                // Status display with time if applicable
                const statusDisplay = record.time 
                    ? `${record.status.toUpperCase()} <span class="late-time">(${record.time})</span>`
                    : record.status.toUpperCase();
                
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department}</td>
                    <td>${emp.phone || 'N/A'}</td>
                    <td class="${statusClass}">${statusDisplay}</td>
                    <td class="action-buttons">
                        <button class="btn btn-success" onclick="markAttendanceWithTime('${emp.id}', 'present')">
                            <i class="fas fa-check"></i> Present
                        </button>
                        <button class="btn btn-danger" onclick="toggleAttendance('${emp.id}', 'absent')">
                            <i class="fas fa-times"></i> Absent
                        </button>
                        <button class="btn btn-warning" onclick="markAttendanceWithTime('${emp.id}', 'late')">
                            <i class="fas fa-clock"></i> Late
                        </button>
                        <button class="btn btn-leave" onclick="toggleAttendance('${emp.id}', 'leave')">
                            <i class="fas fa-umbrella-beach"></i> Leave
                        </button>
                        <button class="btn btn-halfday" onclick="markAttendanceWithTime('${emp.id}', 'halfday')">
                            <i class="fas fa-adjust"></i> Half Day
                        </button>
                    </td>
                `;
                
                document.getElementById('attendance-list').appendChild(row);
            });
        }
        
        // Mark attendance with time input for present, late, and halfday statuses
        function markAttendanceWithTime(employeeId, status) {
            const date = document.getElementById('attendance-date').value;
            
            // Initialize date if not exists
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
            }
            
            // Initialize employee record if not exists
            if (!attendanceRecords[date][employeeId]) {
                attendanceRecords[date][employeeId] = {
                    status: 'absent',
                    time: ''
                };
            }
            
            const record = attendanceRecords[date][employeeId];
            
            // If already the same status, toggle to absent
            if (record.status === status) {
                record.status = 'absent';
                record.time = '';
            } else {
                const timeInput = prompt(`Enter time for ${status} (HH:MM AM/PM):`);
                if (timeInput !== null) { // User didn't click Cancel
                    // Validate time format (simple validation)
                    if (/^([0-1]?[0-9]|2[0-3]):[0-5][0-9] ?([APap][mM])?$/.test(timeInput)) {
                        record.status = status;
                        record.time = timeInput;
                    } else {
                        alert('Please enter time in HH:MM AM/PM format (e.g. 09:30 AM)');
                        return;
                    }
                } else {
                    return; // User cancelled, don't change status
                }
            }
            
            // Save to localStorage
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Refresh the list
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
        }
        
        // Toggle attendance status (for statuses without time)
        function toggleAttendance(employeeId, status) {
            const date = document.getElementById('attendance-date').value;
            
            // Initialize date if not exists
            if (!attendanceRecords[date]) {
                attendanceRecords[date] = {};
            }
            
            // Initialize employee record if not exists
            if (!attendanceRecords[date][employeeId]) {
                attendanceRecords[date][employeeId] = {
                    status: 'absent',
                    time: ''
                };
            }
            
            const record = attendanceRecords[date][employeeId];
            
            // Toggle status - if current status is same as clicked status, set to absent
            if (record.status === status) {
                record.status = 'absent';
            } else {
                record.status = status;
            }
            // Clear time for statuses that don't need it
            record.time = '';
            
            // Save to localStorage
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Refresh the list
            renderEmployeeAttendanceList();
            updateAttendanceSummary();
        }
        
        // Update attendance summary counters
        async function updateAttendanceSummary() {
            const date = document.getElementById('attendance-date').value;
            let present = 0;
            let absent = 0;
            let late = 0;
            let leave = 0;
            let halfday = 0;
            
            if (attendanceRecords[date]) {
                Object.values(attendanceRecords[date]).forEach(record => {
                    if (record.status === 'present') present++;
                    else if (record.status === 'absent') absent++;
                    else if (record.status === 'late') late++;
                    else if (record.status === 'leave') leave++;
                    else if (record.status === 'halfday') halfday++;
                });
            }
            
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
            document.getElementById('late-count').textContent = late;
            document.getElementById('leave-count').textContent = leave;
            document.getElementById('halfday-count').textContent = halfday;
            document.getElementById('total-count').textContent = employees.length;
        }
        
        // Update attendance save button state
        function updateAttendanceSaveButtonState() {
            const date = document.getElementById('attendance-date').value;
            const saveBtn = document.getElementById('save-attendance-btn');
            
            if (savedDays.includes(date)) {
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Attendance Saved';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-primary');
                saveBtn.disabled = true;
            } else {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Today\'s Attendance';
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-success');
                saveBtn.disabled = false;
            }
        }
        
        // Monthly Attendance Records Functions
        function openMonthlyRecords() {
            document.getElementById('monthly-records-modal').style.display = 'flex';
            loadMonthlyRecords();
        }
        
        function closeMonthlyRecords() {
            document.getElementById('monthly-records-modal').style.display = 'none';
        }
        
        function downloadMonthlyRecords() {
            const month = document.getElementById('month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Prepare data for Excel
            const data = [];
            
            // Add header row
            data.push([
                'Date', 'Employee ID', 'Name', 'Department', 'Phone',
                'Status', 'Time', 'Saved'
            ]);
            
            // Add data rows
            Object.keys(attendanceRecords).forEach(date => {
                if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    Object.keys(attendanceRecords[date]).forEach(empId => {
                        const record = attendanceRecords[date][empId];
                        const employee = employees.find(emp => emp.id === empId) || { 
                            name: 'Unknown', 
                            department: '',
                            phone: 'N/A'
                        };
                        
                        data.push([
                            date,
                            empId,
                            employee.name,
                            employee.department,
                            employee.phone || 'N/A',
                            record.status.toUpperCase(),
                            record.time || '--:--',
                            savedDays.includes(date) ? 'Yes' : 'No'
                        ]);
                    });
                }
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Records");
            
            // Generate file name
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            const fileName = `Attendance_Records_${monthName}_${year}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, fileName);
        }
        
        function loadMonthlyRecords() {
            const month = document.getElementById('month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Filter records for the selected month
            const monthRecords = {};
            Object.keys(attendanceRecords).forEach(date => {
                if (date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    monthRecords[date] = attendanceRecords[date];
                }
            });
            
            // Generate HTML for the monthly report
            let html = '<div style="margin-bottom: 30px;">';
            
            // Summary for the month
            let totalDays = 0;
            let totalPresent = 0;
            let totalAbsent = 0;
            let totalLate = 0;
            let totalLeave = 0;
            let totalHalfday = 0;
            let totalSavedDays = 0;
            
            Object.keys(monthRecords).forEach(date => {
                totalDays++;
                if (savedDays.includes(date)) totalSavedDays++;
                Object.values(monthRecords[date]).forEach(record => {
                    if (record.status === 'present') totalPresent++;
                    else if (record.status === 'absent') totalAbsent++;
                    else if (record.status === 'late') totalLate++;
                    else if (record.status === 'leave') totalLeave++;
                    else if (record.status === 'halfday') totalHalfday++;
                });
            });
            
            html += `
                <h3>Monthly Summary</h3>
                <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalDays}</div>
                        <div>Days Recorded</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalSavedDays}</div>
                        <div>Days Saved</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalPresent}</div>
                        <div>Present Markings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalAbsent}</div>
                        <div>Absent Markings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalLate}</div>
                        <div>Late Markings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalLeave}</div>
                        <div>Paid Leaves</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 18px; font-weight: bold;">${totalHalfday}</div>
                        <div>Half Days</div>
                    </div>
                </div>
            `;
            
            // Detailed records by date
            html += '<h3>Daily Records</h3>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 800px;">';
            html += `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Saved</th>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // Sort dates in descending order
            const sortedDates = Object.keys(monthRecords).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const isSaved = savedDays.includes(date);
                
                Object.keys(monthRecords[date]).forEach(empId => {
                    const record = monthRecords[date][empId];
                    const employee = employees.find(emp => emp.id === empId) || { name: 'Unknown', id: empId, department: '', phone: 'N/A' };
                    
                    let statusClass = '';
                    if (record.status === 'present') statusClass = 'status-present';
                    else if (record.status === 'absent') statusClass = 'status-absent';
                    else if (record.status === 'late') statusClass = 'status-late';
                    else if (record.status === 'leave') statusClass = 'status-leave';
                    else if (record.status === 'halfday') statusClass = 'status-halfday';
                    
                    const statusDisplay = record.time 
                        ? `${record.status.toUpperCase()} <span class="late-time">(${record.time})</span>`
                        : record.status.toUpperCase();
                    
                    html += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>${isSaved ? 'âœ“' : ''}</td>
                            <td>${employee.id}</td>
                            <td>${employee.name}</td>
                            <td>${employee.department}</td>
                            <td>${employee.phone || 'N/A'}</td>
                            <td class="${statusClass}">${statusDisplay}</td>
                            <td>${record.time || '--:--'}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="viewEmployeeDetails('${empId}', '${month}')">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
            
            html += '</tbody></table></div>';
            document.getElementById('monthly-records-container').innerHTML = html;
            
            // Save this monthly view for potential export
            monthlyReports[month] = monthRecords;
            localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
        }
        
        function clearCurrentMonthRecords() {
            if (!confirm('Are you sure you want to clear all attendance records for this month? This cannot be undone.')) {
                return;
            }
            
            const month = document.getElementById('month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Filter out records for the selected month
            const newAttendanceRecords = {};
            Object.keys(attendanceRecords).forEach(date => {
                if (!date.startsWith(`${year}-${monthNum.padStart(2, '0')}`)) {
                    newAttendanceRecords[date] = attendanceRecords[date];
                }
            });
            
            attendanceRecords = newAttendanceRecords;
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Also remove from monthly reports and saved days
            delete monthlyReports[month];
            localStorage.setItem('monthlyReports', JSON.stringify(monthlyReports));
            
            savedDays = savedDays.filter(date => !date.startsWith(`${year}-${monthNum.padStart(2, '0')}`));
            localStorage.setItem('savedDays', JSON.stringify(savedDays));
            
            // Sync with Firebase
            pushAttendanceToFirebase();
            
            alert('Records cleared for this month!');
            loadMonthlyRecords();
        }

        // Employee Details Functions
        function viewEmployeeDetails(employeeId, monthFilter = '') {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) {
                alert('Employee not found!');
                return;
            }
            
            // Set employee details
            document.getElementById('detail-employee-id').value = employee.id;
            document.getElementById('detail-employee-name').value = employee.name;
            document.getElementById('detail-employee-dept').value = employee.department;
            document.getElementById('detail-employee-position').value = employee.position;
            
            // Set default month filter to current month if not provided
            if (!monthFilter) {
                const today = new Date();
                monthFilter = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            }
            document.getElementById('detail-month-select').value = monthFilter;
            
            // Filter records by month
            filterEmployeeDetailsByMonth();
            
            // Show the modal
            document.getElementById('employee-details-modal').style.display = 'flex';
        }
        
        function filterEmployeeDetailsByMonth() {
            const employeeId = document.getElementById('detail-employee-id').value;
            const month = document.getElementById('detail-month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Initialize counters for the selected month
            let presentDays = 0;
            let absentDays = 0;
            let lateDays = 0;
            let leaveDays = 0;
            let halfdayDays = 0;
            
            // Prepare attendance records for display
            let recordsHtml = '';
            
            // Get all dates in the selected month that have attendance records
            const monthDates = Object.keys(attendanceRecords)
                .filter(date => date.startsWith(`${year}-${monthNum.padStart(2, '0')}`))
                .sort((a, b) => new Date(a) - new Date(b));
            
            // Loop through each date in the month
            monthDates.forEach(date => {
                if (attendanceRecords[date][employeeId]) {
                    const record = attendanceRecords[date][employeeId];
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        weekday: 'short'
                    });
                    
                    // Count status types
                    if (record.status === 'present') presentDays++;
                    else if (record.status === 'absent') absentDays++;
                    else if (record.status === 'late') lateDays++;
                    else if (record.status === 'leave') leaveDays++;
                    else if (record.status === 'halfday') halfdayDays++;
                    
                    // Add to records table
                    let statusClass = '';
                    if (record.status === 'present') statusClass = 'status-present';
                    else if (record.status === 'absent') statusClass = 'status-absent';
                    else if (record.status === 'late') statusClass = 'status-late';
                    else if (record.status === 'leave') statusClass = 'status-leave';
                    else if (record.status === 'halfday') statusClass = 'status-halfday';
                    
                    const statusDisplay = record.time 
                        ? `${record.status.toUpperCase()} (${record.time})`
                        : record.status.toUpperCase();
                    
                    recordsHtml += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td class="${statusClass}">${statusDisplay}</td>
                        </tr>
                    `;
                }
            });
            
            // Calculate totals based on rules
            const halfdayPairs = Math.floor(halfdayDays / 2);
            const halfdayLeft = halfdayDays % 2;
            
            const totalPresent = presentDays + lateDays + leaveDays + halfdayPairs;
            const totalAbsent = absentDays + halfdayPairs;
            
            // Update display
            document.getElementById('detail-present-days').textContent = presentDays;
            document.getElementById('detail-absent-days').textContent = absentDays;
            document.getElementById('detail-late-days').textContent = lateDays;
            document.getElementById('detail-leave-days').textContent = leaveDays;
            document.getElementById('detail-halfday-days').textContent = halfdayDays;
            
            document.getElementById('detail-total-present').textContent = totalPresent;
            document.getElementById('detail-total-absent').textContent = totalAbsent;
            document.getElementById('detail-halfday-left').textContent = halfdayLeft > 0 ? halfdayLeft : 'Null';
            
            document.getElementById('detail-attendance-records').innerHTML = recordsHtml;
        }
        
        function editEmployeeAttendance() {
            const employeeId = document.getElementById('detail-employee-id').value;
            const month = document.getElementById('detail-month-select').value;
            
            // Close the details modal
            closeEmployeeDetails();
            
            // Set the attendance date to the first day of the selected month
            const [year, monthNum] = month.split('-');
            const firstDayOfMonth = `${year}-${monthNum}-01`;
            document.getElementById('attendance-date').value = firstDayOfMonth;
            
            // Show the attendance section
            showSection('attendance');
            
            // Scroll to the attendance section
            setTimeout(() => {
                document.getElementById('attendance').scrollIntoView({ behavior: 'smooth' });
                
                // Focus on the search field and filter by employee ID
                document.getElementById('employee-search').value = employeeId;
                renderEmployeeAttendanceList();
                
                // Show a message to the user
                alert(`Now editing attendance for ${employeeId}. Please navigate through dates using the date picker.`);
            }, 100);
        }
        
        function closeEmployeeDetails() {
            document.getElementById('employee-details-modal').style.display = 'none';
        }
        
        function downloadEmployeeDetails() {
            const employeeId = document.getElementById('detail-employee-id').value;
            const employeeName = document.getElementById('detail-employee-name').value;
            const month = document.getElementById('detail-month-select').value;
            const [year, monthNum] = month.split('-');
            
            // Prepare data for Excel
            const data = [];
            
            // Add header row
            data.push([
                'Date', 'Status', 'Time'
            ]);
            
            // Add data rows from the filtered records
            const rows = document.querySelectorAll('#detail-attendance-records tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                data.push([
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[1].querySelector('.late-time') ? cells[1].querySelector('.late-time').textContent.replace(/[()]/g, '') : ''
                ]);
            });
            
            // Add summary data
            data.push([]); // Empty row
            data.push(['Summary', '']);
            data.push(['Present Days', document.getElementById('detail-present-days').textContent]);
            data.push(['Absent Days', document.getElementById('detail-absent-days').textContent]);
            data.push(['Late Arrivals', document.getElementById('detail-late-days').textContent]);
            data.push(['Paid Leaves', document.getElementById('detail-leave-days').textContent]);
            data.push(['Half Days', document.getElementById('detail-halfday-days').textContent]);
            data.push(['Total Days Present', document.getElementById('detail-total-present').textContent]);
            data.push(['Total Days Absent', document.getElementById('detail-total-absent').textContent]);
            data.push(['Half Days Left', document.getElementById('detail-halfday-left').textContent]);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Details");
            
            // Generate file name
            const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
            const fileName = `Attendance_Details_${employeeName.replace(/\s+/g, '_')}_${monthName}_${year}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, fileName);
        }

        // Make functions available globally
        window.editEmployee = editEmployee;
        window.deleteEmployee = deleteEmployee;
        window.showSection = showSection;
        window.toggleAttendance = toggleAttendance;
        window.markAttendanceWithTime = markAttendanceWithTime;
        window.openMonthlyRecords = openMonthlyRecords;
        window.closeMonthlyRecords = closeMonthlyRecords;
        window.downloadMonthlyRecords = downloadMonthlyRecords;
        window.clearCurrentMonthRecords = clearCurrentMonthRecords;
        window.viewEmployeeDetails = viewEmployeeDetails;
        window.closeEmployeeDetails = closeEmployeeDetails;
        window.downloadEmployeeDetails = downloadEmployeeDetails;
        window.editEmployeeAttendance = editEmployeeAttendance;
        window.filterEmployeeDetailsByMonth = filterEmployeeDetailsByMonth;
    </script>

<script type="module">
/* Firebase modular SDK imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  getDocs,
  setDoc,
  deleteDoc,
  writeBatch,
  serverTimestamp,
  query,
  where,
  getDoc,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Your Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyB2-yGvsn2Y9_0FBSIxnC50GTNo-3OeFew",
  authDomain: "testpayroll-60439.firebaseapp.com",
  projectId: "testpayroll-60439",
  storageBucket: "testpayroll-60439.appspot.com",
  messagingSenderId: "240505247731",
  appId: "1:240505247731:web:6844674a44973506d2bf3c"
};

/* Initialize Firebase */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Persist auth */
await setPersistence(auth, browserLocalPersistence).catch(e => console.warn('setPersistence', e));

/* Toast notifications */
function _toast(msg, type='info') {
  try {
    const id = 'ww_toast_container';
    let c = document.getElementById(id);
    if (!c) { c = document.createElement('div'); c.id = id; c.style.position='fixed'; c.style.right='18px'; c.style.top='18px'; c.style.zIndex=9999; document.body.appendChild(c); }
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.marginTop = '8px'; el.style.padding = '8px 12px'; el.style.borderRadius = '8px'; el.style.color = '#fff';
    el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';
    el.style.background = type === 'error' ? '#ef4444' : (type === 'success' ? '#10b981' : '#2563eb');
    c.appendChild(el);
    setTimeout(()=>{ el.style.opacity = '0'; setTimeout(()=>el.remove(),300); }, 3000);
  } catch(e) { console.log('toast error', e); }
}

function _showLoading(show=true) {
  try {
    const id = 'ww_loading_overlay';
    let o = document.getElementById(id);
    if (!o) {
      o = document.createElement('div'); o.id = id;
      Object.assign(o.style, {position:'fixed',left:0,top:0,width:'100%',height:'100%',display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(255,255,255,0.6)',zIndex:9998});
      o.innerHTML = '<div style="padding:12px;border-radius:8px;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,0.08);font-weight:600;">Working...</div>';
      document.body.appendChild(o);
    }
    o.style.display = show ? 'flex' : 'none';
  } catch(e) { console.log(e); }
}

/* Live sync with USER-SCOPED collections */
let _empUnsub = null;
let _attUnsub = null;
window._employees_cache = [];
window._attendance_cache = {};

async function startLiveSyncEmployees(uid) {
  try {
    if (_empUnsub) { _empUnsub(); _empUnsub = null; }
    const q = query(collection(db, 'users', uid, 'employees'), orderBy('updatedAt'));
    _empUnsub = onSnapshot(q, snapshot => {
      const arr = [];
      snapshot.forEach(d => arr.push({ id: d.id, ...d.data() }));
      window._employees_cache = arr;
      try { if (typeof renderEmployeeTable === 'function') renderEmployeeTable(); } catch(e) { console.error('renderEmployeeTable', e); }
      try { if (typeof populatePayrollEmployeeDropdown === 'function') populatePayrollEmployeeDropdown(); } catch(e) {}
    }, err => {
      console.error('employees onSnapshot', err);
    });
  } catch(e) { console.error('startLiveSyncEmployees', e); }
}

async function startLiveSyncAttendance(uid) {
  try {
    if (_attUnsub) { _attUnsub(); _attUnsub = null; }
    const q = query(collection(db, 'users', uid, 'attendance'), orderBy('date'));
    _attUnsub = onSnapshot(q, snapshot => {
      const map = {};
      snapshot.forEach(d => map[d.id] = d.data());
      window._attendance_cache = map;
      try { if (typeof renderEmployeeAttendanceList === 'function') renderEmployeeAttendanceList(); } catch(e) { console.error('renderEmployeeAttendanceList', e); }
      try { if (typeof updateAttendanceSummary === 'function') updateAttendanceSummary(); } catch(e) {}
    }, err => {
      console.error('attendance onSnapshot', err);
    });
  } catch(e) { console.error('startLiveSyncAttendance', e); }
}

/* Save employee */
async function saveEmployeeToFirestore(employeeData) {
  const user = auth.currentUser;
  if (!user) { _toast('Login required','error'); return; }
  _showLoading(true);
  try {
    const id = employeeData.id || ('EMP' + Math.random().toString(36).slice(2,9).toUpperCase());
    await setDoc(doc(db, 'users', user.uid, 'employees', id), { ...employeeData, updatedAt: serverTimestamp() });
    _toast('Employee saved','success');
  } catch(e) { console.error('saveEmployeeToFirestore', e); _toast('Save failed','error'); }
  finally { _showLoading(false); }
}

/* Delete employee */
async function deleteEmployeeFromFirestore(id) {
  const user = auth.currentUser;
  if (!user) { _toast('Login required','error'); return; }
  _showLoading(true);
  try {
    await deleteDoc(doc(db, 'users', user.uid, 'employees', id));
    _toast('Employee deleted','success');
  } catch(e) { console.error('deleteEmployeeFromFirestore', e); _toast('Delete failed','error'); }
  finally { _showLoading(false); }
}

/* Save attendance */
async function saveSingleAttendanceDate(date, recordObj) {
  const user = auth.currentUser;
  if (!user) { _toast('Login required','error'); return; }
  _showLoading(true);
  try {
    await setDoc(doc(db, 'users', user.uid, 'attendance', date), { ...recordObj, date, updatedAt: serverTimestamp() });
    window._attendance_cache[date] = recordObj;
    _toast('Attendance saved for ' + date, 'success');
  } catch(e) { console.error('saveSingleAttendanceDate', e); _toast('Save failed','error'); }
  finally { _showLoading(false); }
}

/* Push all attendance */
async function pushAttendanceToFirebase() {
  const user = auth.currentUser;
  if (!user) { _toast('Login required','error'); return; }
  _showLoading(true);
  try {
    const batch = writeBatch(db);
    const existing = await getDocs(collection(db, 'users', user.uid, 'attendance'));
    existing.forEach(s => batch.delete(doc(db, 'users', user.uid, 'attendance', s.id)));
    Object.keys(window.attendanceRecords || {}).forEach(date => {
      batch.set(doc(db, 'users', user.uid, 'attendance', date), { ...window.attendanceRecords[date], date, updatedAt: serverTimestamp() });
    });
    await batch.commit();
    _toast('Attendance pushed','success');
  } catch(e) { console.error('pushAttendanceToFirebase', e); _toast('Push failed','error'); }
  finally { _showLoading(false); }
}

/* Expose functions */
window.saveEmployeeToFirestore = saveEmployeeToFirestore;
window.deleteEmployeeFromFirestore = deleteEmployeeFromFirestore;
window.saveSingleAttendanceDate = saveSingleAttendanceDate;
window.pushAttendanceToFirebase = pushAttendanceToFirebase;

/* Start sync on auth change */
onAuthStateChanged(auth, (user) => {
  if (user) {
    console.log('ðŸ”¥ Firebase initialized successfully');
    try { startLiveSyncEmployees(user.uid); } catch(e) { console.error('sync employees', e); }
    try { startLiveSyncAttendance(user.uid); } catch(e) { console.error('sync attendance', e); }
  } else {
    if (_empUnsub) { _empUnsub(); _empUnsub = null; }
    if (_attUnsub) { _attUnsub(); _attUnsub = null; }
    window._employees_cache = [];
    window._attendance_cache = {};
  }
});
</script>
</body>
</html>
